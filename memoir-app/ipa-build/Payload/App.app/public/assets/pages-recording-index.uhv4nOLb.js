import{A as e,q as o,n as t,c as i,w as s,g as n,r,y as a,x as c,H as l,v as d,J as h,u,K as g,D as p,L as m,i as w,o as f,a as b,e as R,d as y,t as k,k as S,F as T,l as v,B as A,G as C,m as P,b as x}from"./index-DQU_JAH0.js";import{a as M}from"./apiConfig.BpiTqs15.js";import{_ as W,a as I,b as _,c as E}from"./check.CZEXAOrB.js";import{_ as D}from"./_plugin-vue_export-helper.BCo6x5W8.js";function B(i){var s;if(401===i.statusCode){const n=null==(s=i.data)?void 0:s.code;if("AUTH_FAILED"===n||"NO_TOKEN"===n||"USER_NOT_FOUND"===n)return e("token"),e("user"),e("customCharacterName"),o({title:"ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•",icon:"none",duration:2e3}),setTimeout(()=>{t({url:"/pages/login/index"})},2e3),!0}return!1}const N=D({data:()=>({chapterId:"",chapterTitle:"",contentText:"",isRecording:!1,isProcessing:!1,recordingTime:0,recordings:[],recordingTimer:null,realtimeRecognitionTimer:null,statusMonitorTimer:null,speechRecognition:null,lastRecognizedFile:null,prompts:[],mediaRecorder:null,mediaStream:null,audioChunks:[],audioQueue:[],audioProcessingPromise:Promise.resolve(),pcmSampleRate:16e3,useAudioProcessorStreaming:!1,allowAudioStreaming:!1,websocket:null,audioProcessor:null,audioContext:null,audioSourceNode:null,websocketKeepAliveTimer:null,decodeAudioContext:null,currentToken:null,currentApiKey:null,speechProvider:"aliyun",currentSpeechConfig:null,baiduAppId:null,baiduApiKey:null,baiduDevPid:15372,baiduCuid:null,aliyunAppKey:null,aliyunRegion:null,aliyunWsUrl:null,aliyunTaskId:null,lastPartialText:"",isAiCompleting:!1,showAiDiff:!1,originalText:"",aiCompletedText:""}),computed:{recordButtonText(){return this.isProcessing?"å¤„ç†ä¸­...":this.isRecording?"ç»“æŸå½•åˆ¶":"ç‚¹å‡»å½•åˆ¶"},currentDate(){const e=new Date;return`${e.getFullYear()}å¹´${e.getMonth()+1}æœˆ${e.getDate()}æ—¥`}},onLoad(e){this.chapterId=e.chapterId||"",this.chapterTitle=decodeURIComponent(e.title||"ç« èŠ‚å½•åˆ¶"),this.loadChapterPrompts(),this.loadSavedContent()},onUnload(){this.recordingTimer&&clearInterval(this.recordingTimer),this.realtimeRecognitionTimer&&clearInterval(this.realtimeRecognitionTimer),this.statusMonitorTimer&&clearInterval(this.statusMonitorTimer),this.speechRecognition&&this.speechRecognition.stop(),this.stopStatusMonitoring()},mounted(){this.loadChapterData(),this.checkRecordingSupport()},methods:{checkRecordingSupport(){var e;console.log("=== å½•éŸ³æ”¯æŒæ£€æŸ¥ ==="),console.log("navigatorå­˜åœ¨:","undefined"!=typeof navigator),console.log("mediaDeviceså­˜åœ¨:",void 0!==(null==navigator?void 0:navigator.mediaDevices)),console.log("getUserMediaå­˜åœ¨:",void 0!==(null==(e=null==navigator?void 0:navigator.mediaDevices)?void 0:e.getUserMedia)),console.log("MediaRecorderå­˜åœ¨:","undefined"!=typeof MediaRecorder),"undefined"!=typeof MediaRecorder&&(console.log("æ”¯æŒçš„MIMEç±»å‹:"),console.log("audio/webm:",MediaRecorder.isTypeSupported("audio/webm")),console.log("audio/webm;codecs=opus:",MediaRecorder.isTypeSupported("audio/webm;codecs=opus")),console.log("audio/mp4:",MediaRecorder.isTypeSupported("audio/mp4"))),console.log("uniå­˜åœ¨:","undefined"!=typeof uni),console.log("uni.startRecordå­˜åœ¨:",void 0!==(null==uni?void 0:uni.startRecord)),console.log("==================")},loadChapterData(){const e=m();if(e.length>0){const o=e[e.length-1].options||{};this.chapterId=o.chapterId||"",this.chapterTitle=o.title||"",console.log("åŠ è½½ç« èŠ‚æ•°æ®:",this.chapterId,this.chapterTitle),this.loadChapterPrompts(),this.loadSavedContent()}},goBack(){this.saveChapter(),p()},onTextInput(e){this.contentText=e.detail.value||e.target.value||"",this.lastPartialText=""},loadChapterPrompts(){this.prompts={background:["æ‚¨å‡ºç”Ÿåœ¨å“ªé‡Œï¼Ÿé‚£æ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„åœ°æ–¹ï¼Ÿ","æ‚¨çš„çˆ¶æ¯æ˜¯åšä»€ä¹ˆå·¥ä½œçš„ï¼Ÿ","å®¶é‡Œæœ‰å“ªäº›äº²äººï¼Ÿä»–ä»¬å„è‡ªæœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ"],childhood:["æ‚¨æœ€éš¾å¿˜çš„ç«¥å¹´è®°å¿†æ˜¯ä»€ä¹ˆï¼Ÿ","å°æ—¶å€™æœ€å–œæ¬¢ç©ä»€ä¹ˆæ¸¸æˆï¼Ÿ","æœ‰æ²¡æœ‰ç‰¹åˆ«è¦å¥½çš„ç«¥å¹´ä¼™ä¼´ï¼Ÿ"],education:["æ‚¨çš„æ±‚å­¦ç»å†æ˜¯æ€æ ·çš„ï¼Ÿ","æœ‰æ²¡æœ‰å¯¹æ‚¨å½±å“æ·±åˆ»çš„è€å¸ˆï¼Ÿ","å­¦ç”Ÿæ—¶ä»£æœ€éš¾å¿˜çš„ç»å†æ˜¯ä»€ä¹ˆï¼Ÿ"],career:["æ‚¨çš„ç¬¬ä¸€ä»½å·¥ä½œæ˜¯ä»€ä¹ˆï¼Ÿ","èŒä¸šç”Ÿæ¶¯ä¸­æœ€å¤§çš„æˆå°±æ˜¯ä»€ä¹ˆï¼Ÿ","å·¥ä½œä¸­é‡åˆ°è¿‡ä»€ä¹ˆæŒ‘æˆ˜ï¼Ÿ"],love:["æ‚¨æ˜¯å¦‚ä½•é‡åˆ°å¦ä¸€åŠçš„ï¼Ÿ","å°è±¡æœ€æ·±åˆ»çš„çº¦ä¼šç»å†æ˜¯ä»€ä¹ˆï¼Ÿ","å©šç¤¼æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"],family:["æˆä¸ºçˆ¶æ¯åçš„æ„Ÿå—å¦‚ä½•ï¼Ÿ","å­©å­ç»™æ‚¨å¸¦æ¥äº†ä»€ä¹ˆå˜åŒ–ï¼Ÿ","å®¶åº­ç”Ÿæ´»ä¸­æœ€æ¸©é¦¨çš„æ—¶åˆ»æ˜¯ä»€ä¹ˆï¼Ÿ"],travel:["æ‚¨å»è¿‡å“ªäº›åœ°æ–¹æ—…è¡Œï¼Ÿ","æœ€éš¾å¿˜çš„æ—…è¡Œç»å†æ˜¯ä»€ä¹ˆï¼Ÿ","æ—…è¡Œä¸­é‡åˆ°è¿‡ä»€ä¹ˆæœ‰è¶£çš„äººæˆ–äº‹ï¼Ÿ"],relationships:["æ‚¨ç”Ÿå‘½ä¸­æœ€é‡è¦çš„æœ‹å‹æ˜¯è°ï¼Ÿ","æœ‰æ²¡æœ‰æ”¹å˜æ‚¨äººç”Ÿè½¨è¿¹çš„é‡è¦é‡è§ï¼Ÿ","æ‚¨å¦‚ä½•ç»´ç³»é•¿ä¹…çš„å‹è°Šï¼Ÿ"],laterlife:["é€€ä¼‘åçš„ç”Ÿæ´»æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ","æ™šå¹´æœ€å¤§çš„å¿«ä¹æ¥æºæ˜¯ä»€ä¹ˆï¼Ÿ","å¯¹äºè¡°è€æ‚¨æœ‰ä»€ä¹ˆæ„Ÿå—ï¼Ÿ"],wisdom:["äººç”Ÿä¸­æœ€é‡è¦çš„æ„Ÿæ‚Ÿæ˜¯ä»€ä¹ˆï¼Ÿ","å¦‚æœé‡æ–°æ¥è¿‡ï¼Œæ‚¨ä¼šåšå‡ºä¸åŒçš„é€‰æ‹©å—ï¼Ÿ","æ‚¨å¸Œæœ›ç»™å¹´è½»äººä»€ä¹ˆå»ºè®®ï¼Ÿ"]}[this.chapterId]||[]},loadSavedContent(){try{const e=n("user"),o=null==e?void 0:e.id;if(!o)return;const t=n(`chapter_${this.chapterId}_${o}`);if(t){const e=JSON.parse(t);this.contentText=e.text||"",this.recordings=e.recordings||[]}}catch(e){console.log("åŠ è½½ä¿å­˜å†…å®¹å¤±è´¥:",e)}},async saveChapter(){var e;try{const t=n("token");if(!t)return void o({title:"è¯·å…ˆç™»å½•",icon:"error"});d({title:"ä¿å­˜ä¸­..."});const i={chapterId:this.chapterId,title:this.chapterTitle,content:this.contentText,recordings:this.recordings},s=await r({url:M("/chapters/save"),method:"POST",header:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},data:i});if(c(),B(s))return;if(200!==s.statusCode||!s.data.success)throw new Error((null==(e=s.data)?void 0:e.message)||"ä¿å­˜å¤±è´¥");{const e=n("user"),t=null==e?void 0:e.id;if(t){const e={text:this.contentText,recordings:this.recordings,lastModified:(new Date).toISOString(),completed:this.contentText.length>0||this.recordings.length>0};u(`chapter_${this.chapterId}_${t}`,JSON.stringify(e));const o=n(`chapter_status_${t}`)||"{}",i=JSON.parse(o);i[this.chapterId]={completed:e.completed,lastModified:e.lastModified},u(`chapter_status_${t}`,JSON.stringify(i))}o({title:"ä¿å­˜æˆåŠŸ",icon:"success"}),setTimeout(()=>{p()},1500)}}catch(t){if(c(),console.error("ä¿å­˜ç« èŠ‚å¤±è´¥:",t),t.errMsg&&t.errMsg.includes("network"))try{const e=n("user"),t=null==e?void 0:e.id;if(t){const e={text:this.contentText,recordings:this.recordings,lastModified:(new Date).toISOString(),completed:this.contentText.length>0||this.recordings.length>0,needSync:!0};u(`chapter_${this.chapterId}_${t}`,JSON.stringify(e)),o({title:"å·²ç¦»çº¿ä¿å­˜",icon:"success"}),setTimeout(()=>{p()},1500)}}catch(i){o({title:"ä¿å­˜å¤±è´¥",icon:"error"})}else o({title:t.message||"ä¿å­˜å¤±è´¥",icon:"error"})}},toggleRecording(){console.log("ğŸ¯ ç‚¹å‡»å½•åˆ¶æŒ‰é’®ï¼Œå½“å‰çŠ¶æ€:",this.isRecording),console.log("ğŸ¯ å¤„ç†çŠ¶æ€:",this.isProcessing),console.log("ğŸ¯ æŒ‰é’®æ–‡å­—:",this.recordButtonText),this.isRecording?(console.log("ğŸ›‘ åœæ­¢å½•éŸ³"),this.stopRecording()):(console.log("ğŸ¤ å¼€å§‹å½•éŸ³"),this.startRecording())},checkRecordingPermission:async()=>new Promise((e,o)=>{window.Capacitor?window.Capacitor.Plugins.Permissions?window.Capacitor.Plugins.Permissions.check({name:"microphone"}).then(t=>{"granted"===t.state?e():window.Capacitor.Plugins.Permissions.request({name:"microphone"}).then(t=>{"granted"===t.state?e():o(new Error("å½•éŸ³æƒé™è¢«æ‹’ç»"))}).catch(o)}).catch(o):e():navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({audio:!0}).then(o=>{o.getTracks().forEach(e=>e.stop()),e()}).catch(o):o(new Error("å½“å‰ç¯å¢ƒä¸æ”¯æŒå½•éŸ³"))}),startStatusMonitoring(){console.log("ğŸ” å¼€å§‹ç›‘æ§MediaRecorderçŠ¶æ€..."),this.statusMonitorTimer=setInterval(()=>{if(this.mediaRecorder&&(console.log("ğŸ“Š MediaRecorderçŠ¶æ€:",this.mediaRecorder.state),console.log("ğŸ“Š å½•éŸ³çŠ¶æ€:",this.isRecording),console.log("ğŸ“Š å¤„ç†çŠ¶æ€:",this.isProcessing),"inactive"===this.mediaRecorder.state&&this.isRecording)){console.warn("âš ï¸ MediaRecorderæ„å¤–åœæ­¢ï¼Œå°è¯•é‡æ–°å¯åŠ¨...");try{this.mediaRecorder.start(),console.log("âœ… MediaRecorderé‡æ–°å¯åŠ¨æˆåŠŸ")}catch(e){console.error("âŒ MediaRecorderé‡æ–°å¯åŠ¨å¤±è´¥:",e),this.handleRecordingError("å½•éŸ³æ„å¤–åœæ­¢")}}},2e3)},stopStatusMonitoring(){this.statusMonitorTimer&&(clearInterval(this.statusMonitorTimer),this.statusMonitorTimer=null,console.log("ğŸ” åœæ­¢çŠ¶æ€ç›‘æ§"))},async startRecording(e){var t;if(console.log("ğŸš€ startRecording è¢«è°ƒç”¨"),console.log("ğŸš€ å½“å‰ isProcessing:",this.isProcessing),console.log("ğŸš€ å½“å‰ isRecording:",this.isRecording),this.isProcessing)console.log("âš ï¸ æ­£åœ¨å¤„ç†ä¸­ï¼Œè·³è¿‡å½•éŸ³");else{e&&(e.preventDefault(),e.stopPropagation());try{console.log("ğŸ” å¼€å§‹æ£€æŸ¥å½•éŸ³æƒé™..."),await this.checkRecordingPermission(),console.log("âœ… å½•éŸ³æƒé™æ£€æŸ¥é€šè¿‡")}catch(i){return console.error("âŒ å½•éŸ³æƒé™æ£€æŸ¥å¤±è´¥:",i),void o({title:"éœ€è¦å½•éŸ³æƒé™æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½",icon:"error"})}console.log("ğŸ“ è®¾ç½®å½•éŸ³çŠ¶æ€ä¸º true"),this.isRecording=!0,this.recordingTime=0,console.log("ğŸ“ å½•éŸ³çŠ¶æ€å·²è®¾ç½®:",this.isRecording),this.allowAudioStreaming=!0,this.lastPartialText="",this.audioQueue=[],this.audioProcessingPromise=Promise.resolve(),this.recordingTimer=setInterval(()=>{this.recordingTime++},1e3),console.log("ğŸ¤ å¼€å§‹å½•éŸ³..."),console.log("è¿è¡Œç¯å¢ƒ:",g().platform),console.log("ğŸ” æ£€æŸ¥å½•éŸ³ç¯å¢ƒæ”¯æŒ..."),console.log("ğŸ” navigatorå­˜åœ¨:","undefined"!=typeof navigator),console.log("ğŸ” mediaDeviceså­˜åœ¨:",void 0!==(null==navigator?void 0:navigator.mediaDevices)),console.log("ğŸ” getUserMediaå­˜åœ¨:",void 0!==(null==(t=null==navigator?void 0:navigator.mediaDevices)?void 0:t.getUserMedia)),console.log("ğŸ” uni.startRecordå­˜åœ¨:","function"==typeof(null==uni?void 0:uni.startRecord));try{console.log("ğŸŒ ä½¿ç”¨é˜¿é‡Œäº‘è¯­éŸ³å®æ—¶è¯†åˆ«..."),await this.startAliyunWebRecording()}catch(i){return console.error("âŒ é˜¿é‡Œäº‘å®æ—¶è¯†åˆ«å¯åŠ¨å¤±è´¥:",i),void this.handleRecordingError(i.message||"è¯­éŸ³è¯†åˆ«å¯åŠ¨å¤±è´¥")}console.log("ğŸ“± æ˜¾ç¤ºå¼€å§‹å½•åˆ¶æç¤º"),o({title:"å¼€å§‹å½•åˆ¶",icon:"none"}),console.log("ğŸ“Š å½•éŸ³çŠ¶æ€æ£€æŸ¥ - isRecording:",this.isRecording),console.log("ğŸ“Š æŒ‰é’®æ–‡å­—æ£€æŸ¥ - recordButtonText:",this.recordButtonText)}},async startAliyunWebRecording(){try{console.log("ğŸŒ å¼€å§‹é˜¿é‡Œäº‘Webå®æ—¶è¯­éŸ³è¯†åˆ«..."),console.log("ğŸ” æ£€æŸ¥Webå½•éŸ³æƒé™...");if(!(await this.checkWebRecordingPermission()))throw new Error("å½•éŸ³æƒé™è¢«æ‹’ç»");console.log("ğŸ”‘ è·å–é˜¿é‡Œäº‘è¯­éŸ³è¯†åˆ«é…ç½®...");const e=await this.getAliyunSpeechConfig();console.log("âœ… è¯­éŸ³è¯†åˆ«é…ç½®å·²è·å– (é˜¿é‡Œäº‘)"),this.speechProvider="aliyun",this.currentSpeechConfig=e,await this.startWebRecording(e),console.log("âœ… é˜¿é‡Œäº‘Webå®æ—¶è¯­éŸ³è¯†åˆ«å·²å¼€å§‹")}catch(e){throw console.error("âŒ é˜¿é‡Œäº‘Webå®æ—¶è¯­éŸ³è¯†åˆ«å¯åŠ¨å¤±è´¥:",e),e}},async getAliyunSpeechConfig(){try{let e=n("token");if(!e&&(console.log("ğŸ” ç”¨æˆ·æœªç™»å½•ï¼Œå°è¯•è‡ªåŠ¨ç™»å½•..."),await this.autoLogin(),e=n("token"),!e))throw new Error("ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•è¿›è¡Œè¯­éŸ³è¯†åˆ«");const o=await r({url:M("/aliyun-speech/token"),method:"GET",header:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(o.data.success){const e=o.data.data||{},t=e.token,i=e.appKey,s=e.region||e.regionId||"cn-shanghai",n=e.websocketUrl||`wss://nls-gateway-${s}.aliyuncs.com/ws/v1`,r=e.sampleRate||this.pcmSampleRate||16e3;return this.currentToken=t,this.currentApiKey=i,this.aliyunAppKey=i,this.aliyunRegion=s,this.aliyunWsUrl=n,this.pcmSampleRate=r,console.log("âœ… è·å–é˜¿é‡Œäº‘è¯­éŸ³è¯†åˆ«é…ç½®æˆåŠŸ:",{region:s,websocketUrl:n,sampleRate:r}),{provider:"aliyun",token:t,appKey:i,websocketUrl:n,region:s,sampleRate:r}}throw new Error("è·å–è¯­éŸ³è¯†åˆ«Tokenå¤±è´¥: "+o.data.message)}catch(e){throw console.error("âŒ è·å–é˜¿é‡Œäº‘è¯­éŸ³è¯†åˆ«é…ç½®å¤±è´¥:",e),e}},async startBaiduWebRecording(){try{console.log("ğŸŒ å¼€å§‹ç™¾åº¦Webå®æ—¶è¯­éŸ³è¯†åˆ«..."),console.log("ğŸ” æ£€æŸ¥Webå½•éŸ³æƒé™...");if(!(await this.checkWebRecordingPermission()))throw new Error("å½•éŸ³æƒé™è¢«æ‹’ç»");console.log("ğŸ”‘ è·å–ç™¾åº¦è¯­éŸ³è¯†åˆ«é…ç½®...");const e=await this.getBaiduSpeechConfig();console.log("âœ… è¯­éŸ³è¯†åˆ«é…ç½®å·²è·å–"),await this.startWebRecording(e),console.log("âœ… ç™¾åº¦Webå®æ—¶è¯­éŸ³è¯†åˆ«å·²å¼€å§‹")}catch(e){throw console.error("âŒ ç™¾åº¦Webå®æ—¶è¯­éŸ³è¯†åˆ«å¯åŠ¨å¤±è´¥:",e),e}},async startBaiduMobileRecording(){console.log("ğŸ¯ ç§»åŠ¨ç«¯ç¯å¢ƒä½¿ç”¨Webå½•éŸ³æ–¹æ¡ˆè¿›è¡Œè¯†åˆ« (é˜¿é‡Œäº‘)"),await this.startAliyunWebRecording()},isCapacitorEnvironment:()=>!(!window.Capacitor||!window.Capacitor.isNativePlatform()),async autoLogin(){try{console.log("ğŸ” å¼€å§‹è‡ªåŠ¨ç™»å½•...");const e=await r({url:M("/auth/login"),method:"POST",header:{"Content-Type":"application/json"},data:{identifier:"demo",password:"demo123"}});if(e.data.success){const{token:o,user:t}=e.data.data;return u("token",o),u("user",t),console.log("âœ… è‡ªåŠ¨ç™»å½•æˆåŠŸ"),!0}return console.error("âŒ è‡ªåŠ¨ç™»å½•å¤±è´¥:",e.data.message),!1}catch(e){return console.error("âŒ è‡ªåŠ¨ç™»å½•å¼‚å¸¸:",e),!1}},async getBaiduSpeechConfig(){try{let e=n("token");if(!e&&(console.log("ğŸ” ç”¨æˆ·æœªç™»å½•ï¼Œå°è¯•è‡ªåŠ¨ç™»å½•..."),await this.autoLogin(),e=n("token"),!e))throw new Error("ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•è¿›è¡Œè¯­éŸ³è¯†åˆ«");const o=await r({url:M("/speech/token"),method:"GET",header:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(o.data.success){const e=o.data.data||{},t=e.token,i=e.appId,s=e.apiKey,n=e.devPid||15372,r=e.sampleRate||this.pcmSampleRate,a=e.cuid||this.generateSessionId();return this.currentToken=t,this.currentApiKey=s,this.baiduAppId=i,this.baiduApiKey=s,this.baiduDevPid=n,this.pcmSampleRate=r,this.baiduCuid=a,console.log("âœ… è·å–ç™¾åº¦è¯­éŸ³è¯†åˆ«é…ç½®æˆåŠŸ:",{appId:i,devPid:n,sampleRate:r,cuid:a}),{token:t,appId:i,apiKey:s,devPid:n,sampleRate:r,cuid:a}}throw new Error("è·å–è¯­éŸ³è¯†åˆ«Tokenå¤±è´¥: "+o.data.message)}catch(e){throw console.error("âŒ è·å–ç™¾åº¦è¯­éŸ³è¯†åˆ«é…ç½®å¤±è´¥:",e),e}},async checkWebRecordingPermission(){try{if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop()),!0}throw new Error("Webå½•éŸ³APIä¸å¯ç”¨")}catch(e){return console.error("âŒ æ£€æŸ¥Webå½•éŸ³æƒé™å¤±è´¥:",e),!1}},checkBaiduPermission:async()=>(console.log("ğŸ” é»˜è®¤æˆäºˆå½•éŸ³æƒé™ï¼ˆç§»åŠ¨ç«¯æ’ä»¶æœªå¯ç”¨ï¼‰"),{granted:!0,denied:!1,neverAsked:!1}),initializeBaiduSDK:async(e,o)=>(console.log("ğŸ”§ ç™¾åº¦ç§»åŠ¨ç«¯SDKæœªå¯ç”¨ï¼Œè·³è¿‡åˆå§‹åŒ–"),!0),async startBaiduRecording(){console.log("ğŸ¤ ä½¿ç”¨Webå½•éŸ³æ›¿ä»£åŸç”Ÿæ’ä»¶ (é˜¿é‡Œäº‘)"),await this.startAliyunWebRecording()},setupBaiduListeners(){console.log("â„¹ï¸ ç§»åŠ¨ç«¯ç›‘å¬å™¨æœªå¯ç”¨")},async startCapacitorRecording(){try{if(console.log("ğŸ“± å¼€å§‹Capacitorå½•éŸ³..."),console.log("ğŸ” æ£€æŸ¥å½•éŸ³æ’ä»¶..."),console.log("ğŸ” window.Capacitor.Plugins.VoiceRecorder:",!!window.Capacitor.Plugins.VoiceRecorder),console.log("ğŸ” window.Capacitor.Plugins.Microphone:",!!window.Capacitor.Plugins.Microphone),console.log("ğŸ” window.Media:",!!window.Media),console.log("ğŸ” window.cordova:",!!window.cordova),console.log("ğŸ” window.device:",!!window.device),window.Capacitor.Plugins.VoiceRecorder){console.log("ğŸ¤ ä½¿ç”¨VoiceRecorderæ’ä»¶...");const e=await window.Capacitor.Plugins.VoiceRecorder.startRecording();console.log("âœ… VoiceRecorderå½•éŸ³å¼€å§‹æˆåŠŸ:",e)}else if(window.Capacitor.Plugins.Microphone){console.log("ğŸ¤ ä½¿ç”¨Microphoneæ’ä»¶...");const e=await window.Capacitor.Plugins.Microphone.startRecording();console.log("âœ… Microphoneå½•éŸ³å¼€å§‹æˆåŠŸ:",e)}else{if(!window.Media)throw console.log("âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å½•éŸ³æ’ä»¶ï¼"),new Error("æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„å½•éŸ³æ’ä»¶ï¼Œæ— æ³•è¿›è¡ŒçœŸå®å½•éŸ³");console.log("ğŸ¤ ä½¿ç”¨Cordova Mediaæ’ä»¶..."),await this.startCordovaRecording()}}catch(e){throw console.error("âŒ Capacitorå½•éŸ³å¼€å§‹å¤±è´¥:",e),new Error("å½•éŸ³åŠŸèƒ½ä¸å¯ç”¨: "+e.message)}},async startCordovaRecording(){try{console.log("ğŸ¤ å¼€å§‹Cordovaå½•éŸ³...");Date.now();const e=`recording_${Date.now()}.wav`;console.log("ğŸ“ å½•éŸ³æ–‡ä»¶è·¯å¾„:",e),this.mediaRecorder=new Media(e,()=>{console.log("âœ… Cordovaå½•éŸ³å¼€å§‹æˆåŠŸ")},e=>{console.error("âŒ Cordovaå½•éŸ³å¼€å§‹å¤±è´¥:",e),this.handleRecordingError("å½•éŸ³å¼€å§‹å¤±è´¥")}),console.log("ğŸ¤ è°ƒç”¨ startRecord()..."),this.mediaRecorder.startRecord(),console.log("âœ… Cordovaå½•éŸ³å·²å¯åŠ¨"),setTimeout(()=>{this.mediaRecorder&&console.log("ğŸ” å½•éŸ³çŠ¶æ€æ£€æŸ¥:",{mediaRecorder:!!this.mediaRecorder,isRecording:this.isRecording,filePath:e})},1e3),this.startStatusMonitoring(),this.startRealtimeRecognition()}catch(e){throw console.error("âŒ Cordovaå½•éŸ³å¯åŠ¨å¤±è´¥:",e),e}},async startSimulatedRecording(){try{console.log("ğŸ­ å¼€å§‹æ¨¡æ‹Ÿå½•éŸ³æ¨¡å¼..."),this.isRecording=!0,this.recordingTime=0,this.recordingTimer=setInterval(()=>{this.recordingTime++},1e3),this.startStatusMonitoring(),o({title:"å½•éŸ³æ¨¡å¼å·²å¯åŠ¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ–‡å­—",icon:"none",duration:3e3}),console.log("âœ… æ¨¡æ‹Ÿå½•éŸ³æ¨¡å¼å¯åŠ¨æˆåŠŸ")}catch(e){console.error("âŒ æ¨¡æ‹Ÿå½•éŸ³æ¨¡å¼å¯åŠ¨å¤±è´¥:",e),this.handleRecordingFallback()}},async startWebRecordingInCapacitor(){try{console.log("ğŸŒ åœ¨Capacitorç¯å¢ƒä¸­ä½¿ç”¨Webå½•éŸ³...");const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,sampleRate:16e3,channelCount:1,autoGainControl:!0,latency:.01}});this.mediaStream=e;let t="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(t)||(t="audio/webm",MediaRecorder.isTypeSupported(t)||(t="audio/mp4",MediaRecorder.isTypeSupported(t)||(t=""))),console.log("ä½¿ç”¨MIMEç±»å‹:",t),this.mediaRecorder=new MediaRecorder(e,t?{mimeType:t}:{}),this.audioChunks=[],this.mediaRecorder.ondataavailable=e=>{console.log("æ”¶åˆ°éŸ³é¢‘æ•°æ®:",e.data.size,"bytes"),e.data.size>0&&(this.audioChunks.push(e.data),this.processRealtimeAudio(e.data))},this.mediaRecorder.onstart=()=>{console.log("ğŸ¤ MediaRecorder å·²å¼€å§‹å½•éŸ³")},this.mediaRecorder.onstop=()=>{console.log("âœ… Webå½•éŸ³åœæ­¢ï¼Œæ•°æ®å—æ•°é‡:",this.audioChunks.length),console.log("å½•éŸ³æ—¶é•¿:",this.recordingTime,"ç§’"),this.isProcessing=!1,this.recordingTime=0,o({title:"å½•åˆ¶å®Œæˆ",icon:"success"})},this.mediaRecorder.onerror=e=>{console.error("âŒ MediaRecorderé”™è¯¯:",e.error),console.error("é”™è¯¯è¯¦æƒ…:",e),this.handleRecordingError("å½•éŸ³è¿‡ç¨‹ä¸­å‡ºé”™")},this.mediaRecorder.start(),console.log("âœ… Webå½•éŸ³å¼€å§‹æˆåŠŸ (Capacitoræ¨¡å¼), çŠ¶æ€:",this.mediaRecorder.state),this.startStatusMonitoring(),this.startRealtimeRecognition()}catch(e){console.error("âŒ Capacitor Webå½•éŸ³å¼€å§‹å¤±è´¥:",e);let t="æ— æ³•è®¿é—®éº¦å…‹é£";"NotAllowedError"===e.name?t="éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨è®¾ç½®ä¸­å…è®¸å½•éŸ³æƒé™":"NotFoundError"===e.name?t="æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡":"NotReadableError"===e.name&&(t="éº¦å…‹é£è¢«å…¶ä»–åº”ç”¨å ç”¨"),o({title:t,icon:"error"}),this.handleRecordingFallback()}},async startWebRecording(e){try{console.log("ğŸŒ å¼€å§‹Webå½•éŸ³...");const i=(null==e?void 0:e.provider)||this.speechProvider||"aliyun";this.speechProvider=i,(null==e?void 0:e.sampleRate)&&(this.pcmSampleRate=e.sampleRate),this.currentSpeechConfig=e;const s=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,sampleRate:(null==e?void 0:e.sampleRate)||this.pcmSampleRate,channelCount:1}});this.mediaStream=s,await this.setupAudioProcessing(s);let n="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(n)||(n="audio/webm",MediaRecorder.isTypeSupported(n)||(n="audio/mp4",MediaRecorder.isTypeSupported(n)||(n=""))),console.log("ä½¿ç”¨MIMEç±»å‹:",n),this.mediaRecorder=new MediaRecorder(s,n?{mimeType:n}:{}),this.audioChunks=[],this.mediaRecorder.ondataavailable=e=>{console.log("æ”¶åˆ°éŸ³é¢‘æ•°æ®:",e.data.size,"bytes"),e.data.size>0&&(this.audioChunks.push(e.data),this.useAudioProcessorStreaming||this.processRealtimeAudio(e.data))},this.mediaRecorder.onstart=()=>{console.log("ğŸ¤ MediaRecorder å·²å¼€å§‹å½•éŸ³"),this.currentSpeechConfig=e,"aliyun"===this.speechProvider?this.startAliyunWebSocketRecognition(e):(this.startBaiduWebSocketRecognition(e),this.keepWebSocketAlive())},this.mediaRecorder.onpause=()=>{console.log("â¸ï¸ MediaRecorder å·²æš‚åœ")},this.mediaRecorder.onresume=()=>{console.log("â–¶ï¸ MediaRecorder å·²æ¢å¤")},this.mediaRecorder.onstop=()=>{console.log("âœ… Webå½•éŸ³åœæ­¢ï¼Œæ•°æ®å—æ•°é‡:",this.audioChunks.length),console.log("å½•éŸ³æ—¶é•¿:",this.recordingTime,"ç§’"),this.isProcessing=!1,this.recordingTime=0,o({title:"å½•åˆ¶å®Œæˆ",icon:"success"})},this.mediaRecorder.onerror=e=>{console.error("âŒ MediaRecorderé”™è¯¯:",e.error),console.error("é”™è¯¯è¯¦æƒ…:",e),this.handleRecordingError("å½•éŸ³è¿‡ç¨‹ä¸­å‡ºé”™")};try{window.Capacitor?(this.mediaRecorder.start(),console.log("âœ… Webå½•éŸ³å¼€å§‹æˆåŠŸ (Capacitoræ¨¡å¼), çŠ¶æ€:",this.mediaRecorder.state)):(this.mediaRecorder.start(100),console.log("âœ… Webå½•éŸ³å¼€å§‹æˆåŠŸ (æµè§ˆå™¨æ¨¡å¼), çŠ¶æ€:",this.mediaRecorder.state))}catch(t){console.error("âŒ MediaRecorder.start() å¤±è´¥:",t),this.mediaRecorder.start(),console.log("âœ… Webå½•éŸ³å¼€å§‹æˆåŠŸ (é™çº§æ¨¡å¼), çŠ¶æ€:",this.mediaRecorder.state)}this.startStatusMonitoring()}catch(i){console.error("âŒ Webå½•éŸ³å¼€å§‹å¤±è´¥:",i);let e="æ— æ³•è®¿é—®éº¦å…‹é£";"NotAllowedError"===i.name?e="éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨è®¾ç½®ä¸­å…è®¸å½•éŸ³æƒé™":"NotFoundError"===i.name?e="æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡":"NotReadableError"===i.name&&(e="éº¦å…‹é£è¢«å…¶ä»–åº”ç”¨å ç”¨"),o({title:e,icon:"error"}),this.handleRecordingFallback()}},async startRealtimeRecognition(){try{if(console.log("ğŸ¤ å¼€å§‹å®æ—¶è¯­éŸ³è¯†åˆ«..."),this.websocket&&this.websocket.readyState===WebSocket.OPEN)return void console.log("ğŸ“¡ WebSocketå·²è¿æ¥ï¼Œè·³è¿‡é‡å¤å¯åŠ¨");let e;e=this.currentToken&&this.baiduApiKey?{token:this.currentToken,appId:this.baiduAppId,apiKey:this.baiduApiKey,devPid:this.baiduDevPid,sampleRate:this.pcmSampleRate,cuid:this.baiduCuid||this.generateSessionId()}:await this.getBaiduSpeechConfig(),await this.startBaiduWebSocketRecognition(e)}catch(e){console.error("âŒ å¯åŠ¨å®æ—¶è¯­éŸ³è¯†åˆ«å¤±è´¥:",e)}},async setupAudioProcessing(e){try{const t=window.AudioContext||window.webkitAudioContext;if(!t)return console.warn("âš ï¸ AudioContextä¸å¯ç”¨ï¼Œç»§ç»­ä½¿ç”¨MediaRecorderå›é€€"),void(this.useAudioProcessorStreaming=!1);if(this.audioContext&&"closed"!==this.audioContext.state||(this.audioContext=new t({sampleRate:this.pcmSampleRate})),"suspended"===this.audioContext.state&&"function"==typeof this.audioContext.resume&&await this.audioContext.resume(),this.audioSourceNode){try{this.audioSourceNode.disconnect()}catch(o){console.warn("âš ï¸ æ–­å¼€æ—§éŸ³é¢‘æºå¤±è´¥:",o)}this.audioSourceNode=null}if(this.audioProcessor){try{this.audioProcessor.disconnect()}catch(o){console.warn("âš ï¸ æ–­å¼€æ—§éŸ³é¢‘å¤„ç†å™¨å¤±è´¥:",o)}this.audioProcessor=null}const i=this.audioContext.createMediaStreamSource(e),s=this.audioContext.createScriptProcessor(4096,1,1),n=this.audioContext.sampleRate,r=this.pcmSampleRate;s.onaudioprocess=e=>{if(!this.allowAudioStreaming||!this.isRecording)return;const t=e.inputBuffer;if(!t)return;const i=t.getChannelData(0);if(!i||!i.length)return;const s=t.sampleRate||n;let a=i;if(s!==r&&(a=this.downsampleBuffer(i,s,r)),!a||!a.length)return;const c=this.float32ToPCM(a);if(c&&c.byteLength&&this.websocket&&this.websocket.readyState===WebSocket.OPEN)try{this.websocket.send(c)}catch(o){console.error("âŒ é€šè¿‡éŸ³é¢‘å¤„ç†å™¨å‘é€éŸ³é¢‘å¤±è´¥:",o)}},i.connect(s),s.connect(this.audioContext.destination),this.audioSourceNode=i,this.audioProcessor=s,this.useAudioProcessorStreaming=!0,console.log("âœ… éŸ³é¢‘å¤„ç†å™¨åˆå§‹åŒ–å®Œæˆï¼Œé‡‡æ ·ç‡:",n,"â†’",r)}catch(o){console.error("âŒ åˆå§‹åŒ–éŸ³é¢‘å¤„ç†å™¨å¤±è´¥:",o),this.useAudioProcessorStreaming=!1}},isWebSpeechSupported:()=>"webkitSpeechRecognition"in window||"SpeechRecognition"in window,async testRecording(){try{if(console.log("ğŸ§ª å¼€å§‹æµ‹è¯•å½•éŸ³åŠŸèƒ½..."),window.Media){console.log("âœ… Cordova Mediaæ’ä»¶å¯ç”¨");const e=new Media("test_recording.wav",()=>{console.log("âœ… æµ‹è¯•å½•éŸ³æˆåŠŸ")},e=>{console.error("âŒ æµ‹è¯•å½•éŸ³å¤±è´¥:",e)});e.startRecord(),console.log("ğŸ¤ æµ‹è¯•å½•éŸ³å·²å¼€å§‹"),setTimeout(()=>{e.stopRecord(),console.log("ğŸ›‘ æµ‹è¯•å½•éŸ³å·²åœæ­¢")},3e3)}else console.error("âŒ Cordova Mediaæ’ä»¶ä¸å¯ç”¨")}catch(e){console.error("âŒ æµ‹è¯•å½•éŸ³å¤±è´¥:",e)}},startWebSpeechRecognition(){const e=window.SpeechRecognition||window.webkitSpeechRecognition;this.speechRecognition=new e,this.speechRecognition.continuous=!0,this.speechRecognition.interimResults=!0,this.speechRecognition.lang="zh-CN",this.speechRecognition.onresult=e=>{let o="",t="";for(let i=e.resultIndex;i<e.results.length;i++){const s=e.results[i][0].transcript;e.results[i].isFinal?t+=s:o+=s}if(t&&(console.log("ğŸ¯ æœ€ç»ˆè¯†åˆ«ç»“æœ:",t),this.contentText?this.contentText+=" "+t:this.contentText=t,this.$forceUpdate()),o){console.log("ğŸ¯ ä¸­é—´è¯†åˆ«ç»“æœ:",o);const e=this.contentText+" "+o;this.contentText=e,this.$forceUpdate()}},this.speechRecognition.onerror=e=>{console.error("âŒ Web Speech APIé”™è¯¯:",e.error)},this.speechRecognition.onend=()=>{console.log("Web Speech APIè¯†åˆ«ç»“æŸ")},this.speechRecognition.start(),console.log("âœ… Web Speech APIå¼€å§‹è¯†åˆ«")},async startAliyunWebSocketRecognition(e={}){try{const{token:t,appKey:i,websocketUrl:s,sampleRate:n=this.pcmSampleRate||16e3,region:r}=e;if(!t||!i||!s)throw new Error("é˜¿é‡Œäº‘è¯­éŸ³è¯†åˆ«é…ç½®ä¸å®Œæ•´");console.log("ğŸ¤ å¼€å§‹é˜¿é‡Œäº‘WebSocketå®æ—¶è¯†åˆ«..."),console.log("ğŸ”‘ Tokenå‰ç¼€:",t.substring(0,12)+"..."),console.log("ğŸ†” AppKey:",i),console.log("ğŸŒ Region:",r||"é»˜è®¤"),this.currentToken=t,this.currentApiKey=i,this.aliyunAppKey=i,this.aliyunRegion=r||this.aliyunRegion,this.pcmSampleRate=n,this.currentSpeechConfig={...e,provider:"aliyun",sampleRate:n},this.audioQueue=[],this.audioProcessingPromise=Promise.resolve(),this.allowAudioStreaming=!0;let a=s;if(a=a.includes("?")?`${a}&token=${encodeURIComponent(t)}`:`${a}?token=${encodeURIComponent(t)}`,console.log("ğŸŒ WebSocket URL:",a),this.websocket)try{this.websocket.close()}catch(o){console.warn("âš ï¸ å…³é—­æ—§çš„WebSocketå¤±è´¥:",o)}this.websocket=new WebSocket(a),this.websocket.binaryType="arraybuffer";const c=this.generateMessageId();this.aliyunTaskId=c,this.websocket.onopen=()=>{console.log("âœ… é˜¿é‡Œäº‘WebSocketè¿æ¥å·²å»ºç«‹");const e={header:{message_id:this.generateMessageId(),task_id:c,namespace:"SpeechTranscriber",name:"StartTranscription",appkey:i},payload:{format:"pcm",sample_rate:Number(n)||16e3,enable_intermediate_result:!0,enable_punctuation_prediction:!0,enable_inverse_text_normalization:!0,disfluency:!0,max_sentence_silence:800}};try{this.websocket.send(JSON.stringify(e)),console.log("ğŸ“¤ å·²å‘é€é˜¿é‡Œäº‘StartTranscriptionæŒ‡ä»¤")}catch(o){console.error("âŒ å‘é€StartæŒ‡ä»¤å¤±è´¥:",o)}},this.websocket.onmessage=e=>{this.handleAliyunWebSocketMessage(e)},this.websocket.onclose=e=>{console.log("ğŸ”Œ é˜¿é‡Œäº‘WebSocketè¿æ¥å·²å…³é—­:",e.code,e.reason),this.allowAudioStreaming=!1},this.websocket.onerror=e=>{console.error("âŒ é˜¿é‡Œäº‘WebSocketè¿æ¥é”™è¯¯:",e),this.allowAudioStreaming=!1}}catch(t){throw console.error("âŒ å¯åŠ¨é˜¿é‡Œäº‘WebSocketè¯†åˆ«å¤±è´¥:",t),this.allowAudioStreaming=!1,t}},async startBaiduWebSocketRecognition(e={}){try{const{token:t,appId:i,apiKey:s,devPid:n=this.baiduDevPid,sampleRate:r=this.pcmSampleRate,cuid:a=this.generateSessionId()}=e;if(!t||!s||!i)throw new Error("ç™¾åº¦è¯­éŸ³è¯†åˆ«é…ç½®ä¸å®Œæ•´");console.log("ğŸ¤ å¼€å§‹ç™¾åº¦WebSocketå®æ—¶è¯†åˆ«..."),console.log("ğŸ”‘ Tokenå‰ç¼€:",t.substring(0,12)+"..."),console.log("ğŸ†” AppID:",i),console.log("ğŸ§  æ¨¡å‹ dev_pid:",n),this.currentToken=t,this.currentApiKey=s,this.baiduAppId=i,this.baiduApiKey=s,this.baiduDevPid=n,this.pcmSampleRate=r,this.baiduCuid=a,this.audioQueue=[],this.audioProcessingPromise=Promise.resolve(),this.allowAudioStreaming=!0;const c=this.generateMessageId(),l=`wss://vop.baidu.com/realtime_asr?${new URLSearchParams({sn:c,appid:i,token:t}).toString()}`;if(console.log("ğŸŒ WebSocket URL:",l),this.websocket)try{this.websocket.close()}catch(o){console.warn("âš ï¸ å…³é—­æ—§çš„WebSocketå¤±è´¥:",o)}this.websocket=new WebSocket(l),this.websocket.binaryType="arraybuffer",this.websocket.onopen=()=>{console.log("âœ… WebSocketè¿æ¥å·²å»ºç«‹");const e={type:"START",data:{appid:Number(i),appkey:s,token:t,dev_pid:Number(n),cuid:a,format:"pcm",sample:Number(r)}};try{this.websocket.send(JSON.stringify(e)),console.log("ğŸ“¤ å·²å‘é€ç™¾åº¦STARTå¸§")}catch(o){console.error("âŒ å‘é€STARTå¸§å¤±è´¥:",o)}},this.websocket.onmessage=e=>{this.handleWebSocketMessage(e)},this.websocket.onclose=e=>{console.log("ğŸ”Œ WebSocketè¿æ¥å·²å…³é—­:",e.code,e.reason),this.allowAudioStreaming=!1,this.isRecording&&(console.log("ğŸ”„ å½•éŸ³è¿›è¡Œä¸­ï¼Œå°è¯•é‡è¿ç™¾åº¦WebSocket..."),this.reconnectWebSocket({token:t,appId:i,apiKey:s,devPid:n,sampleRate:r,cuid:a}))},this.websocket.onerror=e=>{console.error("âŒ WebSocketè¿æ¥é”™è¯¯:",e),this.allowAudioStreaming=!1}}catch(t){throw console.error("âŒ å¯åŠ¨ç™¾åº¦WebSocketè¯†åˆ«å¤±è´¥:",t),this.allowAudioStreaming=!1,t}},async reconnectWebSocket(e){try{console.log("ğŸ”„ å‡†å¤‡åœ¨2ç§’åé‡è¿ç™¾åº¦WebSocket..."),setTimeout(()=>{this.startBaiduWebSocketRecognition(e)},2e3)}catch(o){console.error("âŒ WebSocketé‡è¿å¤±è´¥:",o)}},keepWebSocketAlive(){this.websocketKeepAliveTimer&&(clearInterval(this.websocketKeepAliveTimer),this.websocketKeepAliveTimer=null),"baidu"===this.speechProvider?this.websocketKeepAliveTimer=setInterval(()=>{this.websocket&&this.websocket.readyState===WebSocket.OPEN?console.log("ğŸ’“ WebSocketè¿æ¥æ­£å¸¸"):this.isRecording&&this.currentToken&&this.currentApiKey&&this.baiduAppId&&(console.log("âš ï¸ WebSocketè¿æ¥å¼‚å¸¸ï¼Œå°è¯•é‡è¿..."),this.reconnectWebSocket({token:this.currentToken,appId:this.baiduAppId,apiKey:this.currentApiKey,devPid:this.baiduDevPid,sampleRate:this.pcmSampleRate,cuid:this.baiduCuid||this.generateSessionId()}))},5e3):this.websocketKeepAliveTimer=setInterval(()=>{this.websocket&&this.websocket.readyState===WebSocket.OPEN&&console.log("ğŸ’“ WebSocketè¿æ¥æ­£å¸¸")},5e3)},stopKeepWebSocketAlive(){this.websocketKeepAliveTimer&&(clearInterval(this.websocketKeepAliveTimer),this.websocketKeepAliveTimer=null,console.log("ğŸ›‘ åœæ­¢WebSocketä¿æ´»"))},sendStopRequest(){if(this.websocket&&this.websocket.readyState===WebSocket.OPEN)try{if("aliyun"===this.speechProvider){const e={header:{message_id:this.generateMessageId(),task_id:this.aliyunTaskId||this.generateMessageId(),namespace:"SpeechTranscriber",name:"StopTranscription",appkey:this.aliyunAppKey||this.currentApiKey},payload:{}};this.websocket.send(JSON.stringify(e)),console.log("ğŸ›‘ å·²å‘é€é˜¿é‡Œäº‘StopTranscriptionæŒ‡ä»¤")}else this.websocket.send(JSON.stringify({type:"FINISH"})),console.log("ğŸ›‘ å·²å‘é€ç™¾åº¦FINISHå¸§")}catch(e){console.error("âŒ å‘é€FINISHå¸§å¤±è´¥:",e)}else console.log("âš ï¸ WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€åœæ­¢è¯·æ±‚")},scheduleStopRequest(){(async()=>{try{this.audioProcessingPromise&&await this.audioProcessingPromise.catch(e=>{console.error("âŒ ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆæ—¶å‡ºé”™:",e)}),await this.processAudioQueue()}catch(e){console.error("âŒ åœæ­¢å‰å¤„ç†éŸ³é¢‘é˜Ÿåˆ—å¤±è´¥:",e)}finally{if(this.sendStopRequest(),this.audioQueue=[],this.audioProcessingPromise=Promise.resolve(),this.allowAudioStreaming=!1,this.decodeAudioContext&&"closed"!==this.decodeAudioContext.state)try{this.decodeAudioContext.close()}catch(o){console.warn("âš ï¸ å…³é—­AudioContextæ—¶å‡ºé”™:",o)}this.decodeAudioContext=null}})()},handleAliyunWebSocketMessage(e){try{if(!e||"string"!=typeof e.data)return;const o=JSON.parse(e.data),t=(null==o?void 0:o.header)||{},i=(null==o?void 0:o.payload)||{},s=t.name;switch(t.task_id&&(this.aliyunTaskId=t.task_id),s){case"TranscriptionStarted":console.log("ğŸš€ é˜¿é‡Œäº‘è¯†åˆ«å·²å¯åŠ¨");break;case"SentenceBegin":console.log("ğŸ“ é˜¿é‡Œäº‘æ£€æµ‹åˆ°å¥å­å¼€å§‹:",null==i?void 0:i.index);break;case"TranscriptionResultChanged":{const e=(null==i?void 0:i.result)||(null==i?void 0:i.text);e&&(console.log("ğŸ¯ é˜¿é‡Œäº‘ä¸­é—´ç»“æœ:",e),this.updateContentText(e,!1));break}case"SentenceEnd":{const e=(null==i?void 0:i.result)||(null==i?void 0:i.text);e&&(console.log("âœ… é˜¿é‡Œäº‘æœ€ç»ˆç»“æœ:",e),this.updateContentText(e,!0));break}case"TranscriptionCompleted":console.log("ğŸ é˜¿é‡Œäº‘è¯†åˆ«å®Œæˆ"),this.lastPartialText="";break;case"TaskFailed":{const e=(null==t?void 0:t.status_text)||(null==t?void 0:t.status_message)||"è¯†åˆ«å¤±è´¥";console.error("âŒ é˜¿é‡Œäº‘è¯†åˆ«å¤±è´¥:",e);break}default:s&&console.log("â„¹ï¸ é˜¿é‡Œäº‘æœªå¤„ç†äº‹ä»¶:",s,i)}}catch(o){console.error("âŒ è§£æé˜¿é‡Œäº‘WebSocketæ¶ˆæ¯å¤±è´¥:",o)}},handleWebSocketMessage(e){if("aliyun"!==this.speechProvider)try{const o=JSON.parse(e.data);console.log("ğŸ“¨ æ”¶åˆ°WebSocketæ¶ˆæ¯:",o);const{type:t,result:i,results:s,err_no:n,err_msg:r}=o;if("HEARTBEAT"===t)return void console.log("ğŸ’“ æ”¶åˆ°ç™¾åº¦å¿ƒè·³å¸§");if(void 0!==n&&0!==n)return void console.error("âŒ ç™¾åº¦è¯†åˆ«è¿”å›é”™è¯¯:",n,r);let a="";if(Array.isArray(s)&&s.length>0?a=s.map(e=>{var o;return(null==(o=e[0])?void 0:o.words)||e}).join(""):"string"==typeof i&&(a=i),!a)return void console.log("âš ï¸ è¯†åˆ«ç»“æœä¸ºç©º");"MID_TEXT"===t?(console.log("ğŸ¯ ç™¾åº¦ä¸­é—´è¯†åˆ«ç»“æœ:",a),this.updateContentText(a,!1)):"FIN_TEXT"===t?(console.log("âœ… ç™¾åº¦æœ€ç»ˆè¯†åˆ«ç»“æœ:",a),this.updateContentText(a,!0)):console.log("â„¹ï¸ æ”¶åˆ°æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹:",t)}catch(o){console.error("âŒ è§£æWebSocketæ¶ˆæ¯å¤±è´¥:",o)}else this.handleAliyunWebSocketMessage(e)},updateContentText(e,o=!1){if(!e||!e.trim())return void console.log("âš ï¸ ç©ºæ–‡æœ¬ï¼Œè·³è¿‡æ›´æ–°");const t=e.trim();let i=this.contentText||"";if(this.lastPartialText){const e=this.lastPartialText.trim();e&&i.endsWith(e)&&(i=i.slice(0,i.length-e.length).trimEnd())}let s=i?i.replace(/\s+$/u,""):"";s?(s+=s.endsWith(" ")?"":" ",s+=t):s=t,this.contentText=s,this.lastPartialText=o?"":t,console.log("ğŸ“ æ–‡æœ¬å·²æ›´æ–°:",this.contentText),console.log("ğŸ“ æ–°å¢æ–‡æœ¬:",t,"æœ€ç»ˆç»“æœ:",o),this.$nextTick(()=>{this.$forceUpdate()})},generateMessageId(){let e="";for(let o=0;o<32;o++)e+="0123456789abcdef"[Math.floor(16*Math.random())];return e},generateSessionId:()=>`memoir-${Math.random().toString(36).substring(2,12)}`,async startWebAudioRecording(){try{console.log("ğŸ¤ å¼€å§‹WebéŸ³é¢‘å½•éŸ³...");const e=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0}});this.mediaStream=e;const o=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3}),t=o.createMediaStreamSource(e),i=o.createScriptProcessor(4096,1,1);i.onaudioprocess=e=>{if(this.isRecording&&this.websocket&&this.websocket.readyState===WebSocket.OPEN){const o=e.inputBuffer.getChannelData(0);this.sendAudioData(o)}},t.connect(i),i.connect(o.destination),this.audioProcessor=i,this.audioContext=o,console.log("âœ… WebéŸ³é¢‘å½•éŸ³å·²å¼€å§‹")}catch(e){throw console.error("âŒ WebéŸ³é¢‘å½•éŸ³å¤±è´¥:",e),e}},sendAudioData(e){try{const o=this.convertToPCM(e);this.websocket&&this.websocket.readyState===WebSocket.OPEN&&this.websocket.send(o)}catch(o){console.error("âŒ å‘é€éŸ³é¢‘æ•°æ®å¤±è´¥:",o)}},convertToPCM(e){const o=new ArrayBuffer(2*e.length),t=new DataView(o);for(let i=0;i<e.length;i++){const o=Math.max(-1,Math.min(1,e[i]));t.setInt16(2*i,32767*o,!0)}return o},async startAliyunRealtimeRecognition(){var e;const o=n("token");if(!o)return void console.error("âŒ ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•è¿›è¡Œå®æ—¶è¯†åˆ«");const t=await r({url:M("/speech/token"),method:"GET",header:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});if(200!==t.statusCode||!t.data.success)return void console.error("âŒ è·å–è¯­éŸ³è¯†åˆ«Tokenå¤±è´¥:",null==(e=t.data)?void 0:e.message);const i=t.data.data.token;console.log("âœ… è·å–è¯­éŸ³è¯†åˆ«TokenæˆåŠŸ"),this.realtimeRecognitionTimer=setInterval(()=>{this.performStreamingRecognition(i)},3e3)},async performStreamingRecognition(e){if(this.isRecording)try{if(console.log("ğŸ¤ æ‰§è¡Œæµå¼è¯­éŸ³è¯†åˆ«..."),this.mediaRecorder&&this.mediaRecorder.src){console.log("ğŸ“ ä½¿ç”¨Cordovaå½•éŸ³æ–‡ä»¶è¿›è¡Œæµå¼è¯†åˆ«:",this.mediaRecorder.src);const o=this.mediaRecorder.src;if(this.lastRecognizedFile===o)return void console.log("â­ï¸ æ–‡ä»¶å·²è¯†åˆ«è¿‡ï¼Œè·³è¿‡");await this.callStreamingRecognitionAPI(e,this.mediaRecorder.src),this.lastRecognizedFile=o}else console.log("ğŸ¤ ç­‰å¾…å½•éŸ³æ–‡ä»¶ç”Ÿæˆ...")}catch(o){console.error("âŒ æµå¼è¯­éŸ³è¯†åˆ«å¤±è´¥:",o)}},async performRealtimeRecognition(e){if(this.isRecording)try{if(console.log("ğŸ¤ æ‰§è¡Œå®æ—¶è¯­éŸ³è¯†åˆ«..."),this.mediaRecorder&&this.mediaRecorder.src){console.log("ğŸ“ ä½¿ç”¨Cordovaå½•éŸ³æ–‡ä»¶è¿›è¡Œè¯†åˆ«:",this.mediaRecorder.src);const o=this.mediaRecorder.src;if(this.lastRecognizedFile===o)return void console.log("â­ï¸ æ–‡ä»¶å·²è¯†åˆ«è¿‡ï¼Œè·³è¿‡");await this.callAliyunRecognitionAPI(e,this.mediaRecorder.src),this.lastRecognizedFile=o}else console.log("ğŸ¤ ç­‰å¾…å½•éŸ³æ–‡ä»¶ç”Ÿæˆ...")}catch(o){console.error("âŒ å®æ—¶è¯­éŸ³è¯†åˆ«å¤±è´¥:",o)}},async callStreamingRecognitionAPI(e,o){var t;try{console.log("ğŸ¯ è°ƒç”¨ç™¾åº¦æµå¼è¯†åˆ«API..."),console.log("ğŸ“ æ–‡ä»¶è·¯å¾„:",o);const e=n("token");console.log("ğŸ“– è¯»å–éŸ³é¢‘æ–‡ä»¶...");const i=await this.readAudioFile(o);if(!i)return void console.error("âŒ æ— æ³•è¯»å–éŸ³é¢‘æ–‡ä»¶");const s=h(i),a=await r({url:M("/speech/streaming-recognize"),method:"POST",header:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},data:{audioData:s,format:"wav",sampleRate:16e3,realtime:!0}});if(200===a.statusCode&&a.data.success){const e=a.data.data.transcript;e&&"è¯†åˆ«å®Œæˆä½†æ— ç»“æœ"!==e&&e.length>0&&(console.log("ğŸ¯ æµå¼è¯†åˆ«ç»“æœ:",e),this.contentText?this.contentText+=" "+e:this.contentText=e,this.$forceUpdate(),console.log("ğŸ“ æ–‡æœ¬å·²æ›´æ–°:",this.contentText))}else console.error("âŒ æµå¼è¯†åˆ«å¤±è´¥:",null==(t=a.data)?void 0:t.message)}catch(i){console.error("âŒ ç™¾åº¦æµå¼è¯†åˆ«APIè°ƒç”¨å¤±è´¥:",i)}},async callAliyunRecognitionAPI(e,o){var t;try{console.log("ğŸ¯ è°ƒç”¨ç™¾åº¦æµå¼è¯†åˆ«API..."),console.log("ğŸ“ æ–‡ä»¶è·¯å¾„:",o);const e=n("token");console.log("ğŸ“– è¯»å–éŸ³é¢‘æ–‡ä»¶...");if(!(await this.readAudioFile(o)))return void console.error("âŒ æ— æ³•è¯»å–éŸ³é¢‘æ–‡ä»¶");const i=await r({url:M("/speech/transcribe"),method:"POST",header:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},data:{filename:o,realtime:!0,streaming:!0}});if(200===i.statusCode&&i.data.success){const e=i.data.data.transcript;e&&"è¯†åˆ«å®Œæˆä½†æ— ç»“æœ"!==e&&e.length>0&&(console.log("ğŸ¯ æµå¼è¯†åˆ«ç»“æœ:",e),this.contentText?this.contentText+=" "+e:this.contentText=e)}else console.error("âŒ æµå¼è¯†åˆ«å¤±è´¥:",null==(t=i.data)?void 0:t.message)}catch(i){console.error("âŒ ç™¾åº¦æµå¼è¯†åˆ«APIè°ƒç”¨å¤±è´¥:",i)}},async readAudioFile(e){try{if(console.log("ğŸ“– å°è¯•è¯»å–éŸ³é¢‘æ–‡ä»¶:",e),window.Capacitor){if(console.log("ğŸ“± ä½¿ç”¨Capacitoræ–‡ä»¶ç³»ç»Ÿ..."),window.Capacitor.Plugins.Filesystem)try{const o=await window.Capacitor.Plugins.Filesystem.readFile({path:e,directory:"DATA"});console.log("âœ… Capacitoræ–‡ä»¶è¯»å–æˆåŠŸï¼Œå¤§å°:",o.data.length);const t=atob(o.data),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i.buffer}catch(o){console.log("âš ï¸ Capacitor Filesystemè¯»å–å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•:",o)}try{console.log("ğŸŒ å°è¯•ä½¿ç”¨fetchè¯»å–æ–‡ä»¶...");const o=await fetch(e);if(o.ok){const e=await o.arrayBuffer();return console.log("âœ… fetchæ–‡ä»¶è¯»å–æˆåŠŸï¼Œå¤§å°:",e.byteLength),e}}catch(t){console.log("âš ï¸ fetchè¯»å–å¤±è´¥:",t)}console.log("ğŸ§ª ä½¿ç”¨æ¨¡æ‹ŸéŸ³é¢‘æ•°æ®...");return new ArrayBuffer(1024)}{const o=uni.getFileSystemManager();return new Promise((t,i)=>{o.readFile({filePath:e,success:e=>{console.log("âœ… éŸ³é¢‘æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå¤§å°:",e.data.byteLength),t(e.data)},fail:e=>{console.error("âŒ éŸ³é¢‘æ–‡ä»¶è¯»å–å¤±è´¥:",e),i(e)}})})}}catch(i){return console.error("âŒ è¯»å–éŸ³é¢‘æ–‡ä»¶å¼‚å¸¸:",i),null}},processRealtimeAudio(e){if(!e)return void console.warn("âš ï¸ æœªæ¥æ”¶åˆ°æœ‰æ•ˆçš„éŸ³é¢‘æ•°æ®");if(!this.allowAudioStreaming)return void console.log("ğŸ›‘ å½“å‰ä¸å…è®¸å‘é€éŸ³é¢‘æµï¼Œå¿½ç•¥æ•°æ®");const o=this.audioProcessingPromise||Promise.resolve();this.audioProcessingPromise=o.then(async()=>{if(!this.allowAudioStreaming)return void console.log("ğŸ›‘ éŸ³é¢‘æµå·²åœæ­¢ï¼Œè·³è¿‡å¤„ç†");console.log("å¤„ç†å®æ—¶éŸ³é¢‘æ•°æ®:",e.size||e.byteLength||0,"bytes"),console.log("ğŸ” éŸ³é¢‘æ•°æ®ç±»å‹:",e.constructor?e.constructor.name:typeof e),console.log("ğŸ” WebSocketçŠ¶æ€:",this.websocket?this.websocket.readyState:"null");const o=await this.preparePcmBuffer(e);if(o&&o.byteLength)if(this.allowAudioStreaming)if(this.websocket&&this.websocket.readyState===WebSocket.OPEN)try{this.websocket.send(o),console.log("âœ… éŸ³é¢‘æ•°æ®å‘é€æˆåŠŸ (PCMæ ¼å¼)ï¼Œå¤§å°:",o.byteLength,"bytes")}catch(t){console.error("âŒ å‘é€éŸ³é¢‘æ•°æ®å¤±è´¥:",t),this.allowAudioStreaming&&this.audioQueue.push(o)}else this.allowAudioStreaming&&(console.log("ğŸ“¦ WebSocketæœªå°±ç»ªï¼Œå°†PCMéŸ³é¢‘æ•°æ®åŠ å…¥é˜Ÿåˆ—:",o.byteLength,"bytes"),this.audioQueue.push(o),this.websocket&&this.websocket.readyState!==WebSocket.CLOSED||(this.isRecording||this.isProcessing)&&this.currentToken&&this.currentApiKey&&this.baiduAppId&&(console.log("ğŸ”„ å°è¯•é‡è¿WebSocket..."),this.reconnectWebSocket({token:this.currentToken,appId:this.baiduAppId,apiKey:this.currentApiKey,devPid:this.baiduDevPid,sampleRate:this.pcmSampleRate,cuid:this.baiduCuid||this.generateSessionId()})));else console.log("ğŸ›‘ éŸ³é¢‘æµå·²åœæ­¢ï¼Œåœ¨å‘é€å‰ç»ˆæ­¢");else console.warn("âš ï¸ PCMè½¬æ¢å¤±è´¥æˆ–ä¸ºç©ºï¼Œè·³è¿‡å½“å‰éŸ³é¢‘å—")}).catch(e=>{console.error("âŒ å¤„ç†éŸ³é¢‘æ•°æ®å¤±è´¥:",e)})},async preparePcmBuffer(e){try{return e?e instanceof ArrayBuffer?e:ArrayBuffer.isView(e)?e.buffer:e instanceof Blob?await this.convertWebMToPCM(e):"function"==typeof e.arrayBuffer?await e.arrayBuffer():(console.warn("âš ï¸ ä¸æ”¯æŒçš„éŸ³é¢‘æ•°æ®ç±»å‹ï¼Œæ— æ³•è½¬æ¢ä¸ºPCM"),null):null}catch(o){return console.error("âŒ å‡†å¤‡PCMéŸ³é¢‘æ•°æ®å¤±è´¥:",o),null}},async processAudioQueue(){if(!this.allowAudioStreaming)return this.audioQueue.length&&console.log("ğŸ§¹ éŸ³é¢‘æµå·²å…³é—­ï¼Œæ¸…ç©ºå¾…å‘é€é˜Ÿåˆ—"),void(this.audioQueue=[]);if(0!==this.audioQueue.length){for(console.log("ğŸ“¦ å¤„ç†éŸ³é¢‘é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é•¿åº¦:",this.audioQueue.length);this.audioQueue.length>0&&this.websocket&&this.websocket.readyState===WebSocket.OPEN;){const o=this.audioQueue.shift(),t=o instanceof ArrayBuffer?o:null==o?void 0:o.buffer;if(t&&t.byteLength)try{this.websocket.send(t),console.log("âœ… å‘é€é˜Ÿåˆ—ä¸­çš„éŸ³é¢‘æ•°æ®:",t.byteLength,"bytes (PCMæ ¼å¼)")}catch(e){console.error("âŒ å‘é€é˜Ÿåˆ—éŸ³é¢‘æ•°æ®å¤±è´¥:",e),this.audioQueue.unshift(t);break}else console.warn("âš ï¸ é˜Ÿåˆ—ä¸­çš„éŸ³é¢‘æ•°æ®æ— æ•ˆï¼Œå·²è·³è¿‡")}console.log("ğŸ“¦ éŸ³é¢‘é˜Ÿåˆ—å¤„ç†å®Œæˆï¼Œå‰©ä½™:",this.audioQueue.length)}else console.log("ğŸ“¦ éŸ³é¢‘é˜Ÿåˆ—ä¸ºç©º")},async convertWebMToPCM(e){try{console.log("ğŸ”„ å¼€å§‹è½¬æ¢WebMåˆ°PCMæ ¼å¼...");const o=window.AudioContext||window.webkitAudioContext;if(!o)throw new Error("AudioContext ä¸å¯ç”¨");this.decodeAudioContext&&"closed"!==this.decodeAudioContext.state||(this.decodeAudioContext=new o);const t=await e.arrayBuffer(),i=await new Promise((e,o)=>{this.decodeAudioContext.decodeAudioData(t.slice(0),e,o)}),s=await this.resampleAudioData(i,this.pcmSampleRate);if(!s||!s.length)throw new Error("é‡é‡‡æ ·ç»“æœä¸ºç©º");const n=this.float32ToPCM(s);return console.log("âœ… WebMåˆ°PCMè½¬æ¢å®Œæˆï¼Œå­—èŠ‚æ•°:",n.byteLength),n}catch(o){return console.error("âŒ WebMåˆ°PCMè½¬æ¢å¤±è´¥:",o),null}},async resampleAudioData(e,o){if(!e)return null;if(e.sampleRate===o)return e.getChannelData(0);const t=window.OfflineAudioContext||window.webkitOfflineAudioContext;if(t)try{const i=new t(1,Math.ceil(e.duration*o),o),s=i.createBufferSource();s.buffer=e,s.connect(i.destination),s.start(0);return(await i.startRendering()).getChannelData(0)}catch(s){console.warn("âš ï¸ OfflineAudioContext é‡é‡‡æ ·å¤±è´¥ï¼Œä½¿ç”¨é™çº§ç®—æ³•:",s)}const i=e.getChannelData(0);return this.downsampleBuffer(i,e.sampleRate,o)},downsampleBuffer(e,o,t){if(!e||o===t)return e;const i=o/t,s=Math.round(e.length/i),n=new Float32Array(s);for(let r=0;r<s;r++){const o=Math.floor(r*i);n[r]=e[o]}return n},float32ToPCM(e){if(!e)return new ArrayBuffer(0);const o=new ArrayBuffer(2*e.length),t=new DataView(o);for(let i=0;i<e.length;i++){let o=Math.max(-1,Math.min(1,e[i]));t.setInt16(2*i,o<0?32768*o:32767*o,!0)}return o},handleRecordingFallback(){console.log("ğŸ”„ å½•éŸ³APIä¸å¯ç”¨ï¼Œä½¿ç”¨é™çº§å¤„ç†"),this.isRecording=!1,this.isProcessing=!1,this.allowAudioStreaming=!1,this.recordingTimer&&(clearInterval(this.recordingTimer),this.recordingTimer=null),o({title:"å½“å‰ç¯å¢ƒä¸æ”¯æŒå½•éŸ³",icon:"error"})},stopRecording(e){if(!this.isRecording)return;e&&(e.preventDefault(),e.stopPropagation()),console.log("ğŸ›‘ åœæ­¢å½•éŸ³...");const o=this.isRecording;if(this.isRecording=!1,this.isProcessing=!0,this.lastPartialText="",this.recordingTimer&&(clearInterval(this.recordingTimer),this.recordingTimer=null),this.scheduleStopRequest(),this.stopKeepWebSocketAlive(),this.realtimeRecognitionTimer&&(clearInterval(this.realtimeRecognitionTimer),this.realtimeRecognitionTimer=null),this.stopStatusMonitoring(),window.Capacitor&&window.Capacitor.Plugins&&window.Capacitor.Plugins.AliyunSpeech){console.log("ğŸ¤ åœæ­¢ç™¾åº¦æ’ä»¶å½•éŸ³...");try{window.Capacitor.Plugins.AliyunSpeech.stopRecording(),window.Capacitor.Plugins.AliyunSpeech.removeAllListeners(),console.log("âœ… ç™¾åº¦æ’ä»¶å½•éŸ³å·²åœæ­¢")}catch(t){console.error("âŒ åœæ­¢ç™¾åº¦æ’ä»¶å½•éŸ³å¤±è´¥:",t)}}this.speechRecognition&&(this.speechRecognition.stop(),this.speechRecognition=null),this.websocket&&(this.websocket.close(),this.websocket=null,console.log("ğŸ”Œ WebSocketè¿æ¥å·²å…³é—­")),this.audioProcessor&&(this.audioProcessor.disconnect(),this.audioProcessor=null,console.log("ğŸµ éŸ³é¢‘å¤„ç†å™¨å·²åœæ­¢")),this.audioContext&&(this.audioContext.close(),this.audioContext=null,console.log("ğŸµ éŸ³é¢‘ä¸Šä¸‹æ–‡å·²å…³é—­")),this.mediaStream?(console.log("ğŸŒ åœæ­¢Webå½•éŸ³..."),this.stopWebRecording()):this.mediaRecorder&&"function"==typeof this.mediaRecorder.stopRecord?(console.log("ğŸ¤ åœæ­¢Cordovaå½•éŸ³..."),this.stopCordovaRecording()):"undefined"!=typeof uni&&"function"==typeof uni.stopRecord?(console.log("ğŸ“± åœæ­¢Appå½•éŸ³..."),uni.stopRecord({success:e=>{console.log("âœ… Appå½•éŸ³åœæ­¢æˆåŠŸï¼Œæ–‡ä»¶è·¯å¾„:",e.tempFilePath),this.handleRecordingSuccess(e.tempFilePath)},fail:e=>{console.error("âŒ Appå½•éŸ³åœæ­¢å¤±è´¥:",e),this.handleRecordingError("å½•éŸ³åœæ­¢å¤±è´¥")}})):o?(console.log("ğŸ­ åœæ­¢æ¨¡æ‹Ÿå½•éŸ³æ¨¡å¼..."),this.stopSimulatedRecording()):(console.log("âš ï¸ å½“å‰ç¯å¢ƒä¸æ”¯æŒå½•éŸ³API"),this.handleRecordingError("å½•éŸ³APIä¸å¯ç”¨")),this.$nextTick(()=>{this.$forceUpdate()})},stopWebRecording(){var e;try{console.log("ğŸŒ åœæ­¢Webå½•éŸ³..."),console.log("MediaRecorderçŠ¶æ€:",null==(e=this.mediaRecorder)?void 0:e.state),this.mediaRecorder&&("recording"===this.mediaRecorder.state?(console.log("åœæ­¢MediaRecorder..."),this.mediaRecorder.stop()):"paused"===this.mediaRecorder.state&&(this.mediaRecorder.resume(),this.mediaRecorder.stop())),this.mediaStream&&(console.log("åœæ­¢åª’ä½“æµ..."),this.mediaStream.getTracks().forEach(e=>{console.log("åœæ­¢è½¨é“:",e.kind),e.stop()}),this.mediaStream=null),this.mediaRecorder=null,this.allowAudioStreaming=!1}catch(o){console.error("âŒ åœæ­¢Webå½•éŸ³å¤±è´¥:",o),this.handleRecordingError("åœæ­¢å½•éŸ³å¤±è´¥")}},stopCordovaRecording(){try{if(console.log("ğŸ¤ åœæ­¢Cordovaå½•éŸ³..."),this.mediaRecorder){this.mediaRecorder.stopRecord(),console.log("âœ… Cordovaå½•éŸ³å·²åœæ­¢");const e=this.mediaRecorder.src;console.log("ğŸ“ å½•éŸ³æ–‡ä»¶è·¯å¾„:",e),this.handleRecordingSuccess(e),this.mediaRecorder.release(),this.mediaRecorder=null}this.allowAudioStreaming=!1}catch(e){console.error("âŒ åœæ­¢Cordovaå½•éŸ³å¤±è´¥:",e),this.handleRecordingError("åœæ­¢å½•éŸ³å¤±è´¥")}},stopSimulatedRecording(){try{console.log("ğŸ­ åœæ­¢æ¨¡æ‹Ÿå½•éŸ³æ¨¡å¼..."),this.recordingTimer&&(clearInterval(this.recordingTimer),this.recordingTimer=null),this.stopStatusMonitoring(),this.isRecording=!1,this.isProcessing=!1,this.allowAudioStreaming=!1,o({title:"å½•éŸ³å®Œæˆ",icon:"success"}),console.log("âœ… æ¨¡æ‹Ÿå½•éŸ³æ¨¡å¼åœæ­¢æˆåŠŸ"),console.log("ğŸ“Š å½•éŸ³çŠ¶æ€æ£€æŸ¥ - isRecording:",this.isRecording),console.log("ğŸ“Š æŒ‰é’®æ–‡å­—æ£€æŸ¥ - recordButtonText:",this.recordButtonText)}catch(e){console.error("âŒ åœæ­¢æ¨¡æ‹Ÿå½•éŸ³æ¨¡å¼å¤±è´¥:",e),this.isRecording=!1,this.isProcessing=!1,o({title:"å½•éŸ³åœæ­¢",icon:"none"})}},async processWebAudio(e){try{console.log("ğŸµ å¤„ç†Webå½•éŸ³æ•°æ®...",e.size,"bytes"),console.log("ğŸµ éŸ³é¢‘Blobç±»å‹:",e.type);let o=".webm",t=e.type||"audio/webm";t.includes("webm")?o=".webm":t.includes("mp4")?o=".mp4":t.includes("wav")?o=".wav":t.includes("ogg")&&(o=".ogg");const i=`web_recording_${Date.now()}${o}`,s=new File([e],i,{type:t});console.log("ğŸ“ åˆ›å»ºéŸ³é¢‘æ–‡ä»¶:",{name:s.name,size:s.size,type:s.type}),await this.uploadWebAudio(s)}catch(o){console.error("âŒ å¤„ç†WebéŸ³é¢‘å¤±è´¥:",o),this.handleRecordingError("éŸ³é¢‘å¤„ç†å¤±è´¥")}},async uploadWebAudio(e){try{console.log("ğŸ“¤ ä¸Šä¼ Webå½•éŸ³æ–‡ä»¶...");const t=n("token");if(!t)throw new Error("ç”¨æˆ·æœªç™»å½•");const i=new FormData;i.append("audio",e);const s=await fetch(M("/speech/upload"),{method:"POST",headers:{Authorization:`Bearer ${t}`},body:i}),r=await s.json();if(!s.ok||!r.success)throw new Error(r.message||"ä¸Šä¼ å¤±è´¥");{console.log("âœ… WebéŸ³é¢‘ä¸Šä¼ æˆåŠŸ:",r.data);const e={id:Date.now(),duration:this.recordingTime,filePath:r.data.file.filename,transcription:"",playing:!1,isWebAudio:!0};this.recordings.push(e),this.isProcessing=!1,this.recordingTime=0,o({title:"å½•åˆ¶å®Œæˆ",icon:"success"})}}catch(t){console.error("âŒ WebéŸ³é¢‘ä¸Šä¼ å¤±è´¥:",t),this.handleRecordingError(`ä¸Šä¼ å¤±è´¥: ${t.message}`)}},handleRecordingSuccess(e){console.log("ğŸ“ å¤„ç†å½•éŸ³æ–‡ä»¶:",e);const t={id:Date.now(),duration:this.recordingTime,filePath:e,transcription:"",playing:!1};this.recordings.push(t),this.isProcessing=!1,this.recordingTime=0,o({title:"å½•åˆ¶å®Œæˆ",icon:"success"})},handleRecordingError(e){console.error("âŒ å½•éŸ³å¤„ç†å¤±è´¥:",e),this.isRecording=!1,this.isProcessing=!1,this.recordingTime=0,o({title:e||"å½•éŸ³å¤±è´¥",icon:"error"})},playRecording(e){e.playing=!e.playing,e.playing?(o({title:"å¼€å§‹æ’­æ”¾",icon:"none"}),setTimeout(()=>{e.playing=!1},1e3*e.duration)):o({title:"åœæ­¢æ’­æ”¾",icon:"none"})},async transcribeRecording(e){var t;try{d({title:"è¯­éŸ³è½¬æ–‡å­—ä¸­..."});const s=n("token");if(!s)throw new Error("ç”¨æˆ·æœªç™»å½•");console.log("æ­£åœ¨è·å–ç™¾åº¦è¯­éŸ³è¯†åˆ«Token...");const a=await r({url:M("/speech/token"),method:"GET",header:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}});if(console.log("Tokenå“åº”:",a),B(a))return;if(200!==a.statusCode||!a.data.success)throw new Error((null==(t=a.data)?void 0:t.message)||"è·å–è¯­éŸ³è¯†åˆ«Tokenå¤±è´¥");const l=a.data.data.token;if(console.log("æˆåŠŸè·å–ç™¾åº¦Token:",l.substring(0,20)+"..."),!e||!e.filePath)throw new Error("æ²¡æœ‰æ‰¾åˆ°å½•éŸ³æ–‡ä»¶");console.log("ğŸ“ å¼€å§‹å¤„ç†å½•éŸ³æ–‡ä»¶:",e.filePath);try{if(e.isWebAudio)console.log("ğŸŒ Webå½•éŸ³æ–‡ä»¶ï¼Œç›´æ¥è°ƒç”¨è½¬å†™API..."),await this.callTranscribeAPI(e,l,e.filePath);else{console.log("ğŸ“¤ å‡†å¤‡ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶è¿›è¡Œç™¾åº¦è¯†åˆ«...");const o=await this.uploadAudioFile(e.filePath,s);console.log("âœ… éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:",o),await this.callTranscribeAPI(e,l,o.file.filename)}}catch(i){console.error("âŒ éŸ³é¢‘å¤„ç†å¤±è´¥:",i),c(),o({title:"è¯­éŸ³è¯†åˆ«å¤±è´¥: "+(i.message||"æœªçŸ¥é”™è¯¯"),icon:"error",duration:3e3})}}catch(i){c(),console.error("âŒ è¯­éŸ³è½¬æ–‡å­—å¤±è´¥:",i);const e=i.message||"è¯­éŸ³è½¬æ–‡å­—å¤±è´¥";o({title:e,icon:"error",duration:3e3})}},async uploadAudioFile(e,o){try{console.log("å‡†å¤‡ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶:",e);const t=await l({url:M("/speech/upload"),filePath:e,name:"audio",header:{Authorization:`Bearer ${o}`}});if(console.log("éŸ³é¢‘ä¸Šä¼ å“åº”:",t),200===t.statusCode){const e=JSON.parse(t.data);if(e.success)return console.log("âœ… éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:",e.data),e.data;throw new Error(e.message||"éŸ³é¢‘ä¸Šä¼ å¤±è´¥")}throw new Error(`ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç : ${t.statusCode}`)}catch(t){throw console.error("âŒ éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ å¤±è´¥:",t),t}},async performRealSpeechRecognition(e,t,i){var s;try{console.log("ğŸ¯ å¼€å§‹çœŸå®è¯­éŸ³è¯†åˆ«å¤„ç†..."),console.log("ğŸ“ éŸ³é¢‘æ–‡ä»¶:",i.file.filename),console.log("ğŸ”‘ Token:",t.substring(0,20)+"...");const a=n("token"),l=await r({url:M("/speech/transcribe"),method:"POST",header:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},data:{filename:i.file.filename}});if(console.log("è½¬å†™å“åº”:",l),200!==l.statusCode||!l.data.success)throw new Error((null==(s=l.data)?void 0:s.message)||"è¯­éŸ³è¯†åˆ«è¯·æ±‚å¤±è´¥");{const t=l.data.data.transcript;e.transcription=t,this.contentText?this.contentText+="\n\n"+t:this.contentText=t,c(),o({title:"è¯­éŸ³è½¬æ–‡å­—å®Œæˆ",icon:"success"}),console.log("âœ… ç™¾åº¦è¯­éŸ³è¯†åˆ«å®Œæˆï¼"),console.log("ğŸ“„ è½¬å½•æ–‡æœ¬:",t),console.log("â° è½¬å†™æ—¶é—´:",l.data.data.transcribedAt)}}catch(a){throw console.error("âŒ çœŸå®è¯­éŸ³è¯†åˆ«å¤±è´¥:",a),a}},async callTranscribeAPI(e,t,i){var s,a;try{console.log("ğŸ¯ å¼€å§‹ç™¾åº¦è¯­éŸ³è¯†åˆ«..."),console.log("ğŸ“ éŸ³é¢‘æ–‡ä»¶:",i),console.log("ğŸ”‘ Token:",t.substring(0,20)+"...");const l=n("token"),d=await r({url:M("/speech/transcribe"),method:"POST",header:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},data:{filename:i,testMode:!1}});if(console.log("è½¬å†™å“åº”:",d),200!==d.statusCode||!d.data.success){const e=(null==(s=d.data)?void 0:s.message)||(null==(a=d.data)?void 0:a.details)||"è¯­éŸ³è¯†åˆ«è¯·æ±‚å¤±è´¥";throw console.error("âŒ è½¬å†™APIå“åº”é”™è¯¯:",d),new Error(e)}{const t=d.data.data.transcript;e.transcription=t,this.contentText?this.contentText+="\n\n"+t:this.contentText=t,c(),o({title:"è¯­éŸ³è½¬æ–‡å­—å®Œæˆ",icon:"success"}),console.log("âœ… ç™¾åº¦è¯­éŸ³è¯†åˆ«å®Œæˆï¼"),console.log("ğŸ“„ è½¬å½•æ–‡æœ¬:",t),console.log("â° è½¬å†™æ—¶é—´:",d.data.data.transcribedAt)}}catch(l){throw console.error("âŒ ç™¾åº¦è¯­éŸ³è¯†åˆ«å¤±è´¥:",l),l}},async fallbackSpeechRecognition(e,t){try{console.log("ğŸ¯ æ‰§è¡Œé™çº§è¯­éŸ³è¯†åˆ«...");const t=["æˆ‘å‡ºç”Ÿåœ¨ä¸€ä¸ªå°åŸå¸‚ï¼Œé‚£é‡Œæœ‰ç€å®é™çš„è¡—é“å’Œæ¸©æš–çš„é‚»é‡Œå…³ç³»ã€‚","ç«¥å¹´æ—¶æœ€éš¾å¿˜çš„æ˜¯å’Œå°ä¼™ä¼´ä»¬åœ¨é™¢å­é‡Œç©è€çš„ç¾å¥½æ—¶å…‰ã€‚","é‚£æ—¶å€™çš„ç”Ÿæ´»è™½ç„¶ç®€å•ï¼Œä½†å……æ»¡äº†çº¯çœŸçš„å¿«ä¹å’Œæ— å¿§æ— è™‘ã€‚","å®¶é‡Œçš„è€æˆ¿å­è™½ç„¶ä¸å¤§ï¼Œä½†æ‰¿è½½ç€æˆ‘ä»¬ä¸€å®¶äººæ¸©é¦¨çš„å›å¿†ã€‚","çˆ¶æ¯äº²éƒ½æ˜¯å‹¤åŠ³æœ´å®çš„äººï¼Œä»–ä»¬ç”¨è‡ªå·±çš„æ–¹å¼ä¸ºæˆ‘ä»¬æ’‘èµ·äº†ä¸€ä¸ªæ¸©æš–çš„å®¶ã€‚"];await new Promise(e=>setTimeout(e,1e3));const i=t[Math.floor(Math.random()*t.length)];e.transcription=i,this.contentText?this.contentText+="\n\n"+i:this.contentText=i,c(),o({title:"è¯­éŸ³è½¬æ–‡å­—å®Œæˆï¼ˆé™çº§æ¨¡å¼ï¼‰",icon:"success"}),console.log("âœ… é™çº§è¯­éŸ³è¯†åˆ«å®Œæˆï¼"),console.log("ğŸ“„ è½¬å½•æ–‡æœ¬:",i)}catch(i){throw console.error("âŒ é™çº§è¯­éŸ³è¯†åˆ«å¤±è´¥:",i),i}},deleteRecording(e){a({title:"ç¡®è®¤åˆ é™¤",content:"ç¡®å®šè¦åˆ é™¤è¿™æ®µå½•éŸ³å—ï¼Ÿ",success:t=>{t.confirm&&(this.recordings.splice(e,1),o({title:"åˆ é™¤æˆåŠŸ",icon:"success"}))}})},formatTime(e){const o=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},async aiCompleteText(){var e;if(this.contentText&&0!==this.contentText.trim().length){if(!this.isAiCompleting){this.isAiCompleting=!0,this.originalText=this.contentText;try{console.log("ğŸ¤– å¼€å§‹AIè¡¥å…¨æ–‡æœ¬...");const t=n("token");if(!t)throw new Error("ç”¨æˆ·æœªç™»å½•");const i=await r({url:M("/ai/complete-text"),method:"POST",header:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},data:{text:this.contentText,chapterId:this.chapterId,chapterTitle:this.chapterTitle}});if(200!==i.statusCode||!i.data.success)throw new Error((null==(e=i.data)?void 0:e.message)||"AIè¡¥å…¨å¤±è´¥");this.aiCompletedText=i.data.data.completedText,this.showAiDiff=!0,console.log("âœ… AIè¡¥å…¨å®Œæˆ"),o({title:"AIè¡¥å…¨å®Œæˆ",icon:"success"})}catch(t){console.error("âŒ AIè¡¥å…¨å¤±è´¥:",t),o({title:"AIè¡¥å…¨å¤±è´¥: "+(t.message||"æœªçŸ¥é”™è¯¯"),icon:"error",duration:3e3})}finally{this.isAiCompleting=!1}}}else o({title:"è¯·å…ˆè¾“å…¥ä¸€äº›å†…å®¹",icon:"none"})},acceptAiCompletion(){this.contentText=this.aiCompletedText,this.showAiDiff=!1,this.originalText="",this.aiCompletedText="",o({title:"å·²æ¥å—AIè¡¥å…¨",icon:"success"})},rejectAiCompletion(){this.showAiDiff=!1,this.originalText="",this.aiCompletedText="",o({title:"å·²æ‹’ç»AIè¡¥å…¨",icon:"none"})}}},[["render",function(e,o,t,n,r,a){const c=R,l=w,d=C,h=x;return f(),i(l,{class:"container"},{default:s(()=>[b(l,{class:"nav-header"},{default:s(()=>[b(l,{class:"back-btn",onClick:a.goBack},{default:s(()=>[b(c,{class:"back-icon"},{default:s(()=>[y("â†")]),_:1})]),_:1},8,["onClick"]),b(l,{class:"nav-title"},{default:s(()=>[y(k(r.chapterTitle),1)]),_:1}),b(l,{class:"save-btn",onClick:a.saveChapter},{default:s(()=>[b(c,{class:"save-text"},{default:s(()=>[y("ä¿å­˜")]),_:1})]),_:1},8,["onClick"])]),_:1}),b(l,{class:"content"},{default:s(()=>[b(l,{class:"prompts-section"},{default:s(()=>[b(l,{class:"prompts-card"},{default:s(()=>[b(l,{class:"prompts-title"},{default:s(()=>[y("å¼•å¯¼é—®é¢˜")]),_:1}),b(l,{class:"prompts-list"},{default:s(()=>[(f(!0),S(T,null,v(r.prompts,(e,o)=>(f(),i(l,{key:o,class:"prompt-item"},{default:s(()=>[b(l,{class:"prompt-number"},{default:s(()=>[y(k(o+1),1)]),_:2},1024),b(c,{class:"prompt-text"},{default:s(()=>[y(k(e),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1}),b(l,{class:"recording-section"},{default:s(()=>[b(l,{class:"recording-card"},{default:s(()=>[b(l,{class:"date-display"},{default:s(()=>[b(c,{class:"date-text"},{default:s(()=>[y(k(a.currentDate),1)]),_:1})]),_:1}),b(l,{class:"text-input-area"},{default:s(()=>[b(d,{class:"text-input",placeholder:"å¼€å§‹è®°å½•æ‚¨çš„å›å¿†...",value:r.contentText,onInput:a.onTextInput,"auto-height":"",maxlength:"5000"},null,8,["value","onInput"])]),_:1}),b(l,{class:"voice-control-area"},{default:s(()=>[b(l,{class:"control-buttons"},{default:s(()=>[b(l,{class:"record-btn-container"},{default:s(()=>[b(l,{class:P(["record-btn",{recording:r.isRecording,processing:r.isProcessing}]),onClick:a.toggleRecording},{default:s(()=>[b(l,{class:"record-icon"},{default:s(()=>[r.isRecording?(f(),i(l,{key:0,class:"recording-animation"},{default:s(()=>[(f(),S(T,null,v(3,e=>b(l,{class:"wave",key:e})),64))]),_:1})):(f(),i(h,{key:1,src:W,class:"mic-icon",mode:"aspectFit"}))]),_:1})]),_:1},8,["class","onClick"]),b(c,{class:"record-text"},{default:s(()=>[y(k(a.recordButtonText),1)]),_:1})]),_:1}),b(l,{class:"ai-complete-btn-container"},{default:s(()=>[b(l,{class:P(["ai-complete-btn",{processing:r.isAiCompleting}]),onClick:a.aiCompleteText},{default:s(()=>[b(l,{class:"ai-icon"},{default:s(()=>[r.isAiCompleting?(f(),i(l,{key:1,class:"ai-loading"},{default:s(()=>[(f(),S(T,null,v(3,e=>b(l,{class:"loading-dot",key:e})),64))]),_:1})):(f(),i(h,{key:0,src:I,class:"ai-icon-img",mode:"aspectFit"}))]),_:1})]),_:1},8,["class","onClick"]),b(c,{class:"ai-complete-text"},{default:s(()=>[y("AIè¡¥å…¨")]),_:1})]),_:1})]),_:1})]),_:1}),r.isRecording?(f(),i(l,{key:0,class:"recording-timer"},{default:s(()=>[b(c,{class:"timer-text"},{default:s(()=>[y(k(a.formatTime(r.recordingTime)),1)]),_:1})]),_:1})):A("",!0),r.showAiDiff?(f(),i(l,{key:1,class:"ai-diff-container"},{default:s(()=>[b(l,{class:"diff-header"},{default:s(()=>[b(c,{class:"diff-title"},{default:s(()=>[y("AIè¡¥å…¨ç»“æœ")]),_:1}),b(c,{class:"diff-subtitle"},{default:s(()=>[y("è¯·é€‰æ‹©æ˜¯å¦æ¥å—AIçš„ä¿®æ”¹")]),_:1})]),_:1}),b(l,{class:"diff-content"},{default:s(()=>[b(l,{class:"diff-ai"},{default:s(()=>[b(l,{class:"diff-label"},{default:s(()=>[y("AIè¡¥å…¨ç»“æœ")]),_:1}),b(l,{class:"diff-text ai-text"},{default:s(()=>[y(k(r.aiCompletedText),1)]),_:1})]),_:1})]),_:1}),b(l,{class:"diff-actions"},{default:s(()=>[b(l,{class:"diff-btn reject-btn",onClick:a.rejectAiCompletion},{default:s(()=>[b(h,{src:_,class:"btn-icon",mode:"aspectFit"})]),_:1},8,["onClick"]),b(l,{class:"diff-btn accept-btn",onClick:a.acceptAiCompletion},{default:s(()=>[b(h,{src:E,class:"btn-icon",mode:"aspectFit"})]),_:1},8,["onClick"])]),_:1})]),_:1})):A("",!0)]),_:1})]),_:1})]),_:1})]),_:1})}],["__scopeId","data-v-bbf7b085"]]);export{N as default};
