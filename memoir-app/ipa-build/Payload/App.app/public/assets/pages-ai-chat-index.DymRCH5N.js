import{c as e,w as a,r as t,g as s,A as o,v as r,x as n,u as i,q as c,i as l,o as h,a as d,b as m,I as u,M as g,d as f,t as p,e as C,S as I,k as y,B as w,F as N,l as T,m as b,h as M}from"./index-DQU_JAH0.js";import{a as _}from"./apiConfig.BpiTqs15.js";import{_ as P}from"./_plugin-vue_export-helper.BCo6x5W8.js";const k=P({data:()=>({characterInfo:{name:"å°å¿†",description:"æˆ‘æ˜¯å°å¿†ï¼Œä½ çš„AIå›å¿†å½•åŠ©æ‰‹ï¼Œå¯ä»¥é™ªä½ èŠå¤©ã€æ•´ç†å›å¿†å¹¶è®°å½•æ–°çš„æ•…äº‹ã€‚",avatar:"/src/images/default-avatar.png"},messages:[],inputText:"",isLoading:!1,scrollTop:0,userMemories:[],hasPersona:!1,isEditingName:!1,editingName:""}),async onLoad(){await this.loadCharacterInfo(),await this.loadUserMemories(),this.loadCustomCharacterName(),await this.preBuildCharacter(),await this.fetchGeneratedCharacterName(),this.addWelcomeMessage()},async onShow(){console.log("ğŸ”„ AIèŠå¤©é¡µé¢æ˜¾ç¤ºï¼Œé‡æ–°é¢„æ„å»ºè§’è‰²..."),await this.loadUserMemories(),await this.preBuildCharacter(),await this.fetchGeneratedCharacterName(),this.updateWelcomeMessage()},methods:{async loadCharacterInfo(){try{const e=s("token");if(console.log("ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œtoken:",e?"å­˜åœ¨":"ä¸å­˜åœ¨"),!e)return console.log("ç”¨æˆ·æœªç™»å½•ï¼Œä½¿ç”¨é»˜è®¤è§’è‰²ä¿¡æ¯"),this.characterInfo.name="å°å¿†",this.characterInfo.description=this.buildDefaultIntroduction(!1),void this.refreshCharacterPersona();console.log("ğŸ”„ å¼€å§‹è·å–ç”¨æˆ·ä¿¡æ¯...");const a=await t({url:_("/auth/me"),method:"GET",header:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(console.log("ğŸ“Š ç”¨æˆ·ä¿¡æ¯å“åº”:",a),200===a.statusCode&&a.data.success){const e=a.data.data.user;console.log("ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯:",e);const t=(e.nickname||"").trim(),s=(e.username||"").trim();let o=t;o&&"demo"!==o.toLowerCase()&&o!==s||(o="å°å¿†"),console.log("ğŸ“ è§’è‰²åç§°:",o),this.characterInfo.name=o,this.characterInfo.description=this.buildDefaultIntroduction(!0),this.refreshCharacterPersona(),console.log("âœ… è§’è‰²ä¿¡æ¯æ›´æ–°å®Œæˆ:",this.characterInfo)}else console.log("âŒ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è§’è‰²ä¿¡æ¯:",a.data),this.characterInfo.description=this.buildDefaultIntroduction(!0),this.refreshCharacterPersona()}catch(e){console.error("âŒ åŠ è½½è§’è‰²ä¿¡æ¯å¤±è´¥:",e),this.characterInfo.description=this.buildDefaultIntroduction(!0),this.refreshCharacterPersona()}},async loadUserMemories(){try{const e=s("token");if(!e)return console.log("ç”¨æˆ·æœªç™»å½•"),void this.refreshCharacterPersona();const a=await t({url:_("/ai/memories"),method:"GET",header:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(200===a.statusCode&&a.data.success){const e=a.data.data.memories||[];this.userMemories=e,this.refreshCharacterPersona()}}catch(e){console.error("åŠ è½½ç”¨æˆ·è®°å¿†å¤±è´¥:",e),this.refreshCharacterPersona()}},buildDefaultIntroduction(e){const a=this.characterInfo.name||"å°å¿†";return e?`æˆ‘æ˜¯${a}ï¼Œä½ çš„AIå›å¿†å½•åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®ä½ æ¢³ç†å·²ç»è®°å½•çš„ç« èŠ‚ã€æ•´ç†éšè®°å†…å®¹ï¼Œè¿˜èƒ½é™ªä½ èŠå¤©ï¼Œç»§ç»­æ¢ç´¢æ–°çš„æ•…äº‹ã€‚`:`æˆ‘æ˜¯${a}ï¼Œä½ çš„AIå›å¿†å½•åŠ©æ‰‹ï¼Œå¯ä»¥æŒ‡å¯¼ä½ å¦‚ä½•è®°å½•äººç”Ÿç‚¹æ»´ï¼Œæ•´ç†å›å¿†ï¼Œå¹¶é™ªä½ è½»æ¾èŠå¤©ã€‚`},buildPersonaIntroduction(){const e=this.characterInfo.name||"å°å¿†";if(!this.userMemories||0===this.userMemories.length)return this.buildDefaultIntroduction(!0);const a=this.userMemories.length,t=this.userMemories.filter(e=>"éšè®°"===e.type).length,s=[];a-t>0&&s.push("è®°å½•ä¸‹æ¥çš„é‚£äº›ç« èŠ‚æ•…äº‹"),t>0&&s.push("æ—¥å¸¸éšè®°é‡Œçš„ç‚¹æ»´");return`æˆ‘æ˜¯${e}ï¼Œæ ¹æ®ä½ çš„å›å¿†å½•æ‰“é€ çš„AIä¼™ä¼´ã€‚æˆ‘çè—ç€${s.length?s.join("å’Œ"):"å›å¿†å½•é‡Œçš„æ•…äº‹"}ï¼Œéšæ—¶å¯ä»¥å’Œä½ èŠèŠè¿™äº›ç»å†ï¼Œæˆ–ç»§ç»­è®°å½•æ–°çš„ç¯‡ç« ã€‚`},refreshCharacterPersona(){const e=!!s("token"),a=e&&this.userMemories&&this.userMemories.length>0;this.hasPersona=a,this.characterInfo.description=e?a?this.buildPersonaIntroduction():this.buildDefaultIntroduction(!0):this.buildDefaultIntroduction(!1),this.updateWelcomeMessage()},async fetchGeneratedCharacterName(){var e;try{const a=s("token");if(!a)return;if(s("manualCharacterName"))return;const o=await t({url:_("/ai/character-name"),method:"POST",header:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});if(200===o.statusCode&&o.data.success){const{characterName:e}=o.data.data,a=s("autoCharacterName");if(e&&e!==a){console.log("ğŸ­ è‡ªåŠ¨è¯†åˆ«è§’è‰²å§“å:",e),this.characterInfo.name=e,this.refreshCharacterPersona(),i("autoCharacterName",e);const a=s("user");a&&(a.nickname=e,i("user",a)),o.data.data.updatedProfile&&console.log("ğŸ”„ ç”¨æˆ·æ˜µç§°å·²åŒæ­¥æ›´æ–°ä¸º:",e)}}else console.log("âš ï¸ è§’è‰²å§“åè¯†åˆ«å¤±è´¥:",null==(e=o.data)?void 0:e.message)}catch(a){console.error("è‡ªåŠ¨ç”Ÿæˆè§’è‰²å§“åå¤±è´¥:",a)}},buildWelcomeMessageText(){const e=s("token"),a=this.characterInfo.description||this.buildDefaultIntroduction(!!e);return e?this.hasPersona?`ä½ å¥½ï¼${a}æƒ³å’Œæˆ‘èŠèŠè¿™äº›æ•…äº‹ï¼Œæˆ–è€…ç»§ç»­è®°å½•æ–°çš„ç¯‡ç« å—ï¼Ÿ`:`ä½ å¥½ï¼${a}å¦‚æœä½ å·²ç»å‡†å¤‡å¥½å¼€å§‹è®°å½•æˆ–æé—®ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ã€‚`:`ä½ å¥½ï¼${a}å¦‚æœä½ æƒ³ä½“éªŒå®Œæ•´çš„ä¸ªæ€§åŒ–èŠå¤©åŠŸèƒ½ï¼Œå¯ä»¥ç™»å½•å¹¶å¼€å§‹è®°å½•ä½ çš„å›å¿†ã€‚`},formatDate(e){if(!e)return"";const a=new Date(e);return Number.isNaN(a.getTime())?"":`${a.getFullYear()}å¹´${a.getMonth()+1}æœˆ${a.getDate()}æ—¥`},async sendMessage(){if(!this.inputText.trim()||this.isLoading)return;const e={type:"user",content:this.inputText.trim(),timestamp:new Date};this.messages.push(e);const a=this.inputText.trim();this.inputText="",this.isLoading=!0,this.scrollToBottom();const t={type:"ai",content:"",timestamp:new Date};this.messages.push(t);const s=this.messages.length-1;try{await this.streamChat(a,s)}catch(o){console.error("AIèŠå¤©å¤±è´¥:",o),this.messages[s].content="æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚"}finally{this.isLoading=!1,this.scrollToBottom()}},async streamChat(e,a){const o=s("token");if(!o)return await this.guestChat(e,a);try{const s=await t({url:_("/ai/chat"),method:"POST",header:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},data:{message:e,stream:!1}});if(200!==s.statusCode||!s.data.success)throw console.error("AIèŠå¤©å“åº”é”™è¯¯:",s.data),new Error(s.data.message||"è¯·æ±‚å¤±è´¥");{const e=s.data.data.response||"æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ã€‚";console.log("AIå›å¤å†…å®¹:",e),this.handleStreamResponse(e,a)}}catch(r){throw console.error("AIèŠå¤©è¯·æ±‚å¤±è´¥:",r),r}},handleStreamResponse(e,a){console.log("å¼€å§‹æ‰“å­—æœºæ•ˆæœï¼Œå†…å®¹é•¿åº¦:",e.length),console.log("AIå›å¤å†…å®¹é¢„è§ˆ:",e.substring(0,100)+"...");const t=e=>{this.messages.splice(a,1,{...this.messages[a],content:e})};t("");let s=0;const o=()=>{if(s<e.length){const a=e.substring(0,s+1);t(a),s++,this.scrollToBottom(),setTimeout(o,30)}else console.log("æ‰“å­—æœºæ•ˆæœå®Œæˆï¼Œæœ€ç»ˆå†…å®¹é•¿åº¦:",this.messages[a].content.length)};o()},buildContext(e){const a=this.userMemories.filter(a=>{const t=(a.content||"").toLowerCase(),s=(a.title||"").toLowerCase(),o=e.toLowerCase();return t.includes(o)||s.includes(o)});return{character:this.characterInfo.name,memories:a.slice(0,5),totalMemories:this.userMemories.length}},scrollToBottom(){this.$nextTick(()=>{this.scrollTop=99999})},formatTime(e){const a=new Date,t=new Date(e),s=a-t;return s<6e4?"åˆšåˆš":s<36e5?Math.floor(s/6e4)+"åˆ†é’Ÿå‰":s<864e5?Math.floor(s/36e5)+"å°æ—¶å‰":t.toLocaleDateString()},toggleEditName(){this.isEditingName?this.saveCharacterName():(this.isEditingName=!0,this.editingName=this.characterInfo.name,this.$nextTick(()=>{const e=document.querySelector(".character-name-input");e&&(e.focus(),e.select())}))},async saveCharacterName(){if(this.isEditingName){const a=this.editingName.trim();if(a&&a!==this.characterInfo.name)try{r({title:"ä¿å­˜ä¸­..."});const e=s("token");if(!e)throw new Error("ç”¨æˆ·æœªç™»å½•");const l=await t({url:_("/auth/profile"),method:"PUT",header:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},data:{nickname:a}});if(n(),200!==l.statusCode||!l.data.success)throw new Error(l.data.message||"ä¿å­˜å¤±è´¥");{this.characterInfo.name=a,this.refreshCharacterPersona();const e=l.data.data.user;i("user",e),i("manualCharacterName",a),o("autoCharacterName"),console.log("âœ… è§’è‰²åç§°å·²æ›´æ–°åˆ°æ•°æ®åº“:",a),this.updateWelcomeMessage(),c({title:"ä¿å­˜æˆåŠŸ",icon:"success"})}}catch(e){n(),console.error("ä¿å­˜è§’è‰²åç§°å¤±è´¥:",e),c({title:e.message||"ä¿å­˜å¤±è´¥",icon:"none"})}this.isEditingName=!1,this.editingName=""}},loadCustomCharacterName(){s("customCharacterName")&&o("customCharacterName");const e=s("manualCharacterName");if(e){const a=e.trim();if(a&&"demo"!==a.toLowerCase()&&"å°å¿†"!==a)return this.characterInfo.name=a,console.log("ğŸ“ ä½¿ç”¨æ‰‹åŠ¨è®¾ç½®çš„è§’è‰²åç§°:",a),void this.refreshCharacterPersona();o("manualCharacterName")}const a=s("autoCharacterName");a&&(this.characterInfo.name=a,console.log("ğŸ“ ä½¿ç”¨è‡ªåŠ¨è¯†åˆ«çš„è§’è‰²åç§°:",a),this.refreshCharacterPersona())},async preBuildCharacter(){try{const e=s("token");if(!e)return void console.log("ç”¨æˆ·æœªç™»å½•ï¼Œè·³è¿‡è§’è‰²é¢„æ„å»º");console.log("å¼€å§‹é¢„æ„å»ºAIè§’è‰²...");const a=await t({url:_("/ai/prebuild"),method:"POST",header:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});200===a.statusCode&&a.data.success?(console.log("âœ… AIè§’è‰²é¢„æ„å»ºæˆåŠŸï¼Œè®°å¿†æ•°é‡:",a.data.data.memoryCount),this.hasPersona=(a.data.data.memoryCount||0)>0,this.refreshCharacterPersona()):(console.log("âš ï¸ AIè§’è‰²é¢„æ„å»ºå¤±è´¥ï¼Œå°†ä½¿ç”¨å®æ—¶æ„å»º"),this.refreshCharacterPersona())}catch(e){console.error("é¢„æ„å»ºAIè§’è‰²å¤±è´¥:",e),this.refreshCharacterPersona()}},addWelcomeMessage(){0===this.messages.length&&this.messages.push({type:"ai",content:this.buildWelcomeMessageText(),timestamp:new Date})},updateWelcomeMessage(){if(this.messages.length>0){const e=this.messages[0];"ai"===e.type&&(e.content=this.buildWelcomeMessageText())}},async guestChat(e,a){try{const s=await t({url:_("/ai/guest-chat"),method:"POST",header:{"Content-Type":"application/json"},data:{message:e,stream:!1}});if(200!==s.statusCode||!s.data.success)throw console.error("AIèŠå¤©å“åº”é”™è¯¯:",s.data),new Error(s.data.message||"è¯·æ±‚å¤±è´¥");{const e=s.data.data.response||"æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ã€‚";console.log("AIå›å¤å†…å®¹:",e),this.handleStreamResponse(e,a)}}catch(s){throw console.error("AIèŠå¤©è¯·æ±‚å¤±è´¥:",s),s}}}},[["render",function(t,s,o,r,n,i){const c=m,_=l,P=u,k=C,A=I,v=M;return h(),e(_,{class:"ai-chat-container"},{default:a(()=>[d(_,{class:"character-card"},{default:a(()=>[d(_,{class:"character-avatar"},{default:a(()=>[d(c,{src:n.characterInfo.avatar,class:"avatar-image",mode:"aspectFill"},null,8,["src"])]),_:1}),d(_,{class:"character-info"},{default:a(()=>[d(_,{class:"character-name-container"},{default:a(()=>[n.isEditingName?(h(),e(P,{key:0,modelValue:n.editingName,"onUpdate:modelValue":s[0]||(s[0]=e=>n.editingName=e),class:"character-name-input",onBlur:i.saveCharacterName,onConfirm:i.saveCharacterName,onKeyup:g(i.saveCharacterName,["enter"]),placeholder:n.characterInfo.name},null,8,["modelValue","onBlur","onConfirm","onKeyup","placeholder"])):(h(),e(_,{key:1,class:"character-name"},{default:a(()=>[f(p(n.characterInfo.name),1)]),_:1})),d(_,{class:"edit-name-btn",onClick:i.toggleEditName},{default:a(()=>[n.isEditingName?(h(),e(k,{key:1,class:"edit-icon"},{default:a(()=>[f("âœ“")]),_:1})):(h(),e(c,{key:0,src:"/static/icons/edit.svg",class:"edit-icon",mode:"aspectFit"}))]),_:1},8,["onClick"])]),_:1}),d(_,{class:"character-desc"},{default:a(()=>[f(p(n.characterInfo.description),1)]),_:1})]),_:1})]),_:1}),d(_,{class:"chat-area"},{default:a(()=>[d(A,{class:"message-list","scroll-y":"true","scroll-top":n.scrollTop,"scroll-with-animation":"true"},{default:a(()=>[(h(!0),y(N,null,T(n.messages,(t,s)=>(h(),e(_,{key:s,class:b(["message-item",t.type])},{default:a(()=>[d(_,{class:"message-content"},{default:a(()=>[d(_,{class:"message-bubble"},{default:a(()=>[d(k,{class:"message-text"},{default:a(()=>[f(p(t.content),1)]),_:2},1024)]),_:2},1024),d(_,{class:"message-time"},{default:a(()=>[f(p(i.formatTime(t.timestamp)),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["class"]))),128)),n.isLoading?(h(),e(_,{key:0,class:"message-item ai"},{default:a(()=>[d(_,{class:"message-content"},{default:a(()=>[d(_,{class:"message-bubble loading"},{default:a(()=>[d(_,{class:"typing-indicator"},{default:a(()=>[d(_,{class:"dot"}),d(_,{class:"dot"}),d(_,{class:"dot"})]),_:1})]),_:1})]),_:1})]),_:1})):w("",!0)]),_:1},8,["scroll-top"])]),_:1}),d(_,{class:"input-area"},{default:a(()=>[d(_,{class:"input-container"},{default:a(()=>[d(P,{modelValue:n.inputText,"onUpdate:modelValue":s[1]||(s[1]=e=>n.inputText=e),class:"message-input",placeholder:`ä¸${n.characterInfo.name}èŠå¤©...`,disabled:n.isLoading,onConfirm:i.sendMessage},null,8,["modelValue","placeholder","disabled","onConfirm"]),d(v,{class:b(["send-button",{disabled:!n.inputText.trim()||n.isLoading}]),onClick:i.sendMessage,disabled:!n.inputText.trim()||n.isLoading},{default:a(()=>[f(" å‘é€ ")]),_:1},8,["class","onClick","disabled"])]),_:1})]),_:1})]),_:1})}],["__scopeId","data-v-aba2b748"]]);export{k as default};
