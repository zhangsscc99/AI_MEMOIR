import{c as e,w as a,r as t,g as s,A as o,v as r,x as n,u as i,q as c,i as l,o as h,a as d,b as m,I as u,M as g,d as f,t as p,e as C,S as I,k as y,B as w,F as N,l as T,m as b,h as M}from"./index-DQU_JAH0.js";import{a as _}from"./apiConfig.BpiTqs15.js";import{_ as P}from"./_plugin-vue_export-helper.BCo6x5W8.js";const k=P({data:()=>({characterInfo:{name:"小忆",description:"我是小忆，你的AI回忆录助手，可以陪你聊天、整理回忆并记录新的故事。",avatar:"/src/images/default-avatar.png"},messages:[],inputText:"",isLoading:!1,scrollTop:0,userMemories:[],hasPersona:!1,isEditingName:!1,editingName:""}),async onLoad(){await this.loadCharacterInfo(),await this.loadUserMemories(),this.loadCustomCharacterName(),await this.preBuildCharacter(),await this.fetchGeneratedCharacterName(),this.addWelcomeMessage()},async onShow(){console.log("🔄 AI聊天页面显示，重新预构建角色..."),await this.loadUserMemories(),await this.preBuildCharacter(),await this.fetchGeneratedCharacterName(),this.updateWelcomeMessage()},methods:{async loadCharacterInfo(){try{const e=s("token");if(console.log("🔍 检查登录状态，token:",e?"存在":"不存在"),!e)return console.log("用户未登录，使用默认角色信息"),this.characterInfo.name="小忆",this.characterInfo.description=this.buildDefaultIntroduction(!1),void this.refreshCharacterPersona();console.log("🔄 开始获取用户信息...");const a=await t({url:_("/auth/me"),method:"GET",header:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(console.log("📊 用户信息响应:",a),200===a.statusCode&&a.data.success){const e=a.data.data.user;console.log("👤 用户信息:",e);const t=(e.nickname||"").trim(),s=(e.username||"").trim();let o=t;o&&"demo"!==o.toLowerCase()&&o!==s||(o="小忆"),console.log("📝 角色名称:",o),this.characterInfo.name=o,this.characterInfo.description=this.buildDefaultIntroduction(!0),this.refreshCharacterPersona(),console.log("✅ 角色信息更新完成:",this.characterInfo)}else console.log("❌ 获取用户信息失败，使用默认角色信息:",a.data),this.characterInfo.description=this.buildDefaultIntroduction(!0),this.refreshCharacterPersona()}catch(e){console.error("❌ 加载角色信息失败:",e),this.characterInfo.description=this.buildDefaultIntroduction(!0),this.refreshCharacterPersona()}},async loadUserMemories(){try{const e=s("token");if(!e)return console.log("用户未登录"),void this.refreshCharacterPersona();const a=await t({url:_("/ai/memories"),method:"GET",header:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(200===a.statusCode&&a.data.success){const e=a.data.data.memories||[];this.userMemories=e,this.refreshCharacterPersona()}}catch(e){console.error("加载用户记忆失败:",e),this.refreshCharacterPersona()}},buildDefaultIntroduction(e){const a=this.characterInfo.name||"小忆";return e?`我是${a}，你的AI回忆录助手。我可以帮你梳理已经记录的章节、整理随记内容，还能陪你聊天，继续探索新的故事。`:`我是${a}，你的AI回忆录助手，可以指导你如何记录人生点滴，整理回忆，并陪你轻松聊天。`},buildPersonaIntroduction(){const e=this.characterInfo.name||"小忆";if(!this.userMemories||0===this.userMemories.length)return this.buildDefaultIntroduction(!0);const a=this.userMemories.length,t=this.userMemories.filter(e=>"随记"===e.type).length,s=[];a-t>0&&s.push("记录下来的那些章节故事"),t>0&&s.push("日常随记里的点滴");return`我是${e}，根据你的回忆录打造的AI伙伴。我珍藏着${s.length?s.join("和"):"回忆录里的故事"}，随时可以和你聊聊这些经历，或继续记录新的篇章。`},refreshCharacterPersona(){const e=!!s("token"),a=e&&this.userMemories&&this.userMemories.length>0;this.hasPersona=a,this.characterInfo.description=e?a?this.buildPersonaIntroduction():this.buildDefaultIntroduction(!0):this.buildDefaultIntroduction(!1),this.updateWelcomeMessage()},async fetchGeneratedCharacterName(){var e;try{const a=s("token");if(!a)return;if(s("manualCharacterName"))return;const o=await t({url:_("/ai/character-name"),method:"POST",header:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});if(200===o.statusCode&&o.data.success){const{characterName:e}=o.data.data,a=s("autoCharacterName");if(e&&e!==a){console.log("🎭 自动识别角色姓名:",e),this.characterInfo.name=e,this.refreshCharacterPersona(),i("autoCharacterName",e);const a=s("user");a&&(a.nickname=e,i("user",a)),o.data.data.updatedProfile&&console.log("🔄 用户昵称已同步更新为:",e)}}else console.log("⚠️ 角色姓名识别失败:",null==(e=o.data)?void 0:e.message)}catch(a){console.error("自动生成角色姓名失败:",a)}},buildWelcomeMessageText(){const e=s("token"),a=this.characterInfo.description||this.buildDefaultIntroduction(!!e);return e?this.hasPersona?`你好！${a}想和我聊聊这些故事，或者继续记录新的篇章吗？`:`你好！${a}如果你已经准备好开始记录或提问，随时告诉我。`:`你好！${a}如果你想体验完整的个性化聊天功能，可以登录并开始记录你的回忆。`},formatDate(e){if(!e)return"";const a=new Date(e);return Number.isNaN(a.getTime())?"":`${a.getFullYear()}年${a.getMonth()+1}月${a.getDate()}日`},async sendMessage(){if(!this.inputText.trim()||this.isLoading)return;const e={type:"user",content:this.inputText.trim(),timestamp:new Date};this.messages.push(e);const a=this.inputText.trim();this.inputText="",this.isLoading=!0,this.scrollToBottom();const t={type:"ai",content:"",timestamp:new Date};this.messages.push(t);const s=this.messages.length-1;try{await this.streamChat(a,s)}catch(o){console.error("AI聊天失败:",o),this.messages[s].content="抱歉，我现在无法回答您的问题，请稍后再试。"}finally{this.isLoading=!1,this.scrollToBottom()}},async streamChat(e,a){const o=s("token");if(!o)return await this.guestChat(e,a);try{const s=await t({url:_("/ai/chat"),method:"POST",header:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},data:{message:e,stream:!1}});if(200!==s.statusCode||!s.data.success)throw console.error("AI聊天响应错误:",s.data),new Error(s.data.message||"请求失败");{const e=s.data.data.response||"抱歉，我现在无法回答您的问题。";console.log("AI回复内容:",e),this.handleStreamResponse(e,a)}}catch(r){throw console.error("AI聊天请求失败:",r),r}},handleStreamResponse(e,a){console.log("开始打字机效果，内容长度:",e.length),console.log("AI回复内容预览:",e.substring(0,100)+"...");const t=e=>{this.messages.splice(a,1,{...this.messages[a],content:e})};t("");let s=0;const o=()=>{if(s<e.length){const a=e.substring(0,s+1);t(a),s++,this.scrollToBottom(),setTimeout(o,30)}else console.log("打字机效果完成，最终内容长度:",this.messages[a].content.length)};o()},buildContext(e){const a=this.userMemories.filter(a=>{const t=(a.content||"").toLowerCase(),s=(a.title||"").toLowerCase(),o=e.toLowerCase();return t.includes(o)||s.includes(o)});return{character:this.characterInfo.name,memories:a.slice(0,5),totalMemories:this.userMemories.length}},scrollToBottom(){this.$nextTick(()=>{this.scrollTop=99999})},formatTime(e){const a=new Date,t=new Date(e),s=a-t;return s<6e4?"刚刚":s<36e5?Math.floor(s/6e4)+"分钟前":s<864e5?Math.floor(s/36e5)+"小时前":t.toLocaleDateString()},toggleEditName(){this.isEditingName?this.saveCharacterName():(this.isEditingName=!0,this.editingName=this.characterInfo.name,this.$nextTick(()=>{const e=document.querySelector(".character-name-input");e&&(e.focus(),e.select())}))},async saveCharacterName(){if(this.isEditingName){const a=this.editingName.trim();if(a&&a!==this.characterInfo.name)try{r({title:"保存中..."});const e=s("token");if(!e)throw new Error("用户未登录");const l=await t({url:_("/auth/profile"),method:"PUT",header:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},data:{nickname:a}});if(n(),200!==l.statusCode||!l.data.success)throw new Error(l.data.message||"保存失败");{this.characterInfo.name=a,this.refreshCharacterPersona();const e=l.data.data.user;i("user",e),i("manualCharacterName",a),o("autoCharacterName"),console.log("✅ 角色名称已更新到数据库:",a),this.updateWelcomeMessage(),c({title:"保存成功",icon:"success"})}}catch(e){n(),console.error("保存角色名称失败:",e),c({title:e.message||"保存失败",icon:"none"})}this.isEditingName=!1,this.editingName=""}},loadCustomCharacterName(){s("customCharacterName")&&o("customCharacterName");const e=s("manualCharacterName");if(e){const a=e.trim();if(a&&"demo"!==a.toLowerCase()&&"小忆"!==a)return this.characterInfo.name=a,console.log("📝 使用手动设置的角色名称:",a),void this.refreshCharacterPersona();o("manualCharacterName")}const a=s("autoCharacterName");a&&(this.characterInfo.name=a,console.log("📝 使用自动识别的角色名称:",a),this.refreshCharacterPersona())},async preBuildCharacter(){try{const e=s("token");if(!e)return void console.log("用户未登录，跳过角色预构建");console.log("开始预构建AI角色...");const a=await t({url:_("/ai/prebuild"),method:"POST",header:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});200===a.statusCode&&a.data.success?(console.log("✅ AI角色预构建成功，记忆数量:",a.data.data.memoryCount),this.hasPersona=(a.data.data.memoryCount||0)>0,this.refreshCharacterPersona()):(console.log("⚠️ AI角色预构建失败，将使用实时构建"),this.refreshCharacterPersona())}catch(e){console.error("预构建AI角色失败:",e),this.refreshCharacterPersona()}},addWelcomeMessage(){0===this.messages.length&&this.messages.push({type:"ai",content:this.buildWelcomeMessageText(),timestamp:new Date})},updateWelcomeMessage(){if(this.messages.length>0){const e=this.messages[0];"ai"===e.type&&(e.content=this.buildWelcomeMessageText())}},async guestChat(e,a){try{const s=await t({url:_("/ai/guest-chat"),method:"POST",header:{"Content-Type":"application/json"},data:{message:e,stream:!1}});if(200!==s.statusCode||!s.data.success)throw console.error("AI聊天响应错误:",s.data),new Error(s.data.message||"请求失败");{const e=s.data.data.response||"抱歉，我现在无法回答您的问题。";console.log("AI回复内容:",e),this.handleStreamResponse(e,a)}}catch(s){throw console.error("AI聊天请求失败:",s),s}}}},[["render",function(t,s,o,r,n,i){const c=m,_=l,P=u,k=C,A=I,v=M;return h(),e(_,{class:"ai-chat-container"},{default:a(()=>[d(_,{class:"character-card"},{default:a(()=>[d(_,{class:"character-avatar"},{default:a(()=>[d(c,{src:n.characterInfo.avatar,class:"avatar-image",mode:"aspectFill"},null,8,["src"])]),_:1}),d(_,{class:"character-info"},{default:a(()=>[d(_,{class:"character-name-container"},{default:a(()=>[n.isEditingName?(h(),e(P,{key:0,modelValue:n.editingName,"onUpdate:modelValue":s[0]||(s[0]=e=>n.editingName=e),class:"character-name-input",onBlur:i.saveCharacterName,onConfirm:i.saveCharacterName,onKeyup:g(i.saveCharacterName,["enter"]),placeholder:n.characterInfo.name},null,8,["modelValue","onBlur","onConfirm","onKeyup","placeholder"])):(h(),e(_,{key:1,class:"character-name"},{default:a(()=>[f(p(n.characterInfo.name),1)]),_:1})),d(_,{class:"edit-name-btn",onClick:i.toggleEditName},{default:a(()=>[n.isEditingName?(h(),e(k,{key:1,class:"edit-icon"},{default:a(()=>[f("✓")]),_:1})):(h(),e(c,{key:0,src:"/static/icons/edit.svg",class:"edit-icon",mode:"aspectFit"}))]),_:1},8,["onClick"])]),_:1}),d(_,{class:"character-desc"},{default:a(()=>[f(p(n.characterInfo.description),1)]),_:1})]),_:1})]),_:1}),d(_,{class:"chat-area"},{default:a(()=>[d(A,{class:"message-list","scroll-y":"true","scroll-top":n.scrollTop,"scroll-with-animation":"true"},{default:a(()=>[(h(!0),y(N,null,T(n.messages,(t,s)=>(h(),e(_,{key:s,class:b(["message-item",t.type])},{default:a(()=>[d(_,{class:"message-content"},{default:a(()=>[d(_,{class:"message-bubble"},{default:a(()=>[d(k,{class:"message-text"},{default:a(()=>[f(p(t.content),1)]),_:2},1024)]),_:2},1024),d(_,{class:"message-time"},{default:a(()=>[f(p(i.formatTime(t.timestamp)),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["class"]))),128)),n.isLoading?(h(),e(_,{key:0,class:"message-item ai"},{default:a(()=>[d(_,{class:"message-content"},{default:a(()=>[d(_,{class:"message-bubble loading"},{default:a(()=>[d(_,{class:"typing-indicator"},{default:a(()=>[d(_,{class:"dot"}),d(_,{class:"dot"}),d(_,{class:"dot"})]),_:1})]),_:1})]),_:1})]),_:1})):w("",!0)]),_:1},8,["scroll-top"])]),_:1}),d(_,{class:"input-area"},{default:a(()=>[d(_,{class:"input-container"},{default:a(()=>[d(P,{modelValue:n.inputText,"onUpdate:modelValue":s[1]||(s[1]=e=>n.inputText=e),class:"message-input",placeholder:`与${n.characterInfo.name}聊天...`,disabled:n.isLoading,onConfirm:i.sendMessage},null,8,["modelValue","placeholder","disabled","onConfirm"]),d(v,{class:b(["send-button",{disabled:!n.inputText.trim()||n.isLoading}]),onClick:i.sendMessage,disabled:!n.inputText.trim()||n.isLoading},{default:a(()=>[f(" 发送 ")]),_:1},8,["class","onClick","disabled"])]),_:1})]),_:1})]),_:1})}],["__scopeId","data-v-aba2b748"]]);export{k as default};
