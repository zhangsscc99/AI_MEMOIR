import{c as e,w as a,q as t,g as s,u as i,v as r,x as o,r as l,y as c,n as d,z as n,A as u,i as g,o as m,a as h,d as p,j as y,k as f,B as D,F as _,l as I,b as k,t as $,C as b,h as w,e as C}from"./index-DQU_JAH0.js";import{a as v}from"./apiConfig.BpiTqs15.js";import{g as F}from"./imageMapping.mDgfjL7P.js";import{_ as j}from"./_plugin-vue_export-helper.BCo6x5W8.js";const x=j({data:()=>({diaries:[]}),onShow(){this.loadDiaries()},methods:{getOptimalImagePath:F,async loadDiaries(){try{console.log("🔄 开始加载随记数据...");const e=s("user"),a=null==e?void 0:e.id;a&&(u(`diaries_${a}`),u(`currentDiary_${a}`)),u("diaries"),u("currentDiary");const t=s("token");if(!t){console.log("❌ 未登录，使用本地存储数据");const e=a?s(`diaries_${a}`)||[]:s("diaries")||[];return void(this.diaries=e)}const i=await l({url:v("/chapters"),method:"GET",header:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(console.log("📊 后端章节响应:",i),console.log("📊 响应数据详情:",i.data),200===i.statusCode&&i.data.success){const e=i.data.data||{};console.log("📊 原始数据类型:",typeof e,"是否为数组:",Array.isArray(e)),console.log("📊 原始数据内容:",e);const a=(e.chapters||[]).filter(e=>e.chapterId&&e.chapterId.startsWith("diary_"));console.log("📖 过滤出的diary章节:",a),this.diaries=a.map(e=>({id:e.id,chapterId:e.chapterId,title:e.title||"无标题随记",content:e.content||"",image:e.backgroundImage&&!e.backgroundImage.startsWith("blob:")?e.backgroundImage.startsWith("http")?e.backgroundImage:F(e.backgroundImage):"/src/images/default-diary.svg",createTime:e.updatedAt||e.createdAt,chapterData:e}));const t=this.getDefaultDiaries();console.log("🦁 添加样板案例:",t),this.diaries=this.diaries.concat(t),console.log("✅ 随记数据加载完成，总数:",this.diaries.length,"数据:",this.diaries)}else{console.log("❌ 获取随记失败，使用本地存储数据:",i.data);const e=a?s(`diaries_${a}`)||[]:s("diaries")||[];this.diaries=e.concat(this.getDefaultDiaries())}}catch(e){console.error("❌ 加载随记出错，使用本地存储数据:",e);const a=userId?s(`diaries_${userId}`)||[]:s("diaries")||[];this.diaries=a.concat(this.getDefaultDiaries())}},getDefaultDiaries:()=>[{id:"sample_diary_1",title:"春节舞狮子",content:"舞狮子是中国传统民间艺术，在春节期间尤为盛行。狮子象征着威武和吉祥，舞狮表演寓意驱邪避害、祈求平安。表演者需要配合默契，通过精湛的技艺展现狮子的威武和灵动，为节日增添喜庆氛围。",image:F("/src/images/lion.png"),createTime:(new Date).toISOString(),chapterData:{chapterId:"sample_diary_1",title:"春节舞狮子",content:"舞狮子是中国传统民间艺术，在春节期间尤为盛行。狮子象征着威武和吉祥，舞狮表演寓意驱邪避害、祈求平安。表演者需要配合默契，通过精湛的技艺展现狮子的威武和灵动，为节日增添喜庆氛围。",backgroundImage:F("/src/images/lion.png"),status:"completed"}}],addNewDiary(){d({url:"/pages/diary/edit"})},viewDiary(e){console.log("查看随记:",e);const a=s("user"),t=null==a?void 0:a.id;t&&i(`currentDiary_${t}`,e),i("currentDiary",e),d({url:`/pages/diary/edit?chapterId=${e.chapterId}&title=${encodeURIComponent(e.title)}&mode=view`})},showDiaryMenu(e){n({itemList:["编辑","删除","分享"],success:a=>{switch(a.tapIndex){case 0:this.editDiary(e);break;case 1:this.deleteDiary(e);break;case 2:this.shareDiary(e)}}})},editDiary(e){console.log("编辑随记:",e);const a=s("user"),t=null==a?void 0:a.id;t&&i(`currentDiary_${t}`,e),i("currentDiary",e),d({url:`/pages/diary/edit?chapterId=${e.chapterId}&title=${encodeURIComponent(e.title)}&mode=edit`})},deleteDiary(e){c({title:"确认删除",content:"确定要删除这条随记吗？",success:a=>{a.confirm&&this.performDelete(e)}})},async performDelete(e){if(e.id.startsWith("sample_"))this.deleteFromLocal(e);else try{r({title:"删除中..."});const a=s("token");if(!a)return o(),void t({title:"请先登录",icon:"error"});const i=await l({url:v(`/chapters/${e.id}`),method:"DELETE",header:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});o(),200===i.statusCode&&i.data.success?(this.loadDiaries(),t({title:"删除成功",icon:"success"})):(console.log("后端删除失败，尝试本地删除:",i.data),this.deleteFromLocal(e))}catch(a){console.error("删除随记出错:",a),o(),c({title:"网络错误",content:"无法连接到服务器，是否仅从本地删除？",success:a=>{a.confirm&&this.deleteFromLocal(e)}})}},deleteFromLocal(e){try{const a=s("user"),r=null==a?void 0:a.id,o=r?s(`diaries_${r}`)||[]:s("diaries")||[],l=o.findIndex(a=>a.id===e.id);l>-1&&(o.splice(l,1),r&&i(`diaries_${r}`,o),i("diaries",o),this.loadDiaries(),t({title:"本地删除成功",icon:"success"}))}catch(a){console.error("本地删除失败:",a),t({title:"删除失败",icon:"error"})}},shareDiary(e){t({title:"分享功能开发中",icon:"none"})},formatDate(e){const a=new Date(e);return`${a.getFullYear()}/${(a.getMonth()+1).toString().padStart(2,"0")}/${a.getDate().toString().padStart(2,"0")}`}}},[["render",function(t,s,i,r,o,l){const c=g,d=k,n=C,u=w;return m(),e(c,{class:"container"},{default:a(()=>[h(c,{class:"page-header"},{default:a(()=>[h(c,{class:"page-title"},{default:a(()=>[p("随记")]),_:1}),h(c,{class:"page-subtitle"},{default:a(()=>[p("记录照片里的故事，随手写下生活点滴。"),y("br"),p("轻松导入回忆录")]),_:1})]),_:1}),h(c,{class:"diary-list"},{default:a(()=>[(m(!0),f(_,null,I(o.diaries,t=>(m(),e(c,{class:"diary-item",key:t.id,onClick:e=>l.viewDiary(t)},{default:a(()=>[h(d,{src:l.getOptimalImagePath(t.image||"/src/images/lion.png"),class:"diary-image",mode:"aspectFill"},null,8,["src"]),h(c,{class:"diary-content"},{default:a(()=>[h(c,{class:"diary-title"},{default:a(()=>[p($(t.title),1)]),_:2},1024),h(c,{class:"diary-date"},{default:a(()=>[p($(l.formatDate(t.createTime)),1)]),_:2},1024)]),_:2},1024),h(c,{class:"diary-menu",onClick:b(e=>l.showDiaryMenu(t),["stop"])},{default:a(()=>[h(c,{class:"menu-dot"}),h(c,{class:"menu-dot"}),h(c,{class:"menu-dot"})]),_:2},1032,["onClick"])]),_:2},1032,["onClick"]))),128)),0===o.diaries.length?(m(),e(c,{key:0,class:"diary-item"},{default:a(()=>[h(d,{src:l.getOptimalImagePath("/src/images/lion.png"),class:"diary-image",mode:"aspectFill"},null,8,["src"]),h(c,{class:"diary-content"},{default:a(()=>[h(c,{class:"diary-title"},{default:a(()=>[p("示例：春节福字的故事")]),_:1}),h(c,{class:"diary-date"},{default:a(()=>[p("2025/08/25")]),_:1})]),_:1}),h(c,{class:"diary-menu"},{default:a(()=>[h(c,{class:"menu-dot"}),h(c,{class:"menu-dot"}),h(c,{class:"menu-dot"})]),_:1})]),_:1})):D("",!0)]),_:1}),h(c,{class:"add-btn-container"},{default:a(()=>[h(u,{class:"add-btn",onClick:l.addNewDiary},{default:a(()=>[h(n,{class:"add-icon"},{default:a(()=>[p("+")]),_:1}),h(n,{class:"add-text"},{default:a(()=>[p("新随记")]),_:1})]),_:1},8,["onClick"])]),_:1})]),_:1})}],["__scopeId","data-v-cac7e718"]]);export{x as default};
