import{c as e,w as t,q as o,v as i,g as s,x as a,n as r,r as n,u as c,D as l,E as d,y as h,i as u,o as g,a as m,e as p,d as f,t as y,I as w,B as C,b as k,G as b,k as R,F as T,l as S,f as I,m as _}from"./index-DQU_JAH0.js";import{a as v}from"./apiConfig.BpiTqs15.js";import{g as A}from"./imageMapping.mDgfjL7P.js";import{_ as x,a as M,b as P,c as W}from"./check.CZEXAOrB.js";import{_ as D}from"./_plugin-vue_export-helper.BCo6x5W8.js";const $="/static/icons/camera.svg";const E=D({data:()=>({editMode:!1,viewMode:!1,editChapterId:"",diaryTitle:"",diaryContent:"",selectedImage:"",isRecording:!1,recordingTime:0,recordings:[],recordingTimer:null,waveform:[],maxRecordingTime:600,recorderManager:null,mediaRecorder:null,mediaStream:null,audioChunks:[],speechProvider:"aliyun",aliyunAppKey:null,aliyunToken:null,aliyunWsUrl:null,aliyunTaskId:null,websocket:null,pcmSampleRate:16e3,audioContext:null,audioProcessor:null,audioSourceNode:null,decodeAudioContext:null,useAudioProcessorStreaming:!1,allowAudioStreaming:!1,audioProcessingPromise:Promise.resolve(),currentSpeechConfig:null,lastPartialText:"",realtimeRecognitionTimer:null,speechRecognition:null,isAiCompleting:!1,showAiDiff:!1,originalText:"",aiCompletedText:""}),onLoad(e){console.log("üì± ÈöèËÆ∞ÁºñËæëÈ°µÈù¢Âä†ËΩΩ",e),e.chapterId&&"edit"===e.mode?(this.editMode=!0,this.editChapterId=e.chapterId,this.diaryTitle=decodeURIComponent(e.title||"ÈöèËÆ∞"),this.loadExistingDiary()):e.chapterId&&"view"===e.mode&&(this.viewMode=!0,this.editChapterId=e.chapterId,this.diaryTitle=decodeURIComponent(e.title||"ÈöèËÆ∞"),this.loadExistingDiary()),this.initRecorderManager(),this.generateWaveform()},onUnload(){this.stopRecording(),this.recordingTimer&&clearInterval(this.recordingTimer),this.realtimeRecognitionTimer&&clearInterval(this.realtimeRecognitionTimer),this.speechRecognition&&this.speechRecognition.stop(),this.mediaStream&&this.mediaStream.getTracks().forEach(e=>{e.stop()})},methods:{getOptimalImagePath:A,async loadExistingDiary(){if(this.editChapterId.startsWith("sample_"))return console.log("üìñ Âä†ËΩΩÊ†∑ÊùøÊ°à‰æãÊï∞ÊçÆ"),this.diaryTitle="Êò•ËäÇËàûÁãÆÂ≠ê",this.diaryContent="ËàûÁãÆÂ≠êÊòØ‰∏≠ÂõΩ‰º†ÁªüÊ∞ëÈó¥Ëâ∫ÊúØÔºåÂú®Êò•ËäÇÊúüÈó¥Â∞§‰∏∫ÁõõË°å„ÄÇÁãÆÂ≠êË±°ÂæÅÁùÄÂ®ÅÊ≠¶ÂíåÂêâÁ••ÔºåËàûÁãÆË°®ÊºîÂØìÊÑèÈ©±ÈÇ™ÈÅøÂÆ≥„ÄÅÁ•àÊ±ÇÂπ≥ÂÆâ„ÄÇË°®ÊºîËÄÖÈúÄË¶ÅÈÖçÂêàÈªòÂ•ëÔºåÈÄöËøáÁ≤æÊπõÁöÑÊäÄËâ∫Â±ïÁé∞ÁãÆÂ≠êÁöÑÂ®ÅÊ≠¶ÂíåÁÅµÂä®Ôºå‰∏∫ËäÇÊó•Â¢ûÊ∑ªÂñúÂ∫ÜÊ∞õÂõ¥„ÄÇ",this.selectedImage="/src/images/lion.png",this.recordings=[],void console.log("‚úÖ Ê†∑ÊùøÊ°à‰æãÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê");try{console.log("üîÑ Âä†ËΩΩÁé∞ÊúâÈöèËÆ∞Êï∞ÊçÆ...",this.editChapterId);const e=s("currentDiary");if(e&&(e.id===this.editChapterId||e.chapterId===this.editChapterId))return console.log("üìñ ‰ΩøÁî®Êú¨Âú∞Â≠òÂÇ®ÁöÑÈöèËÆ∞Êï∞ÊçÆ:",e),this.diaryTitle=e.title||"ÈöèËÆ∞",this.diaryContent=e.content||"",this.selectedImage=e.image||"",e.recordings&&Array.isArray(e.recordings)&&(this.recordings=e.recordings.map(e=>({...e,playing:!1}))),void console.log("‚úÖ ÈöèËÆ∞Êï∞ÊçÆÂä†ËΩΩÂÆåÊàêÔºàÊú¨Âú∞Ôºâ");const t=s("token");if(!t)return void console.log("‚ùå Êú™ÁôªÂΩïÔºåÊó†Ê≥ïÂä†ËΩΩÈöèËÆ∞Êï∞ÊçÆ");const i=await n({url:v(`/chapters/${this.editChapterId}`),method:"GET",header:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(console.log("üìä ÈöèËÆ∞ËØ¶ÊÉÖÂìçÂ∫î:",i),200===i.statusCode&&i.data.success){const e=i.data.data;console.log("üìñ Âä†ËΩΩÁöÑÈöèËÆ∞Êï∞ÊçÆ:",e),this.diaryTitle=e.title||"ÈöèËÆ∞",this.diaryContent=e.content||"",this.selectedImage=e.backgroundImage||"",e.recordings&&Array.isArray(e.recordings)&&(this.recordings=e.recordings.map(e=>({...e,playing:!1}))),console.log("‚úÖ ÈöèËÆ∞Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê")}else console.log("‚ùå Ëé∑ÂèñÈöèËÆ∞ËØ¶ÊÉÖÂ§±Ë¥•:",i.data),o({title:"Âä†ËΩΩÈöèËÆ∞Â§±Ë¥•",icon:"none"})}catch(e){console.error("‚ùå Âä†ËΩΩÈöèËÆ∞Êï∞ÊçÆÂá∫Èîô:",e),o({title:"Âä†ËΩΩÂ§±Ë¥•",icon:"none"})}},goBack(){this.diaryTitle||this.diaryContent||this.selectedImage||this.recordings.length>0?h({title:"ÊèêÁ§∫",content:"ÂΩìÂâçÂÜÖÂÆπÂ∞öÊú™‰øùÂ≠òÔºåÁ°ÆÂÆöË¶ÅÁ¶ªÂºÄÂêóÔºü",success:e=>{e.confirm&&l()}}):l()},chooseImage(){d({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{this.selectedImage=e.tempFilePaths[0]},fail:e=>{console.error("ÈÄâÊã©ÂõæÁâáÂ§±Ë¥•:",e),o({title:"ÈÄâÊã©ÂõæÁâáÂ§±Ë¥•",icon:"error"})}})},initRecorderManager(){console.log("H5ÁéØÂ¢ÉÔºå‰ΩøÁî®WebÂΩïÈü≥API")},toggleRecording(){console.log("üéØ ÁÇπÂáªÂΩïÂà∂ÊåâÈíÆÔºåÂΩìÂâçÁä∂ÊÄÅ:",this.isRecording),this.isRecording?(console.log("üõë ÂÅúÊ≠¢ÂΩïÈü≥"),this.stopRecording()):(console.log("üé§ ÂºÄÂßãÂΩïÈü≥"),this.startRecording())},async startRecording(){this.recordings.length>=5?o({title:"ÊúÄÂ§öÂΩïÂà∂5ÊÆµÈü≥È¢ë",icon:"none"}):(console.log("üé§ ÂºÄÂßãÂΩïÈü≥..."),this.speechProvider="aliyun","undefined"!=typeof navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?(console.log("üåê Ê£ÄÊµãÂà∞ÊµèËßàÂô®ÁéØÂ¢ÉÔºå‰ΩøÁî®WebÂΩïÈü≥..."),await this.startWebRecording()):this.recorderManager.start({duration:1e3*this.maxRecordingTime,sampleRate:44100,numberOfChannels:1,encodeBitRate:192e3,format:"mp3"}))},stopRecording(){this.isRecording&&(console.log("üõë ÂÅúÊ≠¢ÂΩïÈü≥..."),this.mediaRecorder||this.mediaStream?(console.log("üåê ÂÅúÊ≠¢WebÂΩïÈü≥..."),this.stopWebRecording()):this.recorderManager.stop())},startRecordingTimer(){this.recordingTime=0,this.recordingTimer=setInterval(()=>{this.recordingTime++,this.recordingTime>=this.maxRecordingTime&&this.stopRecording()},1e3)},stopRecordingTimer(){this.recordingTimer&&(clearInterval(this.recordingTimer),this.recordingTimer=null)},generateWaveform(){this.waveform=[];for(let e=0;e<30;e++)this.waveform.push(20*Math.random()+5)},formatTime(e){const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},async startWebRecording(){try{console.log("üåê ÂºÄÂßãWebÂΩïÈü≥...");const e=await this.getAliyunSpeechConfig();this.currentSpeechConfig=e,(null==e?void 0:e.sampleRate)&&(this.pcmSampleRate=e.sampleRate);const t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,sampleRate:this.pcmSampleRate,channelCount:1}});this.mediaStream=t,await this.setupAliyunAudioProcessing(t);let i="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(i)||(i="audio/webm",MediaRecorder.isTypeSupported(i)||(i="audio/mp4",MediaRecorder.isTypeSupported(i)||(i=""))),this.mediaRecorder=new MediaRecorder(t,i?{mimeType:i}:{}),this.audioChunks=[],this.mediaRecorder.ondataavailable=e=>{e.data&&e.data.size>0&&(this.audioChunks.push(e.data),this.useAudioProcessorStreaming||this.processRealtimeAudioChunk(e.data))},this.mediaRecorder.onstop=()=>{if(console.log("‚úÖ WebÂΩïÈü≥ÂÅúÊ≠¢ÔºåÊï∞ÊçÆÂùóÊï∞Èáè:",this.audioChunks.length),this.audioChunks.length>0){const e=new Blob(this.audioChunks,{type:this.mediaRecorder.mimeType||"audio/webm"});console.log("Èü≥È¢ëBlobÂ§ßÂ∞è:",e.size,"bytes"),this.handleRecordedBlob(e)}else console.error("‚ùå Ê≤°ÊúâÂΩïÈü≥Êï∞ÊçÆ"),o({title:"ÂΩïÈü≥Êï∞ÊçÆ‰∏∫Á©∫",icon:"error"})},this.mediaRecorder.onerror=e=>{console.error("‚ùå MediaRecorderÈîôËØØ:",e.error),o({title:"ÂΩïÈü≥ËøáÁ®ã‰∏≠Âá∫Èîô",icon:"error"})},await this.startAliyunWebSocketRecognition(e),this.mediaRecorder.start(200),console.log("‚úÖ WebÂΩïÈü≥ÂºÄÂßãÊàêÂäü, Áä∂ÊÄÅ:",this.mediaRecorder.state),this.allowAudioStreaming=!0,this.isRecording=!0,this.startRecordingTimer()}catch(e){console.error("‚ùå WebÂΩïÈü≥ÂºÄÂßãÂ§±Ë¥•:",e);let t="Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£é";"NotAllowedError"===e.name?t="È∫¶ÂÖãÈ£éÊùÉÈôêË¢´ÊãíÁªù":"NotFoundError"===e.name&&(t="Êú™ÊâæÂà∞È∫¶ÂÖãÈ£éËÆæÂ§á"),o({title:t,icon:"error"})}},async autoLogin(){var e;try{const t=await n({url:v("/auth/login"),method:"POST",header:{"Content-Type":"application/json"},data:{identifier:"demo",password:"demo123"}});if(null==(e=t.data)?void 0:e.success){const{token:e,user:o}=t.data.data;return c("token",e),c("user",o),!0}}catch(t){console.error("‚ùå Ëá™Âä®ÁôªÂΩïÂ§±Ë¥•:",t)}return!1},async getAliyunSpeechConfig(){var e,t;try{let o=s("token");if(!o){console.log("üîê Áî®Êà∑Êú™ÁôªÂΩïÔºåÂ∞ùËØïËá™Âä®ÁôªÂΩï...");if(await this.autoLogin()&&(o=s("token")),!o)throw new Error("Áî®Êà∑Êú™ÁôªÂΩïÔºåÊó†Ê≥ïËøõË°åËØ≠Èü≥ËØÜÂà´")}const i=await n({url:v("/aliyun-speech/token"),method:"GET",header:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});if(null==(e=i.data)?void 0:e.success){const e=i.data.data||{},t=e.region||e.regionId||"cn-shanghai",o=e.sampleRate||this.pcmSampleRate||16e3;return this.aliyunToken=e.token,this.aliyunAppKey=e.appKey,this.aliyunWsUrl=e.websocketUrl||`wss://nls-gateway-${t}.aliyuncs.com/ws/v1`,this.pcmSampleRate=o,{provider:"aliyun",token:e.token,appKey:e.appKey,websocketUrl:this.aliyunWsUrl,region:t,sampleRate:o}}throw new Error((null==(t=i.data)?void 0:t.message)||"Ëé∑ÂèñËØ≠Èü≥ËØÜÂà´TokenÂ§±Ë¥•")}catch(o){throw console.error("‚ùå Ëé∑ÂèñÈòøÈáå‰∫ëËØ≠Èü≥ËØÜÂà´ÈÖçÁΩÆÂ§±Ë¥•:",o),o}},async startAliyunWebSocketRecognition(e={}){try{const{token:o,appKey:i,websocketUrl:s,sampleRate:a=this.pcmSampleRate||16e3,region:r}=e;if(!o||!i||!s)throw new Error("ÈòøÈáå‰∫ëËØ≠Èü≥ËØÜÂà´ÈÖçÁΩÆ‰∏çÂÆåÊï¥");this.currentSpeechConfig={...e,provider:"aliyun",sampleRate:a},this.aliyunToken=o,this.aliyunAppKey=i,this.aliyunWsUrl=s,this.pcmSampleRate=a;let n=s;if(n=n.includes("?")?`${n}&token=${encodeURIComponent(o)}`:`${n}?token=${encodeURIComponent(o)}`,this.websocket)try{this.websocket.close()}catch(t){console.warn("‚ö†Ô∏è ÂÖ≥Èó≠ÊóßÁöÑWebSocketÂ§±Ë¥•:",t)}this.websocket=new WebSocket(n),this.websocket.binaryType="arraybuffer",this.aliyunTaskId=this.generateMessageId(),this.websocket.onopen=()=>{const e={header:{message_id:this.generateMessageId(),task_id:this.aliyunTaskId,namespace:"SpeechTranscriber",name:"StartTranscription",appkey:i},payload:{format:"pcm",sample_rate:Number(a)||16e3,enable_intermediate_result:!0,enable_punctuation_prediction:!0,enable_inverse_text_normalization:!0,disfluency:!0,max_sentence_silence:800}};try{this.websocket.send(JSON.stringify(e)),console.log("üì§ Â∑≤ÂèëÈÄÅÈòøÈáå‰∫ëStartTranscriptionÊåá‰ª§")}catch(t){console.error("‚ùå ÂèëÈÄÅStartÊåá‰ª§Â§±Ë¥•:",t)}},this.websocket.onmessage=e=>{this.handleAliyunWebSocketMessage(e)},this.websocket.onclose=e=>{console.log("üîå ÈòøÈáå‰∫ëWebSocketÂÖ≥Èó≠:",e.code,e.reason),this.allowAudioStreaming=!1},this.websocket.onerror=e=>{console.error("‚ùå ÈòøÈáå‰∫ëWebSocketÈîôËØØ:",e),this.allowAudioStreaming=!1}}catch(t){throw console.error("‚ùå ÂêØÂä®ÈòøÈáå‰∫ëWebSocketËØÜÂà´Â§±Ë¥•:",t),t}},handleAliyunWebSocketMessage(e){try{if(!e||"string"!=typeof e.data)return;const t=JSON.parse(e.data),o=(null==t?void 0:t.header)||{},i=(null==t?void 0:t.payload)||{},s=o.name;switch(o.task_id&&(this.aliyunTaskId=o.task_id),s){case"TranscriptionStarted":console.log("üöÄ ÈòøÈáå‰∫ëËØÜÂà´Â∑≤ÂêØÂä®");break;case"TranscriptionResultChanged":{const e=(null==i?void 0:i.result)||(null==i?void 0:i.text);e&&this.applyRecognitionResult(e,!1);break}case"SentenceEnd":{const e=(null==i?void 0:i.result)||(null==i?void 0:i.text);e&&this.applyRecognitionResult(e,!0);break}case"TranscriptionCompleted":console.log("üèÅ ÈòøÈáå‰∫ëËØÜÂà´ÂÆåÊàê"),this.lastPartialText="";break;case"TaskFailed":{const e=(null==o?void 0:o.status_text)||(null==o?void 0:o.status_message)||"ËØÜÂà´Â§±Ë¥•";console.error("‚ùå ÈòøÈáå‰∫ëËØÜÂà´Â§±Ë¥•:",e);break}default:s&&console.log("‚ÑπÔ∏è ÈòøÈáå‰∫ë‰∫ã‰ª∂:",s,i)}}catch(t){console.error("‚ùå Ëß£ÊûêÈòøÈáå‰∫ëWebSocketÊ∂àÊÅØÂ§±Ë¥•:",t)}},applyRecognitionResult(e,t=!1){if(!e||!e.trim())return;const o=e.trim();let i=this.diaryContent||"";if(this.lastPartialText){const e=this.lastPartialText.trim();e&&i.endsWith(e)&&(i=i.slice(0,-e.length).trimEnd())}const s=i?`${i} ${o}`.replace(/\s+/g," ").trim():o;this.lastPartialText=t?"":o,this.diaryContent=s},sendAliyunStopRequest(){if(this.websocket&&this.websocket.readyState===WebSocket.OPEN)try{const e={header:{message_id:this.generateMessageId(),task_id:this.aliyunTaskId||this.generateMessageId(),namespace:"SpeechTranscriber",name:"StopTranscription",appkey:this.aliyunAppKey},payload:{}};this.websocket.send(JSON.stringify(e)),console.log("üõë Â∑≤ÂèëÈÄÅÈòøÈáå‰∫ëStopTranscriptionÊåá‰ª§")}catch(e){console.error("‚ùå ÂèëÈÄÅÂÅúÊ≠¢Êåá‰ª§Â§±Ë¥•:",e)}},async setupAliyunAudioProcessing(e){try{const o=window.AudioContext||window.webkitAudioContext;if(!o)return console.warn("‚ö†Ô∏è AudioContext‰∏çÂèØÁî®ÔºåÈôçÁ∫ßÂà∞MediaRecorderÂ§ÑÁêÜ"),void(this.useAudioProcessorStreaming=!1);if(this.audioContext&&"closed"!==this.audioContext.state||(this.audioContext=new o({sampleRate:this.pcmSampleRate})),"suspended"===this.audioContext.state&&"function"==typeof this.audioContext.resume&&await this.audioContext.resume(),this.audioSourceNode)try{this.audioSourceNode.disconnect()}catch(t){console.warn("‚ö†Ô∏è Êñ≠ÂºÄÊóßÈü≥È¢ëÊ∫êÂ§±Ë¥•:",t)}if(this.audioProcessor)try{this.audioProcessor.disconnect()}catch(t){console.warn("‚ö†Ô∏è Êñ≠ÂºÄÊóßÈü≥È¢ëÂ§ÑÁêÜÂô®Â§±Ë¥•:",t)}const i=this.audioContext.createMediaStreamSource(e),s=this.audioContext.createScriptProcessor(4096,1,1),a=this.audioContext.sampleRate,r=this.pcmSampleRate;s.onaudioprocess=e=>{var o;if(!this.allowAudioStreaming||!this.isRecording)return;const i=null==(o=e.inputBuffer)?void 0:o.getChannelData(0);if(!i||!i.length)return;const s=e.inputBuffer.sampleRate||a;let n=i;if(s!==r&&(n=this.downsampleBuffer(i,s,r)),!n||!n.length)return;const c=this.float32ToPCM(n);if(c&&c.byteLength&&this.websocket&&this.websocket.readyState===WebSocket.OPEN)try{this.websocket.send(c)}catch(t){console.error("‚ùå ÂèëÈÄÅÈü≥È¢ëÊï∞ÊçÆÂ§±Ë¥•:",t)}},i.connect(s),s.connect(this.audioContext.destination),this.audioSourceNode=i,this.audioProcessor=s,this.useAudioProcessorStreaming=!0}catch(t){console.error("‚ùå ÂàùÂßãÂåñÈü≥È¢ëÂ§ÑÁêÜÂô®Â§±Ë¥•:",t),this.useAudioProcessorStreaming=!1}},async processRealtimeAudioChunk(e){try{if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)return;const t=await this.convertWebMToPCM(e);t&&t.byteLength&&this.websocket.send(t)}catch(t){console.error("‚ùå Â§ÑÁêÜÂÆûÊó∂Èü≥È¢ëÊï∞ÊçÆÂ§±Ë¥•:",t)}},async convertWebMToPCM(e){try{const t=window.AudioContext||window.webkitAudioContext;if(!t)throw new Error("AudioContext ‰∏çÂèØÁî®");this.decodeAudioContext&&"closed"!==this.decodeAudioContext.state||(this.decodeAudioContext=new t);const o=await e.arrayBuffer(),i=await new Promise((e,t)=>{this.decodeAudioContext.decodeAudioData(o.slice(0),e,t)}),s=i.getChannelData(0),a=this.downsampleBuffer(s,i.sampleRate,this.pcmSampleRate);return this.float32ToPCM(a)}catch(t){return console.error("‚ùå WebMÂà∞PCMËΩ¨Êç¢Â§±Ë¥•:",t),null}},downsampleBuffer(e,t,o){if(!e||t===o)return e;const i=t/o,s=Math.round(e.length/i),a=new Float32Array(s);for(let r=0;r<s;r++){const t=Math.floor(r*i);a[r]=e[t]}return a},float32ToPCM(e){if(!e)return new ArrayBuffer(0);const t=new ArrayBuffer(2*e.length),o=new DataView(t);for(let i=0;i<e.length;i++){const t=Math.max(-1,Math.min(1,e[i]));o.setInt16(2*i,t<0?32768*t:32767*t,!0)}return t},generateMessageId(){let e="";for(let t=0;t<32;t++)e+="0123456789abcdef"[Math.floor(16*Math.random())];return e},async handleRecordedBlob(e){try{const i=URL.createObjectURL(e);let s=null;try{s=await this.uploadWebAudio(e)}catch(t){console.warn("‚ö†Ô∏è Èü≥È¢ëÊñá‰ª∂‰∏ä‰º†Â§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞URL:",t)}this.recordings.push({filePath:(null==s?void 0:s.fileUrl)||(null==s?void 0:s.filename)||i,duration:this.recordingTime,createTime:Date.now()}),this.recordingTime=0,o({title:"ÂΩïÂà∂ÂÆåÊàê",icon:"success"})}catch(i){console.error("‚ùå Â§ÑÁêÜÂΩïÈü≥Êñá‰ª∂Â§±Ë¥•:",i)}},async uploadWebAudio(e){var t;try{const o=s("token");if(!o)throw new Error("Áî®Êà∑Êú™ÁôªÂΩï");let i=".webm";const a=e.type||"audio/webm";a.includes("webm")?i=".webm":a.includes("mp4")?i=".mp4":a.includes("wav")?i=".wav":a.includes("ogg")&&(i=".ogg");const r=`diary_recording_${Date.now()}${i}`,n=new File([e],r,{type:a}),c=new FormData;c.append("audio",n);const l=await fetch(v("/speech/upload"),{method:"POST",headers:{Authorization:`Bearer ${o}`},body:c});if(!l.ok){const e=await l.text();throw new Error(`‰∏ä‰º†Â§±Ë¥•: ${l.status} ${e}`)}const d=await l.json();if(d.success&&(null==(t=d.data)?void 0:t.file))return d.data.file;throw new Error(d.message||"‰∏ä‰º†Â§±Ë¥•")}catch(o){throw console.error("‚ùå ‰∏ä‰º†ÂΩïÈü≥Êñá‰ª∂Â§±Ë¥•:",o),o}},stopWebRecording(){var e;try{if(console.log("üåê ÂÅúÊ≠¢WebÂΩïÈü≥..."),console.log("MediaRecorderÁä∂ÊÄÅ:",null==(e=this.mediaRecorder)?void 0:e.state),this.allowAudioStreaming=!1,this.sendAliyunStopRequest(),this.mediaRecorder&&("recording"===this.mediaRecorder.state?(console.log("ÂÅúÊ≠¢MediaRecorder..."),this.mediaRecorder.stop()):"paused"===this.mediaRecorder.state&&(this.mediaRecorder.resume(),this.mediaRecorder.stop())),this.mediaStream&&(console.log("ÂÅúÊ≠¢Â™í‰ΩìÊµÅ..."),this.mediaStream.getTracks().forEach(e=>{e.stop()}),this.mediaStream=null),this.audioProcessor){try{this.audioProcessor.disconnect()}catch(t){console.warn("‚ö†Ô∏è Êñ≠ÂºÄÈü≥È¢ëÂ§ÑÁêÜÂô®Â§±Ë¥•:",t)}this.audioProcessor=null}if(this.audioSourceNode){try{this.audioSourceNode.disconnect()}catch(t){console.warn("‚ö†Ô∏è Êñ≠ÂºÄÈü≥È¢ëÊ∫êÂ§±Ë¥•:",t)}this.audioSourceNode=null}if(this.audioContext){try{this.audioContext.close()}catch(t){console.warn("‚ö†Ô∏è ÂÖ≥Èó≠Èü≥È¢ë‰∏ä‰∏ãÊñáÂ§±Ë¥•:",t)}this.audioContext=null}if(this.websocket){try{this.websocket.close()}catch(t){console.warn("‚ö†Ô∏è ÂÖ≥Èó≠WebSocketÂ§±Ë¥•:",t)}this.websocket=null}if(this.realtimeRecognitionTimer&&(clearInterval(this.realtimeRecognitionTimer),this.realtimeRecognitionTimer=null),this.speechRecognition&&(this.speechRecognition.stop(),this.speechRecognition=null),this.decodeAudioContext){try{this.decodeAudioContext.close()}catch(t){console.warn("‚ö†Ô∏è ÂÖ≥Èó≠Ëß£Á†ÅÈü≥È¢ë‰∏ä‰∏ãÊñáÂ§±Ë¥•:",t)}this.decodeAudioContext=null}this.audioChunks=[],this.isRecording=!1,this.stopRecordingTimer()}catch(t){console.error("‚ùå ÂÅúÊ≠¢WebÂΩïÈü≥Â§±Ë¥•:",t),o({title:"ÂÅúÊ≠¢ÂΩïÈü≥Â§±Ë¥•",icon:"error"})}},startWebSpeechRecognition(){const e=window.SpeechRecognition||window.webkitSpeechRecognition;this.speechRecognition=new e,this.speechRecognition.continuous=!0,this.speechRecognition.interimResults=!0,this.speechRecognition.lang="zh-CN",this.speechRecognition.onresult=e=>{let t="",o="";for(let i=e.resultIndex;i<e.results.length;i++){const s=e.results[i][0].transcript;e.results[i].isFinal?o+=s:t+=s}o?(console.log("‚úÖ ÊúÄÁªàËØÜÂà´ÁªìÊûú:",o),this.diaryContent.trim()?this.diaryContent+=" "+o:this.diaryContent=o):t&&console.log("üéØ ‰∏≠Èó¥ËØÜÂà´ÁªìÊûú:",t)},this.speechRecognition.onerror=e=>{console.error("‚ùå Web Speech APIÈîôËØØ:",e.error)},this.speechRecognition.onend=()=>{console.log("Web Speech APIËØÜÂà´ÁªìÊùü")},this.speechRecognition.start(),console.log("‚úÖ Web Speech APIÂºÄÂßãËØÜÂà´")},async aiCompleteText(){var e;try{if(!this.diaryContent||0===this.diaryContent.trim().length)return void o({title:"ËØ∑ÂÖàËæìÂÖ•ÂÜÖÂÆπ",icon:"none"});this.isAiCompleting=!0,this.originalText=this.diaryContent,console.log("ü§ñ ÂºÄÂßãAIË°•ÂÖ®ÊñáÊú¨...");const t=s("token");if(!t)throw new Error("Áî®Êà∑Êú™ÁôªÂΩï");const i=await n({url:v("/ai/complete-text"),method:"POST",header:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},data:{text:this.diaryContent,chapterId:this.editChapterId,chapterTitle:this.diaryTitle||"ÈöèËÆ∞"}});if(200!==i.statusCode||!i.data.success)throw new Error((null==(e=i.data)?void 0:e.message)||"AIË°•ÂÖ®Â§±Ë¥•");this.aiCompletedText=i.data.data.completedText,this.showAiDiff=!0,console.log("‚úÖ AIË°•ÂÖ®ÊàêÂäü")}catch(t){console.error("‚ùå AIË°•ÂÖ®Â§±Ë¥•:",t),o({title:t.message||"AIË°•ÂÖ®Â§±Ë¥•",icon:"error"})}finally{this.isAiCompleting=!1}},acceptAiCompletion(){this.diaryContent=this.aiCompletedText,this.showAiDiff=!1,this.originalText="",this.aiCompletedText="",o({title:"Â∑≤Â∫îÁî®AIË°•ÂÖ®",icon:"success"})},rejectAiCompletion(){this.showAiDiff=!1,this.originalText="",this.aiCompletedText="",o({title:"Â∑≤ÂèñÊ∂àAIË°•ÂÖ®",icon:"none"})},async uploadImageToServer(e){try{console.log("üì§ ÂºÄÂßã‰∏ä‰º†ÂõæÁâá:",e);const t=await fetch(e),o=await t.blob(),i=new FormData,a=`diary_image_${Date.now()}.jpg`,r=new Blob([o],{type:"image/jpeg"});i.append("image",r,a);const n=s("token");if(!n)throw new Error("Áî®Êà∑Êú™ÁôªÂΩï");const c=await fetch(v("/upload/image"),{method:"POST",headers:{Authorization:`Bearer ${n}`},body:i});if(!c.ok)throw new Error(`‰∏ä‰º†Â§±Ë¥•: ${c.status}`);const l=await c.json();return console.log("‚úÖ ÂõæÁâá‰∏ä‰º†ÊàêÂäü:",l),l.data.url||l.url}catch(t){throw console.error("‚ùå ÂõæÁâá‰∏ä‰º†Â§±Ë¥•:",t),t}},async saveDiary(){var e,t,d;if(this.viewMode&&(this.viewMode=!1,this.editMode=!0),this.diaryTitle.trim())if(this.diaryContent.trim()||this.selectedImage||0!==this.recordings.length){i({title:"‰øùÂ≠ò‰∏≠..."});try{const i=s("token");if(console.log("üîë Áî®Êà∑token:",i?"Â∑≤Ëé∑Âèñ":"Êú™ÊâæÂà∞"),!i)return a(),o({title:"ËØ∑ÂÖàÁôªÂΩï",icon:"error"}),void setTimeout(()=>{r({url:"/pages/login/index"})},1500);let u;this.editMode?this.editChapterId.startsWith("sample_")?(u="diary_"+Date.now(),console.log("üìù Ê†∑ÊùøÊ°à‰æã‰øùÂ≠ò‰∏∫Êñ∞ÈöèËÆ∞ÔºåÁîüÊàêÊñ∞ID:",u)):(u=this.editChapterId,console.log("üìù ÁºñËæëÁé∞ÊúâÈöèËÆ∞Ôºå‰ΩøÁî®ÂéüID:",u)):(u="diary_"+Date.now(),console.log("üìù Êñ∞Âª∫ÈöèËÆ∞ÔºåÁîüÊàêÊñ∞ID:",u));let g="/src/images/default-diary.svg";if(this.selectedImage)try{g=this.selectedImage.startsWith("blob:")?await this.uploadImageToServer(this.selectedImage):this.selectedImage}catch(h){console.error("ÂõæÁâá‰∏ä‰º†Â§±Ë¥•:",h),g="/src/images/default-diary.svg"}const m={chapterId:u,title:this.diaryTitle.trim(),content:this.diaryContent.trim(),recordings:this.recordings,backgroundImage:g};console.log("üì§ ÂèëÈÄÅÁ´†ËäÇÊï∞ÊçÆ:",m);const p=await n({url:v("/chapters/save"),method:"POST",header:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},data:m});if(a(),console.log("üìä ‰øùÂ≠òÂìçÂ∫î:",p),console.log("üìä ÂìçÂ∫îÁä∂ÊÄÅÁ†Å:",p.statusCode),console.log("üìä ÂìçÂ∫îÊï∞ÊçÆ:",p.data),p.data&&p.data.errors&&(console.log("‚ùå È™åËØÅÈîôËØØËØ¶ÊÉÖ:",p.data.errors),p.data.errors.forEach((e,t)=>{console.log(`‚ùå ÈîôËØØ ${t+1}:`,e)})),200!==p.statusCode||!p.data.success){console.error("‚ùå ‰øùÂ≠òÂ§±Ë¥•ËØ¶ÊÉÖ:",p.data);const o=(null==(e=p.data)?void 0:e.message)||`‰øùÂ≠òÂ§±Ë¥• (${p.statusCode})`,i=(null==(t=p.data)?void 0:t.details)||(null==(d=p.data)?void 0:d.error)||"";throw new Error(`${o}${i?": "+i:""}`)}{const e={id:u,title:this.diaryTitle.trim(),description:"Ëá™ÂÆö‰πâÈöèËÆ∞Á´†ËäÇ",backgroundImage:this.selectedImage||"/src/images/story1.png",completed:!0,isCustom:!0,content:this.diaryContent.trim(),recordings:this.recordings,createTime:Date.now(),lastModified:(new Date).toISOString()},t=s("user"),i=null==t?void 0:t.id;if(i){c(`chapter_${u}_${i}`,JSON.stringify({text:this.diaryContent.trim(),recordings:this.recordings,lastModified:(new Date).toISOString(),completed:!0}));const t=s(`chapter_status_${i}`)||"{}",o=JSON.parse(t);o[u]={completed:!0,lastModified:(new Date).toISOString()},c(`chapter_status_${i}`,JSON.stringify(o));const a=s(`custom_chapters_${i}`)||[];a.unshift(e),c(`custom_chapters_${i}`,a)}o({title:"‰øùÂ≠òÊàêÂäü",icon:"success"}),setTimeout(()=>{l()},1500)}}catch(h){if(a(),console.error("‰øùÂ≠òÈöèËÆ∞Â§±Ë¥•:",h),h.errMsg&&h.errMsg.includes("network"))try{const e=this.editMode?this.editChapterId:"diary_"+Date.now(),t={id:e,title:this.diaryTitle.trim(),description:"Ëá™ÂÆö‰πâÈöèËÆ∞Á´†ËäÇ",backgroundImage:this.selectedImage||"/src/images/story1.png",completed:!0,isCustom:!0,content:this.diaryContent.trim(),recordings:this.recordings,createTime:Date.now(),lastModified:(new Date).toISOString(),needSync:!0},i=s("user"),a=null==i?void 0:i.id;if(a){c(`chapter_${e}_${a}`,JSON.stringify({text:this.diaryContent.trim(),recordings:this.recordings,lastModified:(new Date).toISOString(),completed:!0,needSync:!0}));const o=s(`custom_chapters_${a}`)||[];o.unshift(t),c(`custom_chapters_${a}`,o)}o({title:"Â∑≤Á¶ªÁ∫ø‰øùÂ≠ò",icon:"success"}),setTimeout(()=>{l()},1500)}catch(u){o({title:"‰øùÂ≠òÂ§±Ë¥•",icon:"error"})}else o({title:h.message||"‰øùÂ≠òÂ§±Ë¥•",icon:"error"})}}else o({title:"ËØ∑Ê∑ªÂä†ÂÜÖÂÆπ„ÄÅÂõæÁâáÊàñÂΩïÈü≥",icon:"none"});else o({title:"ËØ∑ËæìÂÖ•ÈöèËÆ∞Ê†áÈ¢ò",icon:"none"})}}},[["render",function(o,i,s,a,r,n){const c=p,l=u,d=w,h=k,v=b;return g(),e(l,{class:"container"},{default:t(()=>[m(l,{class:"nav-header"},{default:t(()=>[m(l,{class:"back-btn",onClick:n.goBack},{default:t(()=>[m(c,{class:"back-icon"},{default:t(()=>[f("‚Üê")]),_:1})]),_:1},8,["onClick"]),m(l,{class:"nav-title"},{default:t(()=>[f(y(r.viewMode?"Êü•ÁúãÈöèËÆ∞":r.editMode?"ÁºñËæëÈöèËÆ∞":"Êñ∞ÈöèËÆ∞"),1)]),_:1}),m(l,{class:"save-btn",onClick:n.saveDiary},{default:t(()=>[m(c,{class:"save-text"},{default:t(()=>[f("‰øùÂ≠ò")]),_:1})]),_:1},8,["onClick"])]),_:1}),m(l,{class:"content"},{default:t(()=>[m(l,{class:"title-section"},{default:t(()=>[m(d,{class:"title-input",placeholder:"ÈöèËÆ∞Ê†áÈ¢ò",modelValue:r.diaryTitle,"onUpdate:modelValue":i[0]||(i[0]=e=>r.diaryTitle=e),maxlength:"50"},null,8,["modelValue"])]),_:1}),m(l,{class:"photo-section"},{default:t(()=>[r.selectedImage?C("",!0):(g(),e(l,{key:0,class:"photo-upload",onClick:n.chooseImage},{default:t(()=>[m(l,{class:"upload-icon"},{default:t(()=>[m(h,{src:$,class:"camera-icon",mode:"aspectFit"})]),_:1}),m(c,{class:"upload-text"},{default:t(()=>[f("‰∏ä‰º†ÂõæÁâá ËÆ∞ÂΩïÁæéÂ•ΩÁû¨Èó¥")]),_:1})]),_:1},8,["onClick"])),r.selectedImage?(g(),e(l,{key:1,class:"photo-preview"},{default:t(()=>[m(h,{src:r.selectedImage.startsWith("http")?r.selectedImage:n.getOptimalImagePath(r.selectedImage),class:"preview-image",mode:"aspectFill"},null,8,["src"]),m(l,{class:"photo-overlay"},{default:t(()=>[m(l,{class:"photo-actions"},{default:t(()=>[m(l,{class:"action-btn",onClick:n.chooseImage},{default:t(()=>[m(h,{src:$,class:"action-camera-icon",mode:"aspectFit"})]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})):C("",!0)]),_:1}),m(l,{class:"text-section"},{default:t(()=>[m(v,{class:"content-textarea",placeholder:"ËÆ∞ÂΩïÊÇ®Áé∞Âú®ÊÉ≥Âà∞ÁöÑ‰∫ãÊÉÖ...",modelValue:r.diaryContent,"onUpdate:modelValue":i[1]||(i[1]=e=>r.diaryContent=e),maxlength:"2000","auto-height":""},null,8,["modelValue"])]),_:1}),m(l,{class:"recording-section"},{default:t(()=>[r.isRecording||r.recordings.length>0?(g(),e(l,{key:0,class:"recording-timer"},{default:t(()=>[m(c,{class:"timer-text"},{default:t(()=>[f(y(n.formatTime(r.recordingTime)),1)]),_:1}),m(c,{class:"timer-limit"},{default:t(()=>[f("ÊúÄÂ§öÂèØÂΩïÂà∂10ÂàÜÈíü")]),_:1})]),_:1})):C("",!0),r.isRecording?(g(),e(l,{key:1,class:"recording-wave"},{default:t(()=>[(g(!0),R(T,null,S(r.waveform,(t,o)=>(g(),e(l,{class:"wave-bar",key:o,style:I({height:t+"px"})},null,8,["style"]))),128))]),_:1})):C("",!0),m(l,{class:"recording-controls"},{default:t(()=>[m(l,{class:"control-buttons"},{default:t(()=>[m(l,{class:"record-btn-container"},{default:t(()=>[m(l,{class:_(["record-btn",{recording:r.isRecording}]),onClick:n.toggleRecording},{default:t(()=>[m(l,{class:"record-icon"},{default:t(()=>[r.isRecording?(g(),e(l,{key:0,class:"recording-animation"},{default:t(()=>[(g(),R(T,null,S(3,e=>m(l,{class:"wave",key:e})),64))]),_:1})):(g(),e(h,{key:1,src:x,class:"mic-icon",mode:"aspectFit"}))]),_:1})]),_:1},8,["onClick","class"]),m(c,{class:"record-text"},{default:t(()=>[f(y(r.isRecording?"ÁªìÊùüÂΩïÂà∂":"ÁÇπÂáªÂΩïÂà∂"),1)]),_:1})]),_:1}),m(l,{class:"ai-complete-btn-container"},{default:t(()=>[m(l,{class:_(["ai-complete-btn",{loading:r.isAiCompleting}]),onClick:n.aiCompleteText},{default:t(()=>[r.isAiCompleting?(g(),e(l,{key:1,class:"ai-loading"},{default:t(()=>[(g(),R(T,null,S(3,e=>m(l,{class:"loading-dot",key:e})),64))]),_:1})):(g(),e(l,{key:0,class:"ai-icon"},{default:t(()=>[m(h,{src:M,class:"ai-icon-img",mode:"aspectFit"})]),_:1}))]),_:1},8,["onClick","class"]),m(c,{class:"ai-complete-text"},{default:t(()=>[f("AIË°•ÂÖ®")]),_:1})]),_:1})]),_:1})]),_:1}),r.showAiDiff?(g(),e(l,{key:2,class:"ai-complete-result"},{default:t(()=>[m(l,{class:"diff-header"},{default:t(()=>[m(c,{class:"diff-title"},{default:t(()=>[f("AIË°•ÂÖ®ÁªìÊûú")]),_:1}),m(c,{class:"diff-subtitle"},{default:t(()=>[f("ËØ∑ÈÄâÊã©ÊòØÂê¶Êé•ÂèóAIÁöÑ‰øÆÊîπ")]),_:1})]),_:1}),m(l,{class:"diff-content"},{default:t(()=>[m(l,{class:"diff-ai"},{default:t(()=>[m(l,{class:"diff-label"},{default:t(()=>[f("AIË°•ÂÖ®ÁªìÊûú")]),_:1}),m(l,{class:"diff-text ai-text"},{default:t(()=>[f(y(r.aiCompletedText),1)]),_:1})]),_:1})]),_:1}),m(l,{class:"diff-actions"},{default:t(()=>[m(l,{class:"diff-btn reject-btn",onClick:n.rejectAiCompletion},{default:t(()=>[m(h,{src:P,class:"btn-icon",mode:"aspectFit"})]),_:1},8,["onClick"]),m(l,{class:"diff-btn accept-btn",onClick:n.acceptAiCompletion},{default:t(()=>[m(h,{src:W,class:"btn-icon",mode:"aspectFit"})]),_:1},8,["onClick"])]),_:1})]),_:1})):C("",!0)]),_:1})]),_:1})]),_:1})}],["__scopeId","data-v-eca466c6"]]);export{E as default};
