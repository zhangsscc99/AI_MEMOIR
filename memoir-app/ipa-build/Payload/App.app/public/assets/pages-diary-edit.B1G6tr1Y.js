import{c as e,w as t,q as o,v as i,g as s,x as a,n as r,r as n,u as c,D as l,E as d,y as h,i as u,o as g,a as m,e as p,d as f,t as y,I as w,B as C,b as k,G as b,k as R,F as T,l as S,f as I,m as _}from"./index-DQU_JAH0.js";import{a as v}from"./apiConfig.BpiTqs15.js";import{g as A}from"./imageMapping.mDgfjL7P.js";import{_ as x,a as M,b as P,c as W}from"./check.CZEXAOrB.js";import{_ as D}from"./_plugin-vue_export-helper.BCo6x5W8.js";const $="/static/icons/camera.svg";const E=D({data:()=>({editMode:!1,viewMode:!1,editChapterId:"",diaryTitle:"",diaryContent:"",selectedImage:"",isRecording:!1,recordingTime:0,recordings:[],recordingTimer:null,waveform:[],maxRecordingTime:600,recorderManager:null,mediaRecorder:null,mediaStream:null,audioChunks:[],speechProvider:"aliyun",aliyunAppKey:null,aliyunToken:null,aliyunWsUrl:null,aliyunTaskId:null,websocket:null,pcmSampleRate:16e3,audioContext:null,audioProcessor:null,audioSourceNode:null,decodeAudioContext:null,useAudioProcessorStreaming:!1,allowAudioStreaming:!1,audioProcessingPromise:Promise.resolve(),currentSpeechConfig:null,lastPartialText:"",realtimeRecognitionTimer:null,speechRecognition:null,isAiCompleting:!1,showAiDiff:!1,originalText:"",aiCompletedText:""}),onLoad(e){console.log("📱 随记编辑页面加载",e),e.chapterId&&"edit"===e.mode?(this.editMode=!0,this.editChapterId=e.chapterId,this.diaryTitle=decodeURIComponent(e.title||"随记"),this.loadExistingDiary()):e.chapterId&&"view"===e.mode&&(this.viewMode=!0,this.editChapterId=e.chapterId,this.diaryTitle=decodeURIComponent(e.title||"随记"),this.loadExistingDiary()),this.initRecorderManager(),this.generateWaveform()},onUnload(){this.stopRecording(),this.recordingTimer&&clearInterval(this.recordingTimer),this.realtimeRecognitionTimer&&clearInterval(this.realtimeRecognitionTimer),this.speechRecognition&&this.speechRecognition.stop(),this.mediaStream&&this.mediaStream.getTracks().forEach(e=>{e.stop()})},methods:{getOptimalImagePath:A,async loadExistingDiary(){if(this.editChapterId.startsWith("sample_"))return console.log("📖 加载样板案例数据"),this.diaryTitle="春节舞狮子",this.diaryContent="舞狮子是中国传统民间艺术，在春节期间尤为盛行。狮子象征着威武和吉祥，舞狮表演寓意驱邪避害、祈求平安。表演者需要配合默契，通过精湛的技艺展现狮子的威武和灵动，为节日增添喜庆氛围。",this.selectedImage="/src/images/lion.png",this.recordings=[],void console.log("✅ 样板案例数据加载完成");try{console.log("🔄 加载现有随记数据...",this.editChapterId);const e=s("currentDiary");if(e&&(e.id===this.editChapterId||e.chapterId===this.editChapterId))return console.log("📖 使用本地存储的随记数据:",e),this.diaryTitle=e.title||"随记",this.diaryContent=e.content||"",this.selectedImage=e.image||"",e.recordings&&Array.isArray(e.recordings)&&(this.recordings=e.recordings.map(e=>({...e,playing:!1}))),void console.log("✅ 随记数据加载完成（本地）");const t=s("token");if(!t)return void console.log("❌ 未登录，无法加载随记数据");const i=await n({url:v(`/chapters/${this.editChapterId}`),method:"GET",header:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(console.log("📊 随记详情响应:",i),200===i.statusCode&&i.data.success){const e=i.data.data;console.log("📖 加载的随记数据:",e),this.diaryTitle=e.title||"随记",this.diaryContent=e.content||"",this.selectedImage=e.backgroundImage||"",e.recordings&&Array.isArray(e.recordings)&&(this.recordings=e.recordings.map(e=>({...e,playing:!1}))),console.log("✅ 随记数据加载完成")}else console.log("❌ 获取随记详情失败:",i.data),o({title:"加载随记失败",icon:"none"})}catch(e){console.error("❌ 加载随记数据出错:",e),o({title:"加载失败",icon:"none"})}},goBack(){this.diaryTitle||this.diaryContent||this.selectedImage||this.recordings.length>0?h({title:"提示",content:"当前内容尚未保存，确定要离开吗？",success:e=>{e.confirm&&l()}}):l()},chooseImage(){d({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{this.selectedImage=e.tempFilePaths[0]},fail:e=>{console.error("选择图片失败:",e),o({title:"选择图片失败",icon:"error"})}})},initRecorderManager(){console.log("H5环境，使用Web录音API")},toggleRecording(){console.log("🎯 点击录制按钮，当前状态:",this.isRecording),this.isRecording?(console.log("🛑 停止录音"),this.stopRecording()):(console.log("🎤 开始录音"),this.startRecording())},async startRecording(){this.recordings.length>=5?o({title:"最多录制5段音频",icon:"none"}):(console.log("🎤 开始录音..."),this.speechProvider="aliyun","undefined"!=typeof navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?(console.log("🌐 检测到浏览器环境，使用Web录音..."),await this.startWebRecording()):this.recorderManager.start({duration:1e3*this.maxRecordingTime,sampleRate:44100,numberOfChannels:1,encodeBitRate:192e3,format:"mp3"}))},stopRecording(){this.isRecording&&(console.log("🛑 停止录音..."),this.mediaRecorder||this.mediaStream?(console.log("🌐 停止Web录音..."),this.stopWebRecording()):this.recorderManager.stop())},startRecordingTimer(){this.recordingTime=0,this.recordingTimer=setInterval(()=>{this.recordingTime++,this.recordingTime>=this.maxRecordingTime&&this.stopRecording()},1e3)},stopRecordingTimer(){this.recordingTimer&&(clearInterval(this.recordingTimer),this.recordingTimer=null)},generateWaveform(){this.waveform=[];for(let e=0;e<30;e++)this.waveform.push(20*Math.random()+5)},formatTime(e){const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},async startWebRecording(){try{console.log("🌐 开始Web录音...");const e=await this.getAliyunSpeechConfig();this.currentSpeechConfig=e,(null==e?void 0:e.sampleRate)&&(this.pcmSampleRate=e.sampleRate);const t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,sampleRate:this.pcmSampleRate,channelCount:1}});this.mediaStream=t,await this.setupAliyunAudioProcessing(t);let i="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(i)||(i="audio/webm",MediaRecorder.isTypeSupported(i)||(i="audio/mp4",MediaRecorder.isTypeSupported(i)||(i=""))),this.mediaRecorder=new MediaRecorder(t,i?{mimeType:i}:{}),this.audioChunks=[],this.mediaRecorder.ondataavailable=e=>{e.data&&e.data.size>0&&(this.audioChunks.push(e.data),this.useAudioProcessorStreaming||this.processRealtimeAudioChunk(e.data))},this.mediaRecorder.onstop=()=>{if(console.log("✅ Web录音停止，数据块数量:",this.audioChunks.length),this.audioChunks.length>0){const e=new Blob(this.audioChunks,{type:this.mediaRecorder.mimeType||"audio/webm"});console.log("音频Blob大小:",e.size,"bytes"),this.handleRecordedBlob(e)}else console.error("❌ 没有录音数据"),o({title:"录音数据为空",icon:"error"})},this.mediaRecorder.onerror=e=>{console.error("❌ MediaRecorder错误:",e.error),o({title:"录音过程中出错",icon:"error"})},await this.startAliyunWebSocketRecognition(e),this.mediaRecorder.start(200),console.log("✅ Web录音开始成功, 状态:",this.mediaRecorder.state),this.allowAudioStreaming=!0,this.isRecording=!0,this.startRecordingTimer()}catch(e){console.error("❌ Web录音开始失败:",e);let t="无法访问麦克风";"NotAllowedError"===e.name?t="麦克风权限被拒绝":"NotFoundError"===e.name&&(t="未找到麦克风设备"),o({title:t,icon:"error"})}},async autoLogin(){var e;try{const t=await n({url:v("/auth/login"),method:"POST",header:{"Content-Type":"application/json"},data:{identifier:"demo",password:"demo123"}});if(null==(e=t.data)?void 0:e.success){const{token:e,user:o}=t.data.data;return c("token",e),c("user",o),!0}}catch(t){console.error("❌ 自动登录失败:",t)}return!1},async getAliyunSpeechConfig(){var e,t;try{let o=s("token");if(!o){console.log("🔐 用户未登录，尝试自动登录...");if(await this.autoLogin()&&(o=s("token")),!o)throw new Error("用户未登录，无法进行语音识别")}const i=await n({url:v("/aliyun-speech/token"),method:"GET",header:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});if(null==(e=i.data)?void 0:e.success){const e=i.data.data||{},t=e.region||e.regionId||"cn-shanghai",o=e.sampleRate||this.pcmSampleRate||16e3;return this.aliyunToken=e.token,this.aliyunAppKey=e.appKey,this.aliyunWsUrl=e.websocketUrl||`wss://nls-gateway-${t}.aliyuncs.com/ws/v1`,this.pcmSampleRate=o,{provider:"aliyun",token:e.token,appKey:e.appKey,websocketUrl:this.aliyunWsUrl,region:t,sampleRate:o}}throw new Error((null==(t=i.data)?void 0:t.message)||"获取语音识别Token失败")}catch(o){throw console.error("❌ 获取阿里云语音识别配置失败:",o),o}},async startAliyunWebSocketRecognition(e={}){try{const{token:o,appKey:i,websocketUrl:s,sampleRate:a=this.pcmSampleRate||16e3,region:r}=e;if(!o||!i||!s)throw new Error("阿里云语音识别配置不完整");this.currentSpeechConfig={...e,provider:"aliyun",sampleRate:a},this.aliyunToken=o,this.aliyunAppKey=i,this.aliyunWsUrl=s,this.pcmSampleRate=a;let n=s;if(n=n.includes("?")?`${n}&token=${encodeURIComponent(o)}`:`${n}?token=${encodeURIComponent(o)}`,this.websocket)try{this.websocket.close()}catch(t){console.warn("⚠️ 关闭旧的WebSocket失败:",t)}this.websocket=new WebSocket(n),this.websocket.binaryType="arraybuffer",this.aliyunTaskId=this.generateMessageId(),this.websocket.onopen=()=>{const e={header:{message_id:this.generateMessageId(),task_id:this.aliyunTaskId,namespace:"SpeechTranscriber",name:"StartTranscription",appkey:i},payload:{format:"pcm",sample_rate:Number(a)||16e3,enable_intermediate_result:!0,enable_punctuation_prediction:!0,enable_inverse_text_normalization:!0,disfluency:!0,max_sentence_silence:800}};try{this.websocket.send(JSON.stringify(e)),console.log("📤 已发送阿里云StartTranscription指令")}catch(t){console.error("❌ 发送Start指令失败:",t)}},this.websocket.onmessage=e=>{this.handleAliyunWebSocketMessage(e)},this.websocket.onclose=e=>{console.log("🔌 阿里云WebSocket关闭:",e.code,e.reason),this.allowAudioStreaming=!1},this.websocket.onerror=e=>{console.error("❌ 阿里云WebSocket错误:",e),this.allowAudioStreaming=!1}}catch(t){throw console.error("❌ 启动阿里云WebSocket识别失败:",t),t}},handleAliyunWebSocketMessage(e){try{if(!e||"string"!=typeof e.data)return;const t=JSON.parse(e.data),o=(null==t?void 0:t.header)||{},i=(null==t?void 0:t.payload)||{},s=o.name;switch(o.task_id&&(this.aliyunTaskId=o.task_id),s){case"TranscriptionStarted":console.log("🚀 阿里云识别已启动");break;case"TranscriptionResultChanged":{const e=(null==i?void 0:i.result)||(null==i?void 0:i.text);e&&this.applyRecognitionResult(e,!1);break}case"SentenceEnd":{const e=(null==i?void 0:i.result)||(null==i?void 0:i.text);e&&this.applyRecognitionResult(e,!0);break}case"TranscriptionCompleted":console.log("🏁 阿里云识别完成"),this.lastPartialText="";break;case"TaskFailed":{const e=(null==o?void 0:o.status_text)||(null==o?void 0:o.status_message)||"识别失败";console.error("❌ 阿里云识别失败:",e);break}default:s&&console.log("ℹ️ 阿里云事件:",s,i)}}catch(t){console.error("❌ 解析阿里云WebSocket消息失败:",t)}},applyRecognitionResult(e,t=!1){if(!e||!e.trim())return;const o=e.trim();let i=this.diaryContent||"";if(this.lastPartialText){const e=this.lastPartialText.trim();e&&i.endsWith(e)&&(i=i.slice(0,-e.length).trimEnd())}const s=i?`${i} ${o}`.replace(/\s+/g," ").trim():o;this.lastPartialText=t?"":o,this.diaryContent=s},sendAliyunStopRequest(){if(this.websocket&&this.websocket.readyState===WebSocket.OPEN)try{const e={header:{message_id:this.generateMessageId(),task_id:this.aliyunTaskId||this.generateMessageId(),namespace:"SpeechTranscriber",name:"StopTranscription",appkey:this.aliyunAppKey},payload:{}};this.websocket.send(JSON.stringify(e)),console.log("🛑 已发送阿里云StopTranscription指令")}catch(e){console.error("❌ 发送停止指令失败:",e)}},async setupAliyunAudioProcessing(e){try{const o=window.AudioContext||window.webkitAudioContext;if(!o)return console.warn("⚠️ AudioContext不可用，降级到MediaRecorder处理"),void(this.useAudioProcessorStreaming=!1);if(this.audioContext&&"closed"!==this.audioContext.state||(this.audioContext=new o({sampleRate:this.pcmSampleRate})),"suspended"===this.audioContext.state&&"function"==typeof this.audioContext.resume&&await this.audioContext.resume(),this.audioSourceNode)try{this.audioSourceNode.disconnect()}catch(t){console.warn("⚠️ 断开旧音频源失败:",t)}if(this.audioProcessor)try{this.audioProcessor.disconnect()}catch(t){console.warn("⚠️ 断开旧音频处理器失败:",t)}const i=this.audioContext.createMediaStreamSource(e),s=this.audioContext.createScriptProcessor(4096,1,1),a=this.audioContext.sampleRate,r=this.pcmSampleRate;s.onaudioprocess=e=>{var o;if(!this.allowAudioStreaming||!this.isRecording)return;const i=null==(o=e.inputBuffer)?void 0:o.getChannelData(0);if(!i||!i.length)return;const s=e.inputBuffer.sampleRate||a;let n=i;if(s!==r&&(n=this.downsampleBuffer(i,s,r)),!n||!n.length)return;const c=this.float32ToPCM(n);if(c&&c.byteLength&&this.websocket&&this.websocket.readyState===WebSocket.OPEN)try{this.websocket.send(c)}catch(t){console.error("❌ 发送音频数据失败:",t)}},i.connect(s),s.connect(this.audioContext.destination),this.audioSourceNode=i,this.audioProcessor=s,this.useAudioProcessorStreaming=!0}catch(t){console.error("❌ 初始化音频处理器失败:",t),this.useAudioProcessorStreaming=!1}},async processRealtimeAudioChunk(e){try{if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)return;const t=await this.convertWebMToPCM(e);t&&t.byteLength&&this.websocket.send(t)}catch(t){console.error("❌ 处理实时音频数据失败:",t)}},async convertWebMToPCM(e){try{const t=window.AudioContext||window.webkitAudioContext;if(!t)throw new Error("AudioContext 不可用");this.decodeAudioContext&&"closed"!==this.decodeAudioContext.state||(this.decodeAudioContext=new t);const o=await e.arrayBuffer(),i=await new Promise((e,t)=>{this.decodeAudioContext.decodeAudioData(o.slice(0),e,t)}),s=i.getChannelData(0),a=this.downsampleBuffer(s,i.sampleRate,this.pcmSampleRate);return this.float32ToPCM(a)}catch(t){return console.error("❌ WebM到PCM转换失败:",t),null}},downsampleBuffer(e,t,o){if(!e||t===o)return e;const i=t/o,s=Math.round(e.length/i),a=new Float32Array(s);for(let r=0;r<s;r++){const t=Math.floor(r*i);a[r]=e[t]}return a},float32ToPCM(e){if(!e)return new ArrayBuffer(0);const t=new ArrayBuffer(2*e.length),o=new DataView(t);for(let i=0;i<e.length;i++){const t=Math.max(-1,Math.min(1,e[i]));o.setInt16(2*i,t<0?32768*t:32767*t,!0)}return t},generateMessageId(){let e="";for(let t=0;t<32;t++)e+="0123456789abcdef"[Math.floor(16*Math.random())];return e},async handleRecordedBlob(e){try{const i=URL.createObjectURL(e);let s=null;try{s=await this.uploadWebAudio(e)}catch(t){console.warn("⚠️ 音频文件上传失败，使用本地URL:",t)}this.recordings.push({filePath:(null==s?void 0:s.fileUrl)||(null==s?void 0:s.filename)||i,duration:this.recordingTime,createTime:Date.now()}),this.recordingTime=0,o({title:"录制完成",icon:"success"})}catch(i){console.error("❌ 处理录音文件失败:",i)}},async uploadWebAudio(e){var t;try{const o=s("token");if(!o)throw new Error("用户未登录");let i=".webm";const a=e.type||"audio/webm";a.includes("webm")?i=".webm":a.includes("mp4")?i=".mp4":a.includes("wav")?i=".wav":a.includes("ogg")&&(i=".ogg");const r=`diary_recording_${Date.now()}${i}`,n=new File([e],r,{type:a}),c=new FormData;c.append("audio",n);const l=await fetch(v("/speech/upload"),{method:"POST",headers:{Authorization:`Bearer ${o}`},body:c});if(!l.ok){const e=await l.text();throw new Error(`上传失败: ${l.status} ${e}`)}const d=await l.json();if(d.success&&(null==(t=d.data)?void 0:t.file))return d.data.file;throw new Error(d.message||"上传失败")}catch(o){throw console.error("❌ 上传录音文件失败:",o),o}},stopWebRecording(){var e;try{if(console.log("🌐 停止Web录音..."),console.log("MediaRecorder状态:",null==(e=this.mediaRecorder)?void 0:e.state),this.allowAudioStreaming=!1,this.sendAliyunStopRequest(),this.mediaRecorder&&("recording"===this.mediaRecorder.state?(console.log("停止MediaRecorder..."),this.mediaRecorder.stop()):"paused"===this.mediaRecorder.state&&(this.mediaRecorder.resume(),this.mediaRecorder.stop())),this.mediaStream&&(console.log("停止媒体流..."),this.mediaStream.getTracks().forEach(e=>{e.stop()}),this.mediaStream=null),this.audioProcessor){try{this.audioProcessor.disconnect()}catch(t){console.warn("⚠️ 断开音频处理器失败:",t)}this.audioProcessor=null}if(this.audioSourceNode){try{this.audioSourceNode.disconnect()}catch(t){console.warn("⚠️ 断开音频源失败:",t)}this.audioSourceNode=null}if(this.audioContext){try{this.audioContext.close()}catch(t){console.warn("⚠️ 关闭音频上下文失败:",t)}this.audioContext=null}if(this.websocket){try{this.websocket.close()}catch(t){console.warn("⚠️ 关闭WebSocket失败:",t)}this.websocket=null}if(this.realtimeRecognitionTimer&&(clearInterval(this.realtimeRecognitionTimer),this.realtimeRecognitionTimer=null),this.speechRecognition&&(this.speechRecognition.stop(),this.speechRecognition=null),this.decodeAudioContext){try{this.decodeAudioContext.close()}catch(t){console.warn("⚠️ 关闭解码音频上下文失败:",t)}this.decodeAudioContext=null}this.audioChunks=[],this.isRecording=!1,this.stopRecordingTimer()}catch(t){console.error("❌ 停止Web录音失败:",t),o({title:"停止录音失败",icon:"error"})}},startWebSpeechRecognition(){const e=window.SpeechRecognition||window.webkitSpeechRecognition;this.speechRecognition=new e,this.speechRecognition.continuous=!0,this.speechRecognition.interimResults=!0,this.speechRecognition.lang="zh-CN",this.speechRecognition.onresult=e=>{let t="",o="";for(let i=e.resultIndex;i<e.results.length;i++){const s=e.results[i][0].transcript;e.results[i].isFinal?o+=s:t+=s}o?(console.log("✅ 最终识别结果:",o),this.diaryContent.trim()?this.diaryContent+=" "+o:this.diaryContent=o):t&&console.log("🎯 中间识别结果:",t)},this.speechRecognition.onerror=e=>{console.error("❌ Web Speech API错误:",e.error)},this.speechRecognition.onend=()=>{console.log("Web Speech API识别结束")},this.speechRecognition.start(),console.log("✅ Web Speech API开始识别")},async aiCompleteText(){var e;try{if(!this.diaryContent||0===this.diaryContent.trim().length)return void o({title:"请先输入内容",icon:"none"});this.isAiCompleting=!0,this.originalText=this.diaryContent,console.log("🤖 开始AI补全文本...");const t=s("token");if(!t)throw new Error("用户未登录");const i=await n({url:v("/ai/complete-text"),method:"POST",header:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},data:{text:this.diaryContent,chapterId:this.editChapterId,chapterTitle:this.diaryTitle||"随记"}});if(200!==i.statusCode||!i.data.success)throw new Error((null==(e=i.data)?void 0:e.message)||"AI补全失败");this.aiCompletedText=i.data.data.completedText,this.showAiDiff=!0,console.log("✅ AI补全成功")}catch(t){console.error("❌ AI补全失败:",t),o({title:t.message||"AI补全失败",icon:"error"})}finally{this.isAiCompleting=!1}},acceptAiCompletion(){this.diaryContent=this.aiCompletedText,this.showAiDiff=!1,this.originalText="",this.aiCompletedText="",o({title:"已应用AI补全",icon:"success"})},rejectAiCompletion(){this.showAiDiff=!1,this.originalText="",this.aiCompletedText="",o({title:"已取消AI补全",icon:"none"})},async uploadImageToServer(e){try{console.log("📤 开始上传图片:",e);const t=await fetch(e),o=await t.blob(),i=new FormData,a=`diary_image_${Date.now()}.jpg`,r=new Blob([o],{type:"image/jpeg"});i.append("image",r,a);const n=s("token");if(!n)throw new Error("用户未登录");const c=await fetch(v("/upload/image"),{method:"POST",headers:{Authorization:`Bearer ${n}`},body:i});if(!c.ok)throw new Error(`上传失败: ${c.status}`);const l=await c.json();return console.log("✅ 图片上传成功:",l),l.data.url||l.url}catch(t){throw console.error("❌ 图片上传失败:",t),t}},async saveDiary(){var e,t,d;if(this.viewMode&&(this.viewMode=!1,this.editMode=!0),this.diaryTitle.trim())if(this.diaryContent.trim()||this.selectedImage||0!==this.recordings.length){i({title:"保存中..."});try{const i=s("token");if(console.log("🔑 用户token:",i?"已获取":"未找到"),!i)return a(),o({title:"请先登录",icon:"error"}),void setTimeout(()=>{r({url:"/pages/login/index"})},1500);let u;this.editMode?this.editChapterId.startsWith("sample_")?(u="diary_"+Date.now(),console.log("📝 样板案例保存为新随记，生成新ID:",u)):(u=this.editChapterId,console.log("📝 编辑现有随记，使用原ID:",u)):(u="diary_"+Date.now(),console.log("📝 新建随记，生成新ID:",u));let g="/src/images/default-diary.svg";if(this.selectedImage)try{g=this.selectedImage.startsWith("blob:")?await this.uploadImageToServer(this.selectedImage):this.selectedImage}catch(h){console.error("图片上传失败:",h),g="/src/images/default-diary.svg"}const m={chapterId:u,title:this.diaryTitle.trim(),content:this.diaryContent.trim(),recordings:this.recordings,backgroundImage:g};console.log("📤 发送章节数据:",m);const p=await n({url:v("/chapters/save"),method:"POST",header:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},data:m});if(a(),console.log("📊 保存响应:",p),console.log("📊 响应状态码:",p.statusCode),console.log("📊 响应数据:",p.data),p.data&&p.data.errors&&(console.log("❌ 验证错误详情:",p.data.errors),p.data.errors.forEach((e,t)=>{console.log(`❌ 错误 ${t+1}:`,e)})),200!==p.statusCode||!p.data.success){console.error("❌ 保存失败详情:",p.data);const o=(null==(e=p.data)?void 0:e.message)||`保存失败 (${p.statusCode})`,i=(null==(t=p.data)?void 0:t.details)||(null==(d=p.data)?void 0:d.error)||"";throw new Error(`${o}${i?": "+i:""}`)}{const e={id:u,title:this.diaryTitle.trim(),description:"自定义随记章节",backgroundImage:this.selectedImage||"/src/images/story1.png",completed:!0,isCustom:!0,content:this.diaryContent.trim(),recordings:this.recordings,createTime:Date.now(),lastModified:(new Date).toISOString()},t=s("user"),i=null==t?void 0:t.id;if(i){c(`chapter_${u}_${i}`,JSON.stringify({text:this.diaryContent.trim(),recordings:this.recordings,lastModified:(new Date).toISOString(),completed:!0}));const t=s(`chapter_status_${i}`)||"{}",o=JSON.parse(t);o[u]={completed:!0,lastModified:(new Date).toISOString()},c(`chapter_status_${i}`,JSON.stringify(o));const a=s(`custom_chapters_${i}`)||[];a.unshift(e),c(`custom_chapters_${i}`,a)}o({title:"保存成功",icon:"success"}),setTimeout(()=>{l()},1500)}}catch(h){if(a(),console.error("保存随记失败:",h),h.errMsg&&h.errMsg.includes("network"))try{const e=this.editMode?this.editChapterId:"diary_"+Date.now(),t={id:e,title:this.diaryTitle.trim(),description:"自定义随记章节",backgroundImage:this.selectedImage||"/src/images/story1.png",completed:!0,isCustom:!0,content:this.diaryContent.trim(),recordings:this.recordings,createTime:Date.now(),lastModified:(new Date).toISOString(),needSync:!0},i=s("user"),a=null==i?void 0:i.id;if(a){c(`chapter_${e}_${a}`,JSON.stringify({text:this.diaryContent.trim(),recordings:this.recordings,lastModified:(new Date).toISOString(),completed:!0,needSync:!0}));const o=s(`custom_chapters_${a}`)||[];o.unshift(t),c(`custom_chapters_${a}`,o)}o({title:"已离线保存",icon:"success"}),setTimeout(()=>{l()},1500)}catch(u){o({title:"保存失败",icon:"error"})}else o({title:h.message||"保存失败",icon:"error"})}}else o({title:"请添加内容、图片或录音",icon:"none"});else o({title:"请输入随记标题",icon:"none"})}}},[["render",function(o,i,s,a,r,n){const c=p,l=u,d=w,h=k,v=b;return g(),e(l,{class:"container"},{default:t(()=>[m(l,{class:"nav-header"},{default:t(()=>[m(l,{class:"back-btn",onClick:n.goBack},{default:t(()=>[m(c,{class:"back-icon"},{default:t(()=>[f("←")]),_:1})]),_:1},8,["onClick"]),m(l,{class:"nav-title"},{default:t(()=>[f(y(r.viewMode?"查看随记":r.editMode?"编辑随记":"新随记"),1)]),_:1}),m(l,{class:"save-btn",onClick:n.saveDiary},{default:t(()=>[m(c,{class:"save-text"},{default:t(()=>[f("保存")]),_:1})]),_:1},8,["onClick"])]),_:1}),m(l,{class:"content"},{default:t(()=>[m(l,{class:"title-section"},{default:t(()=>[m(d,{class:"title-input",placeholder:"随记标题",modelValue:r.diaryTitle,"onUpdate:modelValue":i[0]||(i[0]=e=>r.diaryTitle=e),maxlength:"50"},null,8,["modelValue"])]),_:1}),m(l,{class:"photo-section"},{default:t(()=>[r.selectedImage?C("",!0):(g(),e(l,{key:0,class:"photo-upload",onClick:n.chooseImage},{default:t(()=>[m(l,{class:"upload-icon"},{default:t(()=>[m(h,{src:$,class:"camera-icon",mode:"aspectFit"})]),_:1}),m(c,{class:"upload-text"},{default:t(()=>[f("上传图片 记录美好瞬间")]),_:1})]),_:1},8,["onClick"])),r.selectedImage?(g(),e(l,{key:1,class:"photo-preview"},{default:t(()=>[m(h,{src:r.selectedImage.startsWith("http")?r.selectedImage:n.getOptimalImagePath(r.selectedImage),class:"preview-image",mode:"aspectFill"},null,8,["src"]),m(l,{class:"photo-overlay"},{default:t(()=>[m(l,{class:"photo-actions"},{default:t(()=>[m(l,{class:"action-btn",onClick:n.chooseImage},{default:t(()=>[m(h,{src:$,class:"action-camera-icon",mode:"aspectFit"})]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})):C("",!0)]),_:1}),m(l,{class:"text-section"},{default:t(()=>[m(v,{class:"content-textarea",placeholder:"记录您现在想到的事情...",modelValue:r.diaryContent,"onUpdate:modelValue":i[1]||(i[1]=e=>r.diaryContent=e),maxlength:"2000","auto-height":""},null,8,["modelValue"])]),_:1}),m(l,{class:"recording-section"},{default:t(()=>[r.isRecording||r.recordings.length>0?(g(),e(l,{key:0,class:"recording-timer"},{default:t(()=>[m(c,{class:"timer-text"},{default:t(()=>[f(y(n.formatTime(r.recordingTime)),1)]),_:1}),m(c,{class:"timer-limit"},{default:t(()=>[f("最多可录制10分钟")]),_:1})]),_:1})):C("",!0),r.isRecording?(g(),e(l,{key:1,class:"recording-wave"},{default:t(()=>[(g(!0),R(T,null,S(r.waveform,(t,o)=>(g(),e(l,{class:"wave-bar",key:o,style:I({height:t+"px"})},null,8,["style"]))),128))]),_:1})):C("",!0),m(l,{class:"recording-controls"},{default:t(()=>[m(l,{class:"control-buttons"},{default:t(()=>[m(l,{class:"record-btn-container"},{default:t(()=>[m(l,{class:_(["record-btn",{recording:r.isRecording}]),onClick:n.toggleRecording},{default:t(()=>[m(l,{class:"record-icon"},{default:t(()=>[r.isRecording?(g(),e(l,{key:0,class:"recording-animation"},{default:t(()=>[(g(),R(T,null,S(3,e=>m(l,{class:"wave",key:e})),64))]),_:1})):(g(),e(h,{key:1,src:x,class:"mic-icon",mode:"aspectFit"}))]),_:1})]),_:1},8,["onClick","class"]),m(c,{class:"record-text"},{default:t(()=>[f(y(r.isRecording?"结束录制":"点击录制"),1)]),_:1})]),_:1}),m(l,{class:"ai-complete-btn-container"},{default:t(()=>[m(l,{class:_(["ai-complete-btn",{loading:r.isAiCompleting}]),onClick:n.aiCompleteText},{default:t(()=>[r.isAiCompleting?(g(),e(l,{key:1,class:"ai-loading"},{default:t(()=>[(g(),R(T,null,S(3,e=>m(l,{class:"loading-dot",key:e})),64))]),_:1})):(g(),e(l,{key:0,class:"ai-icon"},{default:t(()=>[m(h,{src:M,class:"ai-icon-img",mode:"aspectFit"})]),_:1}))]),_:1},8,["onClick","class"]),m(c,{class:"ai-complete-text"},{default:t(()=>[f("AI补全")]),_:1})]),_:1})]),_:1})]),_:1}),r.showAiDiff?(g(),e(l,{key:2,class:"ai-complete-result"},{default:t(()=>[m(l,{class:"diff-header"},{default:t(()=>[m(c,{class:"diff-title"},{default:t(()=>[f("AI补全结果")]),_:1}),m(c,{class:"diff-subtitle"},{default:t(()=>[f("请选择是否接受AI的修改")]),_:1})]),_:1}),m(l,{class:"diff-content"},{default:t(()=>[m(l,{class:"diff-ai"},{default:t(()=>[m(l,{class:"diff-label"},{default:t(()=>[f("AI补全结果")]),_:1}),m(l,{class:"diff-text ai-text"},{default:t(()=>[f(y(r.aiCompletedText),1)]),_:1})]),_:1})]),_:1}),m(l,{class:"diff-actions"},{default:t(()=>[m(l,{class:"diff-btn reject-btn",onClick:n.rejectAiCompletion},{default:t(()=>[m(h,{src:P,class:"btn-icon",mode:"aspectFit"})]),_:1},8,["onClick"]),m(l,{class:"diff-btn accept-btn",onClick:n.acceptAiCompletion},{default:t(()=>[m(h,{src:W,class:"btn-icon",mode:"aspectFit"})]),_:1},8,["onClick"])]),_:1})]),_:1})):C("",!0)]),_:1})]),_:1})]),_:1})}],["__scopeId","data-v-eca466c6"]]);export{E as default};
